---
title: "Uganda Disaster Analysis"
format: html
editor: visual
---

# Environment Setup

```{r setup}
library(tidyverse)
library(tidyterra)
library(readxl)
library(sf)
library(patchwork)
library(paletteer)
library(ggtext)
library(scales)

# Set random seed
nb_name <- "Agile 2025 - Build climate & Violence dataset for Uganda"
seed <- sum(sapply(str_split(nb_name, pattern = "", simplify = TRUE), FUN = utf8ToInt))

# Folder structure
root <- rprojroot::has_file("agile2025.Rproj")$make_fix_file()
raw_data_dir <- root("data/raw")
proc_data_dir <- root("data/processed")
output_data_dir <- root("data/processed/uganda")
dir.create(proc_data_dir, showWarnings = FALSE)
fig_dir <- root("figures")
dir.create(fig_dir, showWarnings = FALSE)
video_dir <- root("videos")
dir.create(video_dir, showWarnings = FALSE)

# Viz settings
col_palette <- c("#dc7726", "#eebb93", "#ecc046", "#f6e0a3", "#0292b7", "#81c9db", "#97DECE", "#35A29F")
label_map <- c(
  value_maln_cases_3m_per_1000 = "Maln., 3 months",
  dev_value_maln_cases_3m_per_1000 = "Dev. Maln., 3 months",
  value_num_rainfall_anomalies_6m_lag8 = "Rain, 6 months, lag 8",
  value_num_rainfall_anomalies_3m_lag4 = "Rain, 3 months, lag 4",
  value_num_spei_anomalies_6m = "SPEI, 6 months",
  value_num_spei_anomalies_6m_lag11 = "SPEI, 6 months, lag 11",
  value_num_spei_anomalies_6m_lag12 = "SPEI, 6 months, lag 12",
  dev_value_num_spei_anomalies_6m_lag12 = "Dev. SPEI, 6 months, lag 12",
  dev_value_num_spei_anomalies_3m_lag3 = "Dev. SPEI, 4 months, lag 3",
  dev_value_num_spei_anomalies_12m_lag10 = "Dev. SPEI, 12 months, lag 10",
  dev_value_num_spei_anomalies_6m_lag12 = "Dev. SPEI, 6 months, lag 12",
  value_num_utci_anomalies_3m_lag4 = "UTCI, 3 months, lag 4",
  value_num_utci_anomalies_6m_lag4 = "UTCI, 6 months, lag 4",
  value_num_utci_anomalies_3m_lag5 = "UTCI, 3 months, lag 5",
  dev_value_num_utci_anomalies_6m_lag4 = "Dev. UTCI, 6 months, lag 4",
  dev_value_num_utci_anomalies_6m_lag10 = "Dev. UTCI, 6 months, lag 10"
)
```

# Functions

```{r}
clean_column_name <- function(cols) {
  cols <- tolower(cols)
  cols <- gsub("[.:,'()-/?]", "", cols)
  cols <- str_squish(cols)
  for (i in 1:length(cols)) {
    cols[i] <- paste0(unlist(strsplit(cols[i], " ")), collapse = "_")
  }
  cols
}

load_dhis_viol_data <- function(filename) {
  filepath <- file.path(raw_data_dir, "Uganda", "DHIS2", filename)
  sheet_names <- excel_sheets(filepath)
  dfs <- list()
  for (i in 1:length(sheet_names)) {
    dhis_raw <- read_xlsx(
      file.path(raw_data_dir, "Uganda", "DHIS2", filename),
      sheet = sheet_names[i],
      col_names = FALSE,
      .name_repair = "unique_quiet"
    )
    headers <- as_tibble(t(zoo::na.locf(t(dhis_raw[1:4, 1:(dim(dhis_raw)[2] -1)]))))
    combined_names <- apply(headers, 2, function(x) paste(x, collapse = "_"))
  
    df_dhis <- (
      read_xlsx(
        file.path(raw_data_dir, "Uganda", "DHIS2", filename),
        sheet = sheet_names[i],
        skip = 5,
        col_names = FALSE,
        .name_repair = "unique_quiet"
      )
      %>% select(-last_col())
      %>% head(-1)
    )
    colnames(df_dhis) <- combined_names
  
    dfs[[i]] <- (
      df_dhis
      %>% rename(
        district = 1
      )
      %>% pivot_longer(
        cols = -district,
        names_to = c("variable", "month", "sex", "age_bracket"),
        names_sep = "_",
        values_to = "cases"
      )
      %>% mutate(
        year = sheet_names[i],
        sex = if_else(
          variable == "Abortions due to Gender-Based Violence",
          "Female",
          sex
        )
      )
    )
  }
  (
    bind_rows(dfs)
    %>% mutate(
      district = str_squish(str_remove_all(district, "District")),
      date = lubridate::ceiling_date(
        as.Date(paste(year, month, "01", sep="-"), "%Y-%B-%d"),
        "month"
      ) - lubridate::days(1),
      cases = replace_na(cases, 0)
    )
    %>% mutate(
      district = case_when(
        district == "Madi-Okollo" ~ "Madi Okollo",
        district == "Sembabule" ~ "Ssembabule",
        .default = district
      )
    )
    # %>% group_by(district, date, variable, sex, age_bracket)
    # %>% summarise(
    #   cases = sum(cases, na.rm = TRUE),
    #   .groups = "drop"
    # )
    %>% select(-c("month", "year"))
    %>% arrange(district, date, variable, sex, age_bracket)
  )
}

load_dhis_maln_data <- function(filename) {
  filepath <- file.path(raw_data_dir, "Uganda", "DHIS2", filename)
  sheet_names <- excel_sheets(filepath)
  dfs <- list()
  for (i in 1:length(sheet_names)) {
    dhis_raw <- read_xlsx(
      file.path(raw_data_dir, "Uganda", "DHIS2", filename),
      sheet = sheet_names[i],
      col_names = FALSE,
      .name_repair = "unique_quiet"
    )
    headers <- as_tibble(t(zoo::na.locf(t(dhis_raw[1:2, 1:(dim(dhis_raw)[2] -1)]))))
    combined_names <- apply(headers, 2, function(x) paste(x, collapse = "_"))
  
    df_dhis <- (
      read_xlsx(
        file.path(raw_data_dir, "Uganda", "DHIS2", filename),
        sheet = sheet_names[i],
        skip = 2,
        col_names = FALSE,
        .name_repair = "unique_quiet"
      )
      %>% select(-last_col())
    )
    colnames(df_dhis) <- combined_names
  
    dfs[[i]] <- (
      df_dhis
      %>% rename(
        district = "Data element_District/Month"
      )
      %>% pivot_longer(
        cols = -district,
        names_to = c("variable", "month"),
        names_sep = "_",
        values_to = "cases"
      )
      %>% mutate(
        year = sheet_names[i],
        # sex = if_else(
        #   variable == "Abortions due to Gender-Based Violence",
        #   "Female",
        #   sex
        # )
      )
    )
  }
  (
    bind_rows(dfs)
    %>% mutate(
      district = str_squish(str_remove_all(district, "District")),
      date = lubridate::ceiling_date(
        as.Date(paste(year, month, "01", sep="-"), "%Y-%B-%d"),
        "month"
      ) - lubridate::days(1),
      cases = replace_na(cases, 0)
    )
    %>% mutate(
      district = case_when(
        district == "Madi-Okollo" ~ "Madi Okollo",
        district == "Sembabule" ~ "Ssembabule",
        .default = district
      )
    )
    %>% arrange(district, date, variable)
  )
}

get_corrs_single_var <- function(data, var, level = "district") {
  areas <- unique(data[[level]])
  n_areas <- length(areas)
  corrs <- list()
  for (i in 1:n_areas) {
    df_corr <- (
      data
      %>% filter(!!sym(level) == areas[i])
      %>% select(
        where(is.numeric) 
      )
      %>% na.omit()
      %>% as.matrix()
      %>% cor()
      %>% as.data.frame()
      %>% rownames_to_column("var1")
      %>% pivot_longer(
        cols = -var1,
        names_to = "var2",
        values_to = "correlation"
      )
      %>% filter(
        (var1 != var2)
        & (var2 == var)
      )
      %>% filter(
        case_when(
          str_detect(var, "maln") ~ !(str_detect(var1, "maln")),
          str_detect(var, "viol") ~ !(str_detect(var1, "viol")),
          TRUE ~ TRUE
        )
      )
      %>% mutate(
        !!sym(level) := areas[[i]]
      )
      %>% select(
        !!sym(level),
        variate = var2,
        covariate = var1,
        correlation
      )
    )
    corrs[[i]] <- df_corr
  }
  df_corrs <- (
    bind_rows(corrs)
    %>% arrange(!!sym(level), desc(correlation))
  )
  df_corrs
}

get_mean_corr_single_var <- function(data, var, level) {
  df_corrs <- get_corrs_single_var(data, var, level)
  (
    df_corrs
    %>% group_by(variate, covariate)
    %>% summarise(
      median_corr = median(correlation, na.rm = TRUE),
      mean_corr = mean(correlation, na.rm = TRUE),
      sd_corr = sd(correlation, na.rm = TRUE),
      min_corr = min(correlation, na.rm = TRUE),
      max_corr = max(correlation, na.rm = TRUE),
      .groups = "drop"
    )
    %>% mutate(
      range_var = as.numeric(str_extract(variate, "(\\d+)(?=m)")),
      range_covar = as.numeric(str_extract(covariate, "(\\d+)(?=m)"))
    )
    %>% filter(
      case_when(
        is.na(range_var) ~ TRUE,
        is.na(range_covar) & !is.na(range_var) ~ FALSE,
        !is.na(range_covar) & !is.na(range_var) & (range_var > range_covar) ~ FALSE,
        TRUE ~ TRUE
      )
    )
    %>% select(-c(range_covar, range_var))
    %>% arrange(desc(min_corr))
  )
}

get_mean_corrs_multi_var <- function(data, vars, level) {
  
  mean_corrs_list <- list()
  for (i in seq_len(length(vars))) {
    mean_corrs_list[[i]] <- get_mean_corr_single_var(data, vars[i], level)
  }
  (
    bind_rows(mean_corrs_list)
    %>% arrange(desc(min_corr))
  )
}
```

# Parameters

```{r params}
# west_nile_region <- c(
#   "Adjumani",
#   "Madi Okollo",
#   "Zombo"
# )
# 
# regions_with_operations <- c(
#   "Mayuge",
#   "Budaka",
#   "Nakapiripiti",
#   "Tororo",
#   "Bulambuli",
#   "Soroti",
#   "Lira",
#   "Napak",
#   "Kamuli",
#   "Kayunga",
#   "Luuka",
#   "Sironko"
# )
# 
# elgon_region <- c(
#   "Bududa",
#   "Bukedea",
#   "Bukwo",
#   "Bulambuli",
#   "Butaleja",
#   "Kapchorwa",
#   "Kween",
#   "Manafwa",
#   "Mbale", 
#   "Namisindwa",
#   "Sironko", 
#   "Tororo"
# )
# 
# karamoja_region <- c(
#   "Abim",
#   "Amudat",
#   "Kaabong", 
#   "Karenga",
#   "Kotido", 
#   "Moroto",
#   "Nabilatuk",
#   "Nakapiripirit",
#   "Napak"
# )
# 
# rwenzori_region <- c(
#   "Bundibugyo",
#   "Bunyangabu",
#   "Kasese"
# )
# 
# teso_region <- c(
#   "Amuria",
#   "Kapelebyong",
#   "Katakwi",
#   "Kumi",
#   "Bukedea",
#   "Butebo",
#   "Budaka"
# )
west_nile_region <- c(
  "Arua City",
  "Koboko",
  "Yumbe",
  "Moyo",
  "Obongi",
  "Maracha",
  "Arua",
  "Adjumani",
  "Madi Okollo",
  "Zombo",
  "Nebbi",
  "Pakwach",
  "Terego"
)
acholi_region <- c(
  "Amuru",
  "Nwoya",
  "Gulu",
  "Gulu City",
  "Omoro",
  "Lamwo",
  "Pader",
  "Kitgum",
  "Pader",
  "Agago"
)
karamoja_region <- c(
  "Abim",
  "Amudat",
  "Kaabong", 
  "Karenga",
  "Kotido", 
  "Moroto",
  "Nabilatuk",
  "Nakapiripirit",
  "Napak"
)
elgon_region <- c(
  "Bududa",
  "Bukwo",
  "Bulambuli",
  "Butaleja",
  "Kapchorwa",
  "Kween",
  "Manafwa",
  "Mbale", 
  "Mbale City",
  "Namisindwa",
  "Sironko", 
  "Tororo"
)
teso_region <- c(
  "Bukedea",
  "Butebo",
  "Budaka",
  "Kibuku",
  "Pallisa",
  "Kumi",
  "Ngora",
  "Katakwi",
  "Kapelebyong",
  "Amuria",
  "Kalaki",
  "Soroti",
  "Soroti City",
  "Serere",
  "Kaberamaido"
)
lango_region <- c(
  "Otuke",
  "Alebtong",
  "Lira",
  "Oyam",
  "Kole",
  "Dokolo",
  "Kwania",
  "Apac",
  "Amolatar",
  "Lira City"
)
western_region <- c(
  "Buliisa",
  "Masindi",
  "Kiryandongo",
  "Hoima",
  "Kikuube",
  "Kagadi",
  "Kakumiro",
  "Kibaale",
  "Ntoroko",
  "Kyegegwa",
  "Kyenjojo",
  "Kabarole",
  "Bundibugyo",
  "Bunyangabu",
  "Kamwenge",
  "Kasese",
  "Kitagwenda",
  "Fort Portal City",
  "Hoima City"
)
south_wester_region <- c(
  "Kazo",
  "Ibanda",
  "Rubirizi",
  "Buhweju",
  "Bushenyi",
  "Rukungiri",
  "Sheema", 
  "Mbarara",
  "Mbarara City",
  "Kiruhura",
  "Mitooma",
  "Rwampara",
  "Kanungu",
  "Ntungamo",
  "Isingiro",
  "Rubanda",
  "Rukiga",
  "Kisoro",
  "Kabale"
)
central_region <- c(
  "Nakasongola",
  "Kyankwanzi",
  "Nakaseke",
  "Luwero",
  "Kayunga",
  "Kiboga",
  "Kassanda",
  "Mubende",
  "Mityana",
  "Butambala", 
  "Kampala", 
  "Mukono",
  "Buikwe",
  "Gomba",
  "Ssembabule",
  "Kalungu",
  "Mpigi",
  "Wakiso",
  "Lyantonde",
  "Bukomansimbi",
  "Lwengo", 
  "Masaka",
  "Masaka City",
  "Rakai",
  "Kyotera", 
  "Kalangala", 
  "Buvuma"
)
east_central_region <- c(
  "Buyende",
  "Kamuli",
  "Kaliro",
  "Namutumba",
  "Luuka",
  "Jinja", 
  "Jinja City",
  "Iganga",
  "Bugweri",
  "Bugiri",
  "Mayuge",
  "Busia",
  "Namayingo"
)
```

# Load data

## Geometries

From data sent by Herbert

```{r load_data geom}
# Sys.setenv(SHAPE_RESTORE_SHX='YES')
sf_uga <- (
  st_read(
    file.path(
      raw_data_dir,
      "geographies",
      "uganda_herbert",
      "uganda_districts.shp"
    ),
  )
  %>% rename_with(tolower)
  %>% mutate(
    district = case_match(
      district,
      # "SSEMBABULE" ~ "Sembabule",
      "KASSNDA" ~ "Kassanda",
      # "MADI OKOLLO" ~ "Madi-Okollo",
      "NAMUTUNMBA" ~ "Namutumba",
      .default = str_to_title(district)
    ),
    district_area = shape_area / 1000
  )
  %>% select(
    district_code = objectid,
    district,
    district_area
  )
  %>% st_transform(4326)
)
```

## Population

### All Population

```{r}
rast_pop <- (
  terra::rast(
    file.path(raw_data_dir, "population", "uga_pop_2024_CN_1km_R2025A_UA_v1.tif")
  )
  %>% rename(
    pop = global_pop_2024_CN_1km_R2025A_v1
  )
)
```

```{r}
df_pop <- (
  rast_pop
  %>% exactextractr::exact_extract(
    sf_uga,
    fun = function(values, coverage_fraction) sum(values * coverage_fraction, na.rm = TRUE),
    max_cells_in_memory = 176067000,
    append_cols = c("district_code", "district")
  )
  %>% rename(
    pop = result
  )
  %>% mutate(
    region = case_when(
      district %in% acholi_region ~ "Acholi",
      district %in% central_region ~ "Central",
      district %in% east_central_region ~ "East Central",
      district %in% elgon_region ~ "Elgon",
      district %in% karamoja_region ~ "Karamoja",
      district %in% lango_region ~ "Lango",
      district %in% south_wester_region ~ "South Western",
      district %in% teso_region ~ "Teso",
      district %in% west_nile_region ~ "West Nile",
      district %in% western_region ~ "Western",
      # .default = "Other regions"
    )
  )
)
```

## Malnutrition

```{r}
df_maln <- (
  load_dhis_maln_data("Nutrition_Data.xlsx")
  %>% mutate(
    region = case_when(
      district %in% acholi_region ~ "Acholi",
      district %in% central_region ~ "Central",
      district %in% east_central_region ~ "East Central",
      district %in% elgon_region ~ "Elgon",
      district %in% karamoja_region ~ "Karamoja",
      district %in% lango_region ~ "Lango",
      district %in% south_wester_region ~ "South Western",
      district %in% teso_region ~ "Teso",
      district %in% west_nile_region ~ "West Nile",
      district %in% western_region ~ "Western",
      # .default = "Other regions"
    )
  )
)
```

## Population weighted UTCI

```{r}
df_utci <- (
  read_csv(
    file.path(
      proc_data_dir,
      "UTCI",
      "weighted_utci_max_daily_all_countries.csv"
    ),
    show_col_types = FALSE
  )
  %>% filter(
    country == "Uganda"
  )
  %>% group_by(
    district_code = adm_code,
    district = adm_name,
    date = lubridate::ceiling_date(date, "month") - lubridate::days(1)
  )
  %>% summarise(
    num_utci_anomalies = sum(utci_max > 36, na.rm = TRUE),
    .groups = "drop"
  )
  %>% mutate(
    district = case_when(
      district == "Kassnda" ~ "Kassanda",
      district == "Sembabule" ~ "Ssembabule",
      district == "Namutunmba" ~ "Namutumba",
      .default = district
    ),
    region = case_when(
      district %in% acholi_region ~ "Acholi",
      district %in% central_region ~ "Central",
      district %in% east_central_region ~ "East Central",
      district %in% elgon_region ~ "Elgon",
      district %in% karamoja_region ~ "Karamoja",
      district %in% lango_region ~ "Lango",
      district %in% south_wester_region ~ "South Western",
      district %in% teso_region ~ "Teso",
      district %in% west_nile_region ~ "West Nile",
      district %in% western_region ~ "Western",
      # .default = "Other regions"
    )
  )
)
```

## Population weighted SPEI

```{r}
df_spei <- (
  read_csv(
    file.path(
      proc_data_dir,
      "SPEI",
      "weighted_spei_all_countries.csv"
    ),
    show_col_types = FALSE
  )
  %>% filter(
    country == "Uganda"
  )
  %>% mutate(
    date = lubridate::ceiling_date(date, "month") - lubridate::days(1),
    num_spei_anomalies = as.numeric(spei < -1)
  )
  %>% rename(
    district_code = adm_code,
    district = adm_name,
  )
  %>% select(-c(country, pop, spei))
  %>% mutate(
    district = case_when(
      district == "Kassnda" ~ "Kassanda",
      district == "Sembabule" ~ "Ssembabule",
      district == "Namutunmba" ~ "Namutumba",
      .default = district
    ),
    region = case_when(
      district %in% acholi_region ~ "Acholi",
      district %in% central_region ~ "Central",
      district %in% east_central_region ~ "East Central",
      district %in% elgon_region ~ "Elgon",
      district %in% karamoja_region ~ "Karamoja",
      district %in% lango_region ~ "Lango",
      district %in% south_wester_region ~ "South Western",
      district %in% teso_region ~ "Teso",
      district %in% west_nile_region ~ "West Nile",
      district %in% western_region ~ "Western",
      # .default = "Other regions"
    )
  )
)
```

## Population weighted rainfall

```{r}
df_rain <- (
  read_csv(
    file.path(
      proc_data_dir,
      "rainfall",
      "weighted_rain_all_countries.csv"
    ),
    show_col_types = FALSE
  )
  %>% filter(
    country == "Uganda"
  )
  %>% group_by(
    district = adm_name,
    month = lubridate::month(date)
  )
  %>% mutate(
    mean_month_rainfall = mean(rainfall, na.rm = TRUE),
    sd_month_rainfall = sd(rainfall, na.rm = TRUE)
  )
  %>% ungroup()
  %>% group_by(
    district_code = adm_code,
    district,
    date = lubridate::ceiling_date(date, "month") - lubridate::days(1)
  )
  %>% summarise(
    num_rainfall_anomalies = sum(rainfall > mean_month_rainfall + 2 * sd_month_rainfall, na.rm = TRUE),
    .groups = "drop"
  )
  %>% mutate(
    district = case_when(
      district == "Kassnda" ~ "Kassanda",
      district == "Sembabule" ~ "Ssembabule",
      district == "Namutunmba" ~ "Namutumba",
      .default = district
    ),
    region = case_when(
      district %in% acholi_region ~ "Acholi",
      district %in% central_region ~ "Central",
      district %in% east_central_region ~ "East Central",
      district %in% elgon_region ~ "Elgon",
      district %in% karamoja_region ~ "Karamoja",
      district %in% lango_region ~ "Lango",
      district %in% south_wester_region ~ "South Western",
      district %in% teso_region ~ "Teso",
      district %in% west_nile_region ~ "West Nile",
      district %in% western_region ~ "Western",
      # .default = "Other regions"
    )
  )
)
```

## Violence

```{r}
df_viol <- (
  load_dhis_viol_data("DHIS2_GBV_Data.xlsx")
  %>% mutate(
    region = case_when(
      district %in% acholi_region ~ "Acholi",
      district %in% central_region ~ "Central",
      district %in% east_central_region ~ "East Central",
      district %in% elgon_region ~ "Elgon",
      district %in% karamoja_region ~ "Karamoja",
      district %in% lango_region ~ "Lango",
      district %in% south_wester_region ~ "South Western",
      district %in% teso_region ~ "Teso",
      district %in% west_nile_region ~ "West Nile",
      district %in% western_region ~ "Western",
      # .default = "Other regions"
    )
  )
)
```

# Data processing

## Population

```{r}
df_pop_reg <- (
  df_pop
  %>% group_by(region)
  %>% summarise(
    pop = sum(pop, na.rm = TRUE)
  )
)
```

## Malnutrition

```{r}
df_maln_distr <- (
  df_maln
  %>% filter(
    variable != "Clients with SAM admitted into treatment - Died during treatment",
    date < "2025-01-01"
  )
  %>% group_by(
    region,
    district,
    date
  )
  %>% summarise(
    maln_cases = sum(cases, na.rm = TRUE),
    .groups = "drop"
  )
)
```

```{r}
df_maln_reg <- (
  df_maln
  %>% filter(
    variable != "Clients with SAM admitted into treatment - Died during treatment",
    date < "2025-01-01"
  )
  %>% group_by(
    region,
    date
  )
  %>% summarise(
    maln_cases = sum(cases, na.rm = TRUE),
    .groups = "drop"
  )
)
```

## Violence

```{r}
df_viol_distr <- (
  df_viol
  %>% filter(
    variable == "Injuries due to Gender based violence"
  )
  %>% group_by(
    region,
    district, 
    date
  )
  %>% summarise(
    viol_cases = sum(cases, na.rm = TRUE),
    .groups = "drop"
  )
)
```

```{r}
df_viol_reg <- (
  df_viol
  %>% filter(
    variable == "Injuries due to Gender based violence"
  )
  %>% group_by(
    region, 
    date
  )
  %>% summarise(
    viol_cases = sum(cases, na.rm = TRUE),
    .groups = "drop"
  )
)
```

## UTCI

```{r}
df_utci_reg <- (
  df_utci
  %>% group_by(region, date)
  %>% summarise(
    num_utci_anomalies = mean(num_utci_anomalies, na.rm = TRUE),
    .groups = "drop"
  )
)
```

## SPEI

```{r}
df_spei_reg <- (
  df_spei
  %>% group_by(region, date)
  %>% summarise(
    num_spei_anomalies = mean(num_spei_anomalies, na.rm = TRUE),
    .groups = "drop"
  )
)
```

## Rainfall

```{r}
df_rain_reg <- (
  df_rain
  %>% group_by(region, date)
  %>% summarise(
    num_rainfall_anomalies = mean(num_rainfall_anomalies, na.rm = TRUE),
    .groups = "drop"
  )
)
```

## Combine malnutrition and violence

```{r}
df_health_distr <- (
  df_maln_distr
  %>% merge(
    df_viol_distr,
    by = c("region", "district", "date"),
    all.x = TRUE
  )
  # %>% merge(
  #   df_pop %>% select(-district_code),
  #   by = "district",
  #   all.x = TRUE
  # )
  # %>% pivot_longer(
  #   cols = -c(district, pop, date),
  #   names_to = "variable",
  #   values_to = "value"
  # )
  # %>% mutate(
  #   value_per_1000 = 1000 * value / pop
  # )
  # %>% group_by(district, variable)
  # %>% mutate(
  #   mean_value = mean(value, na.rm = TRUE),
  #   sd_value = sd(value, na.rm = TRUE),
  #   mean_value_per_1000 = mean(value_per_1000, na.rm = TRUE),
  #   sd_value_per_1000 = sd(value_per_1000, na.rm = TRUE)
  # )
  # %>% ungroup()
  # %>% mutate(
  #   dev_value = if_else(
  #     sd_value > 0,
  #     (value - mean_value) /sd_value,
  #     0
  #   ),
  #   dev_value_per_1000 = if_else(
  #     sd_value_per_1000 > 0,
  #     (value_per_1000 - mean_value_per_1000) / sd_value_per_1000,
  #     0
  #   )
  # )
  # %>% select(
  #   -c(pop, mean_value, sd_value, mean_value_per_1000, sd_value_per_1000)
  # )
  # %>% pivot_wider(
  #   id_cols = c(district, date),
  #   names_from = "variable",
  #   values_from = c(value, dev_value, value_per_1000, dev_value_per_1000)
  # )
  %>% arrange(district, date)
)
```

```{r}
df_health_reg <- (
  df_maln_reg
  %>% merge(
    df_viol_reg,
    by = c("region", "date"),
    all.x = TRUE
  )
  # %>% merge(
  #   df_pop_reg,
  #   by = "region",
  #   all.x = TRUE
  # )
  # %>% pivot_longer(
  #   cols = -c(region, pop, date),
  #   names_to = "variable",
  #   values_to = "value"
  # )
  # %>% mutate(
  #   value_per_1000 = 1000 * value / pop
  # )
  # %>% group_by(region, variable)
  # %>% mutate(
  #   mean_value = mean(value, na.rm = TRUE),
  #   sd_value = sd(value, na.rm = TRUE),
    # mean_value_per_1000 = mean(value_per_1000, na.rm = TRUE),
    # sd_value_per_1000 = sd(value_per_1000, na.rm = TRUE)
  # )
  # %>% ungroup()
  # %>% mutate(
  #   dev_value = if_else(
  #     sd_value > 0,
  #     (value - mean_value) /sd_value,
  #     0
  #   ),
  #   dev_value_per_1000 = if_else(
  #     sd_value_per_1000 > 0,
  #     (value_per_1000 - mean_value_per_1000) / sd_value_per_1000,
  #     0
  #   )
  # )
  # %>% select(
  #   -c(pop, mean_value, sd_value, mean_value_per_1000, sd_value_per_1000)
  # )
  # %>% pivot_wider(
  #   id_cols = c(region, date),
  #   names_from = "variable",
  #   values_from = c(value, dev_value, value_per_1000, dev_value_per_1000)
  # )
  %>% arrange(region, date)
)
```

## Compounded violence and malnutrition effects

```{r}
df_health_distr_cum <- (
  df_health_distr
  %>% group_by(region, district)
  %>% mutate(
    across(
      -c(date, matches("_\\d+m")),
      ~ zoo::rollsum(., k = 3, fill = NA, align = "right"),
        .names = "{.col}_3m"
    ),
    across(
      -c(date, matches("_\\d+m")),
      ~ zoo::rollsum(., k = 6, fill = NA, align = "right"),
        .names = "{.col}_6m"
    ),
    across(
      -c(date, matches("_\\d+m")),
      ~ zoo::rollsum(., k = 12, fill = NA, align = "right"),
        .names = "{.col}_12m"
    ),
    across(
      -c(date, matches("_\\d+m")),
      ~ zoo::rollsum(., k = 24, fill = NA, align = "right"),
        .names = "{.col}_24m"
    )
  )
)
```

```{r}
df_health_reg_cum <- (
  df_health_reg
  %>% group_by(region)
  %>% mutate(
    across(
      -c(date, matches("_\\d+m")),
      ~ zoo::rollsum(., k = 3, fill = NA, align = "right"),
        .names = "{.col}_3m"
    ),
    across(
      -c(date, matches("_\\d+m")),
      ~ zoo::rollsum(., k = 6, fill = NA, align = "right"),
        .names = "{.col}_6m"
    ),
    across(
      -c(date, matches("_\\d+m")),
      ~ zoo::rollsum(., k = 12, fill = NA, align = "right"),
        .names = "{.col}_12m"
    ),
    across(
      -c(date, matches("_\\d+m")),
      ~ zoo::rollsum(., k = 24, fill = NA, align = "right"),
        .names = "{.col}_24m"
    )
  )
)
```

## Combine climate variables

```{r}
df_clim_distr <- (
  df_utci
  %>% merge(
    df_spei %>% select(-c(region, district)),
    by = c("district_code", "date"),
    all.x = TRUE
  )
  %>% merge(
    df_rain %>% select(-c(region, district)),
    by = c("district_code", "date"),
    all.x = TRUE
  )
  %>% select(-c(district_code))
)
```

```{r}
colSums(is.na(df_clim_distr))
```

```{r}
df_clim_reg <- (
  df_utci_reg
  %>% merge(
    df_spei_reg,
    by = c("region", "date"),
    all.x = TRUE
  )
  %>% merge(
    df_rain_reg,
    by = c("region", "date"),
    all.x = TRUE
  )
)
```

```{r}
colSums(is.na(df_clim_reg))
```

## Compounded climate effects

```{r}
df_clim_distr_month_cum <- (
  df_clim_distr
  %>% group_by(region, district)
  %>% mutate(
    across(
      -c(date, matches("_\\d+m")),
      ~ zoo::rollsum(., k = 3, fill = NA, align = "right"),
        .names = "{.col}_3m"
    ),
    across(
      -c(date, matches("_\\d+m")),
      ~ zoo::rollsum(., k = 6, fill = NA, align = "right"),
        .names = "{.col}_6m"
    ),
    across(
      -c(date, matches("_\\d+m")),
      ~ zoo::rollsum(., k = 12, fill = NA, align = "right"),
        .names = "{.col}_12m"
    ),
    across(
      -c(date, matches("_\\d+m")),
      ~ zoo::rollsum(., k = 18, fill = NA, align = "right"),
        .names = "{.col}_18m"
    ),
    across(
      -c(date, matches("_\\d+m")),
      ~ zoo::rollsum(., k = 24, fill = NA, align = "right"),
        .names = "{.col}_24m"
    )
  )
  %>% select(
    date,
    region,
    district,
    matches("_\\d+m")
  )
)
```

```{r}
df_clim_reg_month_cum <- (
  df_clim_reg
  %>% group_by(region)
  %>% mutate(
    across(
      -c(date, matches("_\\d+m")),
      ~ zoo::rollsum(., k = 3, fill = NA, align = "right"),
        .names = "{.col}_3m"
    ),
    across(
      -c(date, matches("_\\d+m")),
      ~ zoo::rollsum(., k = 6, fill = NA, align = "right"),
        .names = "{.col}_6m"
    ),
    across(
      -c(date, matches("_\\d+m")),
      ~ zoo::rollsum(., k = 12, fill = NA, align = "right"),
        .names = "{.col}_12m"
    ),
    across(
      -c(date, matches("_\\d+m")),
      ~ zoo::rollsum(., k = 18, fill = NA, align = "right"),
        .names = "{.col}_18m"
    ),
    across(
      -c(date, matches("_\\d+m")),
      ~ zoo::rollsum(., k = 24, fill = NA, align = "right"),
        .names = "{.col}_24m"
    )
  )
  %>% select(
    date,
    region,
    matches("_\\d+m")
  )
)
```

## Combine all

```{r}
lags <- 1:12
```

```{r}
df_distr <- (
  df_health_distr_cum
  %>% merge(
    df_clim_distr_month_cum,
    by = c("region", "district", "date"),
    all.x = TRUE
  )
  %>% merge(
    df_pop,
    by = c("region", "district"),
    all.x = TRUE
  )
  %>% select(
    region,
    district,
    date,
    pop,
    (matches("_\\d+m") | contains("cases"))
  )
  %>% mutate(
    across(
      .cols = matches("maln|viol"),
      .fns = ~ . * 1000 / pop,
      .names = "{.col}_per_1000"
    )
  )
  %>% select(
    !(matches("maln|viol") & !contains("per_1000"))
  )
  %>% pivot_longer(
    cols = -c(region, district, pop, date),
    names_to = "variable",
    values_to = "value"
  )
  %>% group_by(region, district, variable)
  %>% mutate(
    mean_value = mean(value, na.rm = TRUE),
    sd_value = sd(value, na.rm = TRUE)
  )
  %>% ungroup()
  %>% mutate(
    dev_value = if_else(
      sd_value > 0,
      (value - mean_value) /sd_value,
      0
    )
  )
  %>% select(
    -c(mean_value, sd_value)
  )
  %>% pivot_wider(
    id_cols = c(region, district, date),
    names_from = "variable",
    values_from = c(value, dev_value)
  )
  %>% arrange(region, district, date)
  %>% group_by(region, district)
  %>% mutate(
    across(
      .cols = matches("_\\d+m") & !contains("viol"),
      .fns  = setNames(
        lapply(lags, function(n) function(x) lag(x, n)), # this passes a list of named functions so that then I can use {.fn} later
        paste0("lag", lags)
      ),
      .names = "{.col}_{.fn}"
    )
  )
  %>% ungroup()
)
```

```{r}
df_reg <- (
  df_health_reg_cum
  %>% merge(
    df_clim_reg_month_cum,
    by = c("region", "date"),
    all.x = TRUE
  )
  %>% merge(
    df_pop_reg,
    by = c("region"),
    all.x = TRUE
  )
  %>% select(
    region,
    date,
    pop,
    (matches("_\\d+m") | contains("cases"))
  )
  %>% mutate(
    across(
      .cols = matches("maln|viol"),
      .fns = ~ . * 1000 / pop,
      .names = "{.col}_per_1000"
    )
  )
  %>% select(
    !(matches("maln|viol") & !contains("per_1000"))
  )
  %>% pivot_longer(
    cols = -c(region, pop, date),
    names_to = "variable",
    values_to = "value"
  )
  %>% group_by(region, variable)
  %>% mutate(
    mean_value = mean(value, na.rm = TRUE),
    sd_value = sd(value, na.rm = TRUE)
  )
  %>% ungroup()
  %>% mutate(
    dev_value = if_else(
      sd_value > 0,
      (value - mean_value) /sd_value,
      0
    )
  )
  %>% select(
    -c(mean_value, sd_value)
  )
  %>% pivot_wider(
    id_cols = c(region, date),
    names_from = "variable",
    values_from = c(value, dev_value)
  )
  %>% arrange(region, date)
  %>% group_by(region)
  %>% mutate(
    across(
      .cols = matches("_\\d+m") & !contains("viol"),
      .fns  = setNames(
        lapply(lags, function(n) function(x) lag(x, n)), # passing a named list of functions
        paste0("lag", lags)
      ),
      .names = "{.col}_{.fn}"
    )
  )
  %>% ungroup()
)
```

# Save

```{r}
write_csv(
  df_distr,  
  file = file.path(output_data_dir, "climate_maln_viol_by_district.csv")
)
```

```{r}
write_csv(
  df_reg,  
  file = file.path(output_data_dir, "climate_maln_viol_by_region.csv")
)
```

# Correlation analysis

```{r}
df_reg_an <- df_reg %>% filter(region != "West Nile")
df_distr_an <- df_distr %>% filter(region != "West Nile")
```


## Climate VS Malnutrition

### By Region

```{r}
# regions <- unique(df_reg$region)
# n_regions <- length(regions)
# corr_clim_maln_reg <- list()
# for (i in 1:n_regions) {
#   df_corr <- (
#     df_reg
#     %>% filter(region == regions[[i]])
#     %>% select(
#       where(is.numeric) 
#     )
#     %>% na.omit()
#     %>% as.matrix()
#     %>% cor()
#     %>% as.data.frame()
#     %>% rownames_to_column("var1")
#     %>% pivot_longer(
#       cols = -var1,
#       names_to = "var2",
#       values_to = "correlation"
#     )
#     %>% filter(
#       (var1 != var2) 
#       & (str_detect(var2, "maln"))
#       & !(str_detect(var1, "viol"))
#       & !(str_detect(var1, "maln"))
#       & !(str_detect(var2, "lag"))
#     )
#     %>% arrange(desc(abs(correlation)))
#     # %>% arrange(desc(correlation))
#     %>% mutate(
#       region = regions[[i]]
#     )
#   )
#   corr_clim_maln_reg[[i]] <- df_corr[1, ]
# }
# df_corr_reg <- bind_rows(corr_clim_maln_reg)
```

```{r}
# #| fig-width: 10
# #| fig-height: 12
# p <- list()
# for (i in 1:nrow(df_corr_reg)) {
#   p[[i]] <- (
#     df_reg
#     %>% select(
#       region,
#       df_corr_reg$var1[[i]],
#       df_corr_reg$var2[[i]]
#     )
#     %>% na.omit()
#     %>% filter(region == df_corr_reg$region[[i]])
#     %>% ggplot()
#     + geom_point(
#       aes(
#         x = !!sym(df_corr_reg$var1[[i]]),
#         y = !!sym(df_corr_reg$var2[[i]]),
#       )
#     )
#     + theme(
#       panel.background = element_blank(),
#       panel.grid = element_blank(),
#       panel.border = element_rect(fill = NA, colour = "black", linewidth = 1),
#       plot.background = element_blank(),
#       plot.title = element_text(size = 16),
#       axis.ticks.length = unit(4, "pt"),
#       axis.ticks = element_line(linewidth = 1),
#       axis.title = element_text(size = 16),
#       axis.text = element_text(size = 15),
#       legend.title = element_text(size = 16),
#       legend.text = element_text(size = 15),
#       legend.background = element_blank(),
#       legend.position = "inside",
#       legend.position.inside = c(0.65, 0.7),
#     )
#     + labs(
#       title = df_corr_reg$region[[i]],
#       x = label_map[df_corr_reg$var1[[i]]],
#       y = label_map[df_corr_reg$var2[[i]]]
#     )
#     + guides(
#       color = "none"
#     )
#   )
# }
# (
#   (p[[1]] + p[[2]])
#   / (p[[3]] + p[[4]])
#   / (p[[5]] + p[[6]])
#   / (p[[7]] + p[[8]])
#   / (p[[9]] + p[[10]])
# )
```

#### Mean correlations

```{r}
cols <- colnames(df_reg_an)
vars <- cols[str_detect(cols, "maln") & !str_detect(cols, "lag")]
```


```{r}
mean_corrs_reg <-  get_mean_corrs_multi_var(df_reg_an, vars = vars, level = "region")
```

```{r}
mean_corrs_reg
```


```{r}
#| fig-width: 10
#| fig-height: 12
x <- "value_num_utci_anomalies_3m_lag9"
y <- "value_maln_cases_3m_per_1000"
(
  df_reg_an
  %>% select(
    region,
    !!sym(x),
    !!sym(y)
  )
  %>% na.omit()
  %>% ggplot(
    aes(
      x = !!sym(x),
      y = !!sym(y),
      color = region
    )
  )
  + geom_point()
  + geom_smooth(
    mapping = aes(
      color = region,
      fill = region
    ),
    method = "lm",
    formula = y ~ x
  )
  + facet_wrap(
    ~ region,
    ncol = 2,
    scales = "free"
  )
  + theme(
    panel.background = element_blank(),
    panel.grid = element_blank(),
    panel.border = element_rect(fill = NA, colour = "black", linewidth = 1),
    plot.background = element_blank(),
    plot.title = element_text(size = 16),
    axis.ticks.length = unit(4, "pt"),
    axis.ticks = element_line(linewidth = 1),
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 15),
    legend.title = element_text(size = 16),
    legend.text = element_text(size = 15),
    legend.background = element_blank(),
    legend.position = "inside",
    legend.position.inside = c(0.65, 0.7),
    strip.background = element_blank(),
    strip.text = element_text(size = 16)
  )
  + guides(
    color = "none",
    fill = "none"
  )
  + labs(
    x = label_map[x],
    y = label_map[y]
  )
)
```

#### Single climate factor

```{r}
corr_spei_maln_reg <- list()
for (i in 1:n_regions) {
  df_corr <- (
    df_reg
    %>% filter(region == regions[i])
    %>% select(
      value_num_spei_anomalies_12m_lag12,
      value_maln_cases_3m_per_1000
    )
    %>% na.omit()
    %>% as.matrix()
    %>% cor()
    %>% as.data.frame()
    %>% rownames_to_column("var1")
    %>% pivot_longer(
      cols = -var1,
      names_to = "var2",
      values_to = "correlation"
    )
    %>% filter(
      (var1 > var2)
    )
    %>% mutate(
      region = regions[[i]]
    )
    %>% select(
      region,
      correlation
    )
  )
  corr_spei_maln_reg[[i]] <- df_corr[1, ]
}
df_corr_spei_maln_reg <- (
  bind_rows(corr_spei_maln_reg)
  %>% arrange(desc(correlation))
)
```
### By District

```{r}
distrs <- unique(df_distr$district)
n_distrs <- length(distrs)
corr_clim_maln_distr <- list()
for (i in 1:n_distrs) {
  df_corr <- (
    df_distr
    %>% filter(district == distrs[i])
    %>% select(
      where(is.numeric) 
    )
    %>% na.omit()
    %>% as.matrix()
    %>% cor()
    %>% as.data.frame()
    %>% rownames_to_column("var1")
    %>% pivot_longer(
      cols = -var1,
      names_to = "var2",
      values_to = "correlation"
    )
    %>% filter(
      (var1 != var2) 
      & (str_detect(var2, "maln"))
      & !(str_detect(var1, "viol"))
      & !(str_detect(var1, "maln"))
      & !(str_detect(var2, "lag"))
    )
    # %>% arrange(desc(abs(correlation)))
    %>% arrange(desc(correlation))
    %>% mutate(
      district = distrs[[i]]
    )
  )
  corr_clim_maln_distr[[i]] <- df_corr[1, ]
}
df_corr_distr <- (
  bind_rows(corr_clim_maln_distr)
  %>% arrange(desc(correlation))
)
```

```{r}
x <- "value_num_spei_anomalies_12m_lag12"
y <- "value_maln_cases_3m_per_1000"
(
  df_distr
  %>% filter(district == "Pader")
  %>% select(
    !!sym(x),
    !!sym(y)
  )
  %>% na.omit()
  %>% ggplot(
    aes(
      x = !!sym(x),
      y = !!sym(y)
    )
  ) 
  + geom_point()
)
```

```{r}
(
  df_distr
  %>% filter(district == distrs[i])
  %>% select(
    value_num_spei_anomalies_12m_lag12,
    value_maln_cases_3m_per_1000
  )
  %>% na.omit()
  %>% as.matrix()
  %>% cor()
  %>% as.data.frame()
  %>% rownames_to_column("var1")
  %>% pivot_longer(
    cols = -var1,
    names_to = "var2",
    values_to = "correlation"
  )
  %>% filter(
    (var1 > var2)
  )
)
```

#### Single climate factor

```{r}
df_corr <- (
  df_distr
  %>% filter(district == distrs[i])
  %>% select(
    where(is.numeric) 
  )
  %>% na.omit()
  %>% as.matrix()
  %>% cor()
  %>% as.data.frame()
  %>% rownames_to_column("var1")
  %>% pivot_longer(
    cols = -var1,
    names_to = "var2",
    values_to = "correlation"
  )
  %>% filter(
    (var1 != var2)
    & (var2 == "value_maln_cases_3m_per_1000")
  )
  %>% filter(
    case_when(
      str_detect("value_maln_cases_3m_per_1000", "maln") ~ !(str_detect(var1, "maln")),
      str_detect("value_maln_cases_3m_per_1000", "viol") ~ !(str_detect(var1, "viol")),
      TRUE ~ TRUE
    )
  )
  %>% mutate(
    district = distrs[[i]]
  )
  # %>% select(
  #   district,
  #   correlation
  # )
)
```





```{r}
distrs <- unique(df_distr$district)
n_distrs <- length(distrs)
corr_spei_maln_distr <- list()
for (i in 1:n_distrs) {
  df_corr <- (
    df_distr
    %>% filter(district == distrs[i])
    %>% select(
      value_num_utci_anomalies_12m,
      value_maln_cases_12m_per_1000
    )
    %>% na.omit()
    %>% as.matrix()
    %>% cor()
    %>% as.data.frame()
    %>% rownames_to_column("var1")
    %>% pivot_longer(
      cols = -var1,
      names_to = "var2",
      values_to = "correlation"
    )
    %>% filter(
      (var1 > var2)
    )
    %>% mutate(
      district = distrs[[i]]
    )
    %>% select(
      district,
      correlation
    )
  )
  corr_spei_maln_distr[[i]] <- df_corr[1, ]
}
df_corr_spei_maln_distr <- (
  bind_rows(corr_spei_maln_distr)
  %>% arrange(desc(correlation))
)
```
```{r}
hist(df_corr_spei_maln_distr$correlation)
```


## Malnutrition VS Violence

```{r}
regions <- unique(df_reg$region)
n_regions <- length(regions)
corr_clim_viol_reg <- list()
for (i in 1:n_regions) {
  df_corr <- (
    df_reg
    %>% filter(region == regions[[i]])
    %>% select(
      where(is.numeric) 
    )
    %>% na.omit()
    %>% as.matrix()
    %>% cor()
    %>% as.data.frame()
    %>% rownames_to_column("var1")
    %>% pivot_longer(
      cols = -var1,
      names_to = "var2",
      values_to = "correlation"
    )
    %>% filter(
      (var1 != var2) 
      & (str_detect(var2, "viol"))
      & (str_detect(var1, "maln"))
      & !(str_detect(var1, "viol"))
      & !(str_detect(var2, "lag"))
    )
    %>% arrange(desc(abs(correlation)))
    # %>% arrange(desc(correlation))
    %>% mutate(
      region = regions[[i]]
    )
  )
  corr_clim_viol_reg[[i]] <- df_corr[1, ]
}
df_corr_viol_reg <- bind_rows(corr_clim_viol_reg)
```

```{r}
#| fig-width: 10
#| fig-height: 12
p <- list()
for (i in 1:nrow(df_corr_viol_reg)) {
  p[[i]] <- (
    df_reg
    %>% select(
      region,
      df_corr_viol_reg$var1[[i]],
      df_corr_viol_reg$var2[[i]]
    )
    %>% na.omit()
    %>% filter(region == df_corr_viol_reg$region[[i]])
    %>% ggplot()
    + geom_point(
      aes(
        x = !!sym(df_corr_viol_reg$var1[[i]]),
        y = !!sym(df_corr_viol_reg$var2[[i]]),
      )
    )
    + theme(
      panel.background = element_blank(),
      panel.grid = element_blank(),
      panel.border = element_rect(fill = NA, colour = "black", linewidth = 1),
      plot.background = element_blank(),
      plot.title = element_text(size = 16),
      axis.ticks.length = unit(4, "pt"),
      axis.ticks = element_line(linewidth = 1),
      axis.title = element_text(size = 16),
      axis.text = element_text(size = 15),
      legend.title = element_text(size = 16),
      legend.text = element_text(size = 15),
      legend.background = element_blank(),
      legend.position = "inside",
      legend.position.inside = c(0.65, 0.7),
    )
    + labs(
      title = df_corr_viol_reg$region[[i]],
      x = label_map[df_corr_viol_reg$var1[[i]]],
      y = label_map[df_corr_viol_reg$var2[[i]]]
    )
    + guides(
      color = "none"
    )
  )
}
(
  (p[[1]] + p[[2]])
  / (p[[3]] + p[[4]])
  / (p[[5]] + p[[6]])
  / (p[[7]] + p[[8]])
  / (p[[9]] + p[[10]])
)
```


```{r}
(
  df_reg
  %>% filter(region == "Karamoja")
  %>% select(
    where(is.numeric) 
    # & !contains("rainfall")
  )
  %>% na.omit()
  %>% as.matrix()
  %>% cor()
  %>% as.data.frame()
  %>% rownames_to_column("var1")
  %>% pivot_longer(
    cols = -var1,
    names_to = "var2",
    values_to = "correlation"
  )
  %>% filter(
    (var1 != var2) 
    & !(str_detect(var1, "maln") & str_detect(var2, "maln"))
    & !(str_detect(var1, "viol") & str_detect(var2, "viol"))
    & (str_detect(var2, "cases"))
  )
  %>% arrange(desc(abs(correlation)))
)
```

```{r}
df_corr_distr <- (
  df_distr
  %>% select(
    where(is.numeric) 
    # & !contains("rainfall")
  )
  %>% na.omit()
  %>% as.matrix()
  %>% cor()
  %>% as.data.frame()
  %>% rownames_to_column("var1")
  %>% pivot_longer(
    cols = -var1,
    names_to = "var2",
    values_to = "correlation"
  )
  %>% filter(
    (var1 != var2) 
    & !(str_detect(var1, "maln") & str_detect(var2, "maln"))
    & !(str_detect(var1, "viol") & str_detect(var2, "viol"))
    & (str_detect(var2, "cases"))
  )
  %>% arrange(desc(abs(correlation)))
)
```

```{r}
df_corr_distr
```

```{r}
(
  df_distr
  %>% ggplot()
  + geom_point(
    aes(
      x = value_num_utci_anomalies_12m,
      y = value_maln_cases_12m_per_1000,
      color = district
    )
  )
  + guides(
    color = "none"
  )
)
```

```{r}
df_corr_reg <- (
  df_reg
  %>% select(
    where(is.numeric) 
    # & !contains("rainfall")
  )
  %>% na.omit()
  %>% as.matrix()
  %>% cor()
  %>% as.data.frame()
  %>% rownames_to_column("var1")
  %>% pivot_longer(
    cols = -var1,
    names_to = "var2",
    values_to = "correlation"
  )
  %>% filter(
    (var1 != var2) 
    & !(str_detect(var1, "maln") & str_detect(var2, "maln"))
    & !(str_detect(var1, "viol") & str_detect(var2, "viol"))
    & (str_detect(var2, "cases"))
  )
  %>% arrange(desc(abs(correlation)))
)
```

```{r}
df_corr_reg
```

```{r}
(
  df_reg
  %>% ggplot()
  + geom_point(
    aes(
      x = dev_value_num_utci_anomalies_12m,
      y = dev_value_maln_cases_24m_per_1000,
      color = region
    )
  )
)
```

## With Malnutrition cases

```{r}
(
  df_corr
  %>% filter(
    var2 == "value_maln_cases"
  )
)
```

## With Malnutrition cases deviation

```{r}
(
  df_corr
  %>% filter(
    var2 == "dev_value_maln_cases"
  )
)
```

```{r}
df_corr
```

# Viz

```{r}
bin_centers_from_levels <- function(levels_chr) {
  parts <- strsplit(str_remove_all(levels_chr, "[\\[\\]\\(\\) ]"), ",", fixed = FALSE)
  lo <- as.numeric(vapply(parts, `[`, "", 1))
  hi <- as.numeric(vapply(parts, `[`, "", 2))
  centers <- (lo + hi) / 2
  centers
}
```

## Malnutrition VS Climate

```{r}
# df_viz_maln_clim <- (
#   df_distr
#   %>% select(
#     district,
#     date,
#     rain = num_rainfall_anomalies_24m_lag5,
#     utci = num_utci_anomalies_6m_lag1,
#     spei = num_spei_anomalies_12m_lag13,
#     value_maln_cases,
#   )
#   %>% mutate(
#     year = year(date),
#     rain_binned = cut_width(rain, 5),
#     utci_binned = cut_width(utci, 20),
#   )
# )
# 
# rain_lvls <- levels(df_viz$rain_binned)
# rain_centers = bin_centers_from_levels(rain_lvls)
# utci_lvls <- levels(df_viz$utci_binned)
# utci_centers = bin_centers_from_levels(utci_lvls)
df_viz_maln_clim <- (
  df_distr
  %>% select(
    district,
    date,
    rain = value_num_rainfall_anomalies_24m_lag5,
    utci = value_num_utci_anomalies_6m_lag1,
    spei = value_num_spei_anomalies_12m_lag12,
    maln = value_maln_cases_per_1000,
  )
  %>% mutate(
    year = year(date),
    rain_binned = cut_width(rain, 5),
    utci_binned = cut_width(utci, 20),
  )
)

rain_lvls <- levels(df_viz_maln_clim$rain_binned)
rain_centers <- bin_centers_from_levels(rain_lvls)
utci_lvls <- levels(df_viz_maln_clim$utci_binned)
utci_centers <- bin_centers_from_levels(utci_lvls)
```

### Rainfall

```{r}
#| fig-width: 11
#| fig-height: 3

(
  df_viz_maln_clim
  %>% filter(
    year > 2022,
    !is.na(rain_binned)
  )
  %>% ggplot(
    aes(
      x = rain_binned,
      y = maln,
      color = as.factor(year),
    )
  )
  + geom_boxplot(
    fill = NA,
    outliers = FALSE,
    whisker.linewidth = 1,
    staple.linewidth = 1,
    median.linewidth = 1,
    box.linewidth = 1
  )
  + facet_wrap(
    ~ year,
    nrow = 1
  )
  + scale_x_discrete(
    labels = setNames(
      rain_centers,
      rain_lvls
    )
  )
  + paletteer::scale_color_paletteer_d(
    "wesanderson::Zissou1"
  )
  + theme(
    panel.background = element_blank(),
    panel.grid = element_blank(),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 1),
    plot.background = element_blank(),
    plot.title = element_text(size = 16, hjust = 0.5),
    plot.subtitle = element_text(size = 14, hjust = 0.5),,
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 15),
    legend.background = element_blank(),
    legend.title = element_blank(),
    legend.text = element_text(size = 15),
    strip.placement = "outside",
    strip.text = element_text(size = 15),
    strip.background = element_blank()
  )
  + guides(
    color = "none",
    fill = "none"
  )
  + labs(
    x = "Days of high rain (2 years, 5 months lagged)",
    y = "Monthly malnutrition cases"
  )
)

# ggsave(
#   path = fig_dir,
#   filename = "maln_cases_vs_rain_24m_lag5.png"
# )
```

### UTCI

```{r}
#| fig-width: 11
#| fig-height: 4.5

(
  df_viz_maln_clim
  %>% filter(
    !is.na(utci_binned),
    utci <= 120
  )
  # %>% na.omit()
  %>% ggplot(
    aes(
      x = utci_binned,
      y = maln,
      color = as.factor(year),
    )
  )
  + geom_boxplot(
    fill = NA,
    outliers = FALSE,
    whisker.linewidth = 1,
    staple.linewidth = 1,
    median.linewidth = 1,
    box.linewidth = 1
  )
  + facet_wrap(
    ~ year,
    nrow = 2
  )
  + scale_x_discrete(
    labels = setNames(
      utci_centers,
      utci_lvls
    )
  )
  + paletteer::scale_color_paletteer_d(
      "LaCroixColoR::Orange"
  )
  + theme(
    panel.background = element_blank(),
    panel.grid = element_blank(),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 1),
    plot.background = element_blank(),
    plot.title = element_text(size = 16, hjust = 0.5),
    plot.subtitle = element_text(size = 14, hjust = 0.5),,
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 15),
    legend.background = element_blank(),
    legend.title = element_blank(),
    legend.text = element_text(size = 15),
    strip.placement = "outside",
    strip.text = element_text(size = 15),
    strip.background = element_blank()
  )
  + guides(
    color = "none",
    fill = "none"
  )
  + labs(
    x = "Days of high UTCI (6 months, 1 month lagged)",
    y = "Monthly malnutrition cases"
  )
)

# ggsave(
#   path = fig_dir,
#   filename = "maln_cases_vs_utci_6m_lag1.png"
# )
```

### SPEI

```{r}
#| fig-width: 11
#| fig-height: 3

(
  df_viz_maln_clim
  %>% filter(
    !is.na(spei),
    year > 2021
  )
  %>% ggplot(
    aes(
      x = as.factor(spei),
      y = maln,
      color = as.factor(year),
    )
  )
  + geom_boxplot(
    fill = NA,
    outliers = FALSE,
    whisker.linewidth = 1,
    staple.linewidth = 1,
    median.linewidth = 1,
    box.linewidth = 1
  )
  + facet_wrap(
    ~ year,
    nrow = 1
  )
  + paletteer::scale_color_paletteer_d(
      "LaCroixColoR::Orange"
  )
  + theme(
    panel.background = element_blank(),
    panel.grid = element_blank(),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 1),
    plot.background = element_blank(),
    plot.title = element_text(size = 16, hjust = 0.5),
    plot.subtitle = element_text(size = 14, hjust = 0.5),,
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 15),
    legend.background = element_blank(),
    legend.title = element_blank(),
    legend.text = element_text(size = 15),
    strip.placement = "outside",
    strip.text = element_text(size = 15),
    strip.background = element_blank()
  )
  + guides(
    color = "none",
    fill = "none"
  )
  + labs(
    x = "Months of low SPEI (12 months, 13 months lagged)",
    y = "Monthly malnutrition cases"
  )
)

ggsave(
  path = fig_dir,
  filename = "maln_cases_vs_spei_12m_lag13.png"
)
```

## Violence VS Climate

```{r}
df_viz_viol_clim <- (
  df_distr
  %>% select(
    district,
    date,
    rain = value_num_rainfall_anomalies_12m_lag1,
    utci = value_num_utci_anomalies_12m_lag1,
    spei = value_num_spei_anomalies_12m_lag1,
    viol = value_viol_cases_per_1000
  )
  %>% mutate(
    year = year(date),
    rain_binned = cut_width(rain, 5),
    utci_binned = cut_width(utci, 30),
  )
)

rain_lvls_viol_clim <- levels(df_viz_viol_clim$rain_binned)
rain_centers_viol_clim = bin_centers_from_levels(rain_lvls_viol_clim)
utci_lvls_viol_clim <- levels(df_viz_viol_clim$utci_binned)
utci_centers_viol_clim = bin_centers_from_levels(utci_lvls_viol_clim)
```

### Rainfall

```{r}
#| fig-width: 11
#| fig-height: 3

(
  df_viz_viol_clim
  %>% filter(
    # year > 2022,
    !is.na(rain_binned)
  )
  %>% ggplot(
    aes(
      x = rain_binned,
      y = viol,
      color = as.factor(year),
    )
  )
  + geom_boxplot(
    fill = NA,
    outliers = FALSE,
    whisker.linewidth = 1,
    staple.linewidth = 1,
    median.linewidth = 1,
    box.linewidth = 1
  )
  + facet_wrap(
    ~ year,
    nrow = 1
  )
  + scale_x_discrete(
    labels = setNames(
      rain_centers_viol_clim,
      rain_lvls_viol_clim
    )
  )
  + paletteer::scale_color_paletteer_d(
    "wesanderson::Zissou1"
  )
  + theme(
    panel.background = element_blank(),
    panel.grid = element_blank(),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 1),
    plot.background = element_blank(),
    plot.title = element_text(size = 16, hjust = 0.5),
    plot.subtitle = element_text(size = 14, hjust = 0.5),,
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 15),
    legend.background = element_blank(),
    legend.title = element_blank(),
    legend.text = element_text(size = 15),
    strip.placement = "outside",
    strip.text = element_text(size = 15),
    strip.background = element_blank()
  )
  + guides(
    color = "none",
    fill = "none"
  )
  + labs(
    x = "Days of high rain (2 years, 5 months lagged)",
    y = "Monthly violence cases"
  )
)

ggsave(
  path = fig_dir,
  filename = "viol_cases_vs_rain_24m_lag5.png"
)
```

### UTCI

#### All years

```{r}
#| fig-width: 5
#| fig-height: 3

(
  df_viz_viol_clim
  %>% filter(
    !is.na(utci_binned)
  )
  # %>% na.omit()
  %>% ggplot(
    aes(
      x = utci_binned,
      y = viol
    )
  )
  + geom_boxplot(
    fill = NA,
    # outliers = FALSE,
    whisker.linewidth = 1,
    staple.linewidth = 1,
    median.linewidth = 1,
    box.linewidth = 1
  )
  + scale_x_discrete(
    labels = setNames(
      utci_centers_viol_clim,
      utci_lvls_viol_clim
    )
  )
  + paletteer::scale_color_paletteer_d(
      "LaCroixColoR::Orange"
  )
  + theme(
    panel.background = element_blank(),
    panel.grid = element_blank(),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 1),
    plot.background = element_blank(),
    plot.title = element_text(size = 16, hjust = 0.5),
    plot.subtitle = element_text(size = 14, hjust = 0.5),,
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 15),
    legend.background = element_blank(),
    legend.title = element_blank(),
    legend.text = element_text(size = 15),
    strip.placement = "outside",
    strip.text = element_text(size = 15),
    strip.background = element_blank()
  )
  + guides(
    color = "none",
    fill = "none"
  )
  + labs(
    x = "Days of high UTCI (6 months, 1 month lagged)",
    y = "Monthly violence cases"
  )
)

ggsave(
  path = fig_dir,
  filename = "viol_cases_vs_utci_6m_lag1.png"
)
```

```{r}
#| fig-width: 11
#| fig-height: 4.5

(
  df_viz_viol_clim
  %>% filter(
    !is.na(utci_binned)
  )
  # %>% na.omit()
  %>% ggplot(
    aes(
      x = utci_binned,
      y = viol,
      color = as.factor(year),
    )
  )
  + geom_boxplot(
    fill = NA,
    outliers = FALSE,
    whisker.linewidth = 1,
    staple.linewidth = 1,
    median.linewidth = 1,
    box.linewidth = 1
  )
  + facet_wrap(
    ~ year,
    nrow = 2
  )
  + scale_x_discrete(
    labels = setNames(
      utci_centers,
      utci_lvls
    )
  )
  + paletteer::scale_color_paletteer_d(
      "LaCroixColoR::Orange"
  )
  + theme(
    panel.background = element_blank(),
    panel.grid = element_blank(),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 1),
    plot.background = element_blank(),
    plot.title = element_text(size = 16, hjust = 0.5),
    plot.subtitle = element_text(size = 14, hjust = 0.5),,
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 15),
    legend.background = element_blank(),
    legend.title = element_blank(),
    legend.text = element_text(size = 15),
    strip.placement = "outside",
    strip.text = element_text(size = 15),
    strip.background = element_blank()
  )
  + guides(
    color = "none",
    fill = "none"
  )
  + labs(
    x = "Days of high UTCI (6 months, 1 month lagged)",
    y = "Monthly violence cases"
  )
)

ggsave(
  path = fig_dir,
  filename = "viol_cases_vs_utci_6m_lag1.png"
)
```

### SPEI

#### All years

```{r}
#| fig-width: 5
#| fig-height: 3

(
  df_viz_viol_clim
  %>% filter(
    !is.na(spei),
    year > 2021
  )
  %>% ggplot(
    aes(
      x = as.factor(spei),
      y = viol
    )
  )
  + geom_boxplot(
    fill = NA,
    # outliers = FALSE,
    whisker.linewidth = 1,
    staple.linewidth = 1,
    median.linewidth = 1,
    box.linewidth = 1
  )
  + theme(
    panel.background = element_blank(),
    panel.grid = element_blank(),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 1),
    plot.background = element_blank(),
    plot.title = element_text(size = 16, hjust = 0.5),
    plot.subtitle = element_text(size = 14, hjust = 0.5),,
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 15),
    legend.background = element_blank(),
    legend.title = element_blank(),
    legend.text = element_text(size = 15),
    strip.placement = "outside",
    strip.text = element_text(size = 15),
    strip.background = element_blank()
  )
  + guides(
    color = "none",
    fill = "none"
  )
  + labs(
    x = "Months of low SPEI (12 months, 1 month lagged)",
    y = "Monthly violence cases per 1000"
  )
)

ggsave(
  path = fig_dir,
  filename = "viol_cases_vs_spei_12m_lag1_all_years.png"
)
```

```{r}
#| fig-width: 11
#| fig-height: 3

(
  df_viz_viol_clim
  %>% filter(
    !is.na(spei),
    year > 2021
  )
  %>% ggplot(
    aes(
      x = as.factor(spei),
      y = viol,
      color = as.factor(year),
    )
  )
  + geom_boxplot(
    fill = NA,
    outliers = FALSE,
    whisker.linewidth = 1,
    staple.linewidth = 1,
    median.linewidth = 1,
    box.linewidth = 1
  )
  + facet_wrap(
    ~ year,
    nrow = 1
  )
  + paletteer::scale_color_paletteer_d(
      "LaCroixColoR::Orange"
  )
  + theme(
    panel.background = element_blank(),
    panel.grid = element_blank(),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 1),
    plot.background = element_blank(),
    plot.title = element_text(size = 16, hjust = 0.5),
    plot.subtitle = element_text(size = 14, hjust = 0.5),,
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 15),
    legend.background = element_blank(),
    legend.title = element_blank(),
    legend.text = element_text(size = 15),
    strip.placement = "outside",
    strip.text = element_text(size = 15),
    strip.background = element_blank()
  )
  + guides(
    color = "none",
    fill = "none"
  )
  + labs(
    x = "Months of low SPEI (12 months, 13 months lagged)",
    y = "Monthly violence cases"
  )
)

ggsave(
  path = fig_dir,
  filename = "viol_cases_vs_spei_12m_lag13.png"
)
```

