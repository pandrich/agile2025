---
title: "UTCI Analysis"
format: html
editor: visual
---

# Environment Setup

```{r setup}
# Packages
library(tidyverse)
library(tidyterra)
library(sf)
library(paletteer)

# Path Structure
root <- rprojroot::has_file("agile2025.Rproj")$make_fix_file()
raw_data_dir <- root("data/raw")
proc_data_dir <- root("data/processed")
fig_dir <- root("figures")
```

# Parameters

```{r}
coords <- list(
  "MOZ" = "-10.41.2.-27.1.29.8",
  "ZWE" = "-15.45.33.21.-22.65.25.05",
  "LSO" = "-28.42.29.65.-30.78.26.85",
  "NAM" = "-16.84.25.28.-29.04.11.72",
  "ZMB" = "-8.2.33.7.-18.08.21.98",
  "UGA" = "4.25.35.04.-1.49.29.55",
  "KEN" = "5.1.41.92.-4.74.33.84"
)
```

# Functions

```{r}
build_utci_ts_country <- function(iso3, rast_pop, adm_pop, adm_shapes) {
  years_folder <- list.files(file.path(raw_data_dir, "UTCI", iso3))
  dfs <- list()
  i <- 0
  for (yf in years_folder) {
    year <- gsub("[^0-9]", "", yf)
    for (m in sprintf("%02d", 1:12)) {
      i <- i + 1
      print(paste("Processing data for", iso3, paste0(year, "-", m)))
      utci <- terra::rast(
        file.path(
          raw_data_dir, 
          "UTCI", 
          iso3, 
          paste0("UTCI_", iso3, "_", year), 
          paste0("ECMWF_utci_monthly_stats_", year, m, "_v1.1_con.area-subset.", coords[iso3], ".nc")
        )
      )
      utci_poly <- utci%>% terra::as.polygons(values = FALSE, dissolve = FALSE)
      pop_sum <- (
        terra::extract(
          rast_pop,
          utci_poly,
          na.rm = TRUE,
          cells = TRUE,
          exact = TRUE
        )
        %>% group_by(cell)
        %>% mutate(
          fraction = fraction / sum(fraction, na.rm = TRUE)
        )
        %>% group_by(ID)
        %>% summarise(
          pop = sum(pop * fraction, na.rm = TRUE)
        )
      )
      utci_weighted_mat <- terra::values(utci, mat = TRUE) * pop_sum$pop
      utci_weighted <- terra::rast(utci)
      terra::values(utci_weighted) <- utci_weighted_mat
      
      adm_utci_month <- (
        utci_weighted
        %>% terra::extract(
          adm_shapes,
          na.rm = TRUE,
          cells = TRUE,
          exact = TRUE
        )
        %>% group_by(cell)
        %>% mutate(
          fraction = fraction / sum(fraction, na.rm = TRUE)
        )
        %>% group_by(ID)
        %>% summarise(
          across(-c(cell, fraction), ~ sum((.) * fraction, na.rm = TRUE))
        )
        %>% mutate(
          pop = adm_pop$pop,
          date = ceiling_date(as.Date(paste0(year, "-", m, "-", "01"), format = "%Y-%m-%d"), "month") - days(1)
        )
        %>% mutate(
          across(-c(ID, pop, date), ~ (.)/pop)
        )
        %>% as.data.frame()
      )
      
      dfs[[i]] <- adm_utci_month
      (
        bind_rows(dfs) 
        %>% rename(adm_code = ID)
        %>% write_csv(file.path(proc_data_dir, paste0("utci_", iso3, ".csv")))
      )
    }
  }
  df <- (
    bind_rows(dfs)
    %>% rename(adm_code = ID)
  )
  df %>% write_csv(file.path(proc_data_dir, paste0("utci_", iso3, ".csv")))
  df
}
```

# Data Import

## Geographies

### Mozambique

```{r}
sf_moz <- (
  st_read(
    file.path(raw_data_dir, "geographies", "Mozambique 2022 DHS - sdr_subnational_boundaries", "shps", "sdr_subnational_boundaries.shp")
  )
  %>% rename_with(tolower)
  %>% select(
    adm1_name = dhsregen,
    adm1_code = regcode
  )
  %>% arrange(adm1_code)
)
```

### Zimbabwe

```{r}
sf_zwe <- (
  st_read(
    file.path(raw_data_dir, "geographies", "Zimbabwe 2015 DHS - sdr_subnational_boundaries", "shps", "sdr_subnational_boundaries.shp")
  )
  %>% rename_with(tolower)
  %>% select(
    adm1_name = dhsregen,
    adm1_code = regcode
  )
  %>% arrange(adm1_code)
)
```

### Lesotho

```{r}
sf_lso <- (
  st_read(
    file.path(raw_data_dir, "geographies", "Lesotho 2023 DHS - sdr_subnational_boundaries", "shps", "sdr_subnational_boundaries.shp")
  )
  %>% rename_with(tolower)
  %>% select(
    adm1_name = dhsregen,
    adm1_code = regcode
  )
  %>% arrange(adm1_code)
)
```

### Namibia

```{r}
sf_nam <- (
  st_read(
    file.path(raw_data_dir, "geographies", "Namibia 2013 DHS - sdr_subnational_boundaries", "shps", "sdr_subnational_boundaries.shp")
  )
  %>% rename_with(tolower)
  %>% select(
    adm1_name = dhsregen,
    adm1_code = regcode
  )
  %>% arrange(adm1_code)
)
```

### Zambia

```{r}
sf_zmb <- (
  st_read(
    file.path(raw_data_dir, "geographies", "Zambia 2018 DHS - sdr_subnational_boundaries", "shps", "sdr_subnational_boundaries.shp")
  )
  %>% rename_with(tolower)
  %>% select(
    adm1_name = dhsregen,
    adm1_code = regcode
  )
  %>% arrange(adm1_code)
)
```

### Uganda

```{r}
# sf_uga <- (
#   st_read(
#     file.path(raw_data_dir, "geographies", "uga_admbnda_ubos_20200824.gdb", fsep = "/"),
#     layer = "uga_admbnda_adm2_ubos_20200824"
#   )
#   %>% rename_with(tolower)
#   %>% mutate(
#     id = row_number()
#   )
#   %>% select(
#     id,
#     adm1_name = admin1name_en,
#     adm2_name = admin2name_en,
#     adm2_pcode = admin2pcode,
#     # adm3_name = admin3name_en,
#     # adm4_name = admin4name_en,
#     # adm4_pcode = admin4pcode,
#     geometry = shape
#   )
# )
sf_uga <- (
  st_read(
    file.path(
      raw_data_dir,
      "geographies",
      "uganda_herbert",
      "uganda_districts.shp"
    ),
  )
  %>% rename_with(tolower)
  # %>% mutate(
  #   district = str_to_title(district)
  # )
  %>% mutate(
    district = case_match(
      district,
      "SSEMBABULE" ~ "Sembabule",
      .default = str_to_title(district)
    )
  )
  %>% select(
    id = objectid,
    adm2_name = district
  )
  %>% st_transform(4326)
)
```

### Kenya

```{r}
sf_ken <- (
  st_read(
    file.path(raw_data_dir, "geographies", "Kenya 2022 DHS - sdr_subnational_boundaries_2025-11-13", "shps", "sdr_subnational_boundaries.shp")
  )
  %>% rename_with(tolower)
  %>% select(
    adm1_name = dhsregen,
    adm1_code = regcode
  )
  %>% arrange(adm1_code)
)
```

## Population

### Mozambique

```{r}
rast_pop_moz_2022 <- (
  terra::rast(
    file.path(raw_data_dir, "population", "moz_pop_2022_CN_1km_R2025A_UA_v1.tif")
  )
  %>% rename(
    pop = global_pop_2022_CN_1km_R2025A_v1
  )
)
```

```{r}
adm1_pop_moz_2022 <- (
  rast_pop_moz_2022
  %>% terra::extract(
    sf_moz,
    na.rm = TRUE,
    cells = TRUE,
    exact = TRUE
  )
  %>% group_by(cell)
  %>% mutate(
    fraction = fraction / sum(fraction, na.rm = TRUE)
  )
  %>% group_by(ID)
  %>% summarise(
    pop = sum(pop * fraction, na.rm = TRUE)
  )
)
```

### Zimbabwe

```{r}
rast_pop_zwe_2022 <- (
  terra::rast(  
    file.path(raw_data_dir, "population", "zwe_pop_2022_CN_1km_R2025A_UA_v1.tif")
  )
  %>% rename(
    pop = global_pop_2022_CN_1km_R2025A_v1
  )
)
```

```{r}
adm1_pop_zwe_2022 <- (
  rast_pop_zwe_2022
  %>% terra::extract(
    sf_zwe,
    na.rm = TRUE,
    cells = TRUE,
    exact = TRUE
  )
  %>% group_by(cell)
  %>% mutate(
    fraction = fraction / sum(fraction, na.rm = TRUE)
  )
  %>% group_by(ID)
  %>% summarise(
    pop = sum(pop * fraction, na.rm = TRUE)
  )
)
```

### Lesotho

```{r}
rast_pop_lso_2022 <- (
  terra::rast(
    file.path(raw_data_dir, "population", "lso_pop_2022_CN_1km_R2025A_UA_v1.tif")
  )
  %>% rename(
    pop = global_pop_2022_CN_1km_R2025A_v1
  )
)
```

```{r}
adm1_pop_lso_2022 <- (
  rast_pop_lso_2022
  %>% terra::extract(
    sf_lso,
    na.rm = TRUE,
    cells = TRUE,
    exact = TRUE
  )
  %>% group_by(cell)
  %>% mutate(
    fraction = fraction / sum(fraction, na.rm = TRUE)
  )
  %>% group_by(ID)
  %>% summarise(
    pop = sum(pop * fraction, na.rm = TRUE)
  )
)
```

### Namibia

```{r}
rast_pop_nam_2022 <- (
  terra::rast(
    file.path(raw_data_dir, "population", "nam_pop_2022_CN_1km_R2025A_UA_v1.tif")
  )
  %>% rename(
    pop = global_pop_2022_CN_1km_R2025A_v1
  )
)
```

```{r}
adm1_pop_nam_2022 <- (
  rast_pop_nam_2022
  %>% terra::extract(
    sf_nam,
    na.rm = TRUE,
    cells = TRUE,
    exact = TRUE
  )
  %>% group_by(cell)
  %>% mutate(
    fraction = fraction / sum(fraction, na.rm = TRUE)
  )
  %>% group_by(ID)
  %>% summarise(
    pop = sum(pop * fraction, na.rm = TRUE)
  )
)
```

### Zambia

```{r}
rast_pop_zmb_2022 <- (
  terra::rast(
    file.path(raw_data_dir, "population", "zmb_pop_2022_CN_1km_R2025A_UA_v1.tif")
  )
  %>% rename(
    pop = global_pop_2022_CN_1km_R2025A_v1
  )
)
```

```{r}
adm1_pop_zmb_2022 <- (
  rast_pop_zmb_2022
  %>% terra::extract(
    sf_zmb,
    na.rm = TRUE,
    cells = TRUE,
    exact = TRUE
  )
  %>% group_by(cell)
  %>% mutate(
    fraction = fraction / sum(fraction, na.rm = TRUE)
  )
  %>% group_by(ID)
  %>% summarise(
    pop = sum(pop * fraction, na.rm = TRUE)
  )
)
```

### Uganda

```{r}
rast_pop_uga_2022 <- (
  terra::rast(
    file.path(raw_data_dir, "population", "uga_pop_2022_CN_1km_R2025A_UA_v1.tif")
  )
  %>% rename(
    pop = global_pop_2022_CN_1km_R2025A_v1
  )
)
```

```{r}
adm_pop_uga_2022 <- (
  rast_pop_uga_2022
  %>% terra::extract(
    sf_uga,
    na.rm = TRUE,
    cells = TRUE,
    exact = TRUE
  )
  %>% group_by(cell)
  %>% mutate(
    fraction = fraction / sum(fraction, na.rm = TRUE)
  )
  %>% group_by(ID)
  %>% summarise(
    pop = sum(pop * fraction, na.rm = TRUE)
  )
)
```

### Kenya

```{r}
rast_pop_ken_2022 <- (
  terra::rast(
    file.path(raw_data_dir, "population", "ken_pop_2022_CN_1km_R2025A_UA_v1.tif")
  )
  %>% rename(
    pop = global_pop_2022_CN_1km_R2025A_v1
  )
)
```

```{r}
adm_pop_ken_2022 <- (
  rast_pop_ken_2022
  %>% terra::extract(
    sf_ken,
    na.rm = TRUE,
    cells = TRUE,
    exact = TRUE
  )
  %>% group_by(cell)
  %>% mutate(
    fraction = fraction / sum(fraction, na.rm = TRUE)
  )
  %>% group_by(ID)
  %>% summarise(
    pop = sum(pop * fraction, na.rm = TRUE)
  )
)
```

## UTCI

Data obtained using the Climate Data Store API

### Method Outline

```{r}
utci_moz_rast <- terra::rast(
  file.path(
    raw_data_dir,
    "UTCI",
    "MOZ",
    paste0("UTCI_", "MOZ", "_", "2024"),
    paste0("ECMWF_utci_monthly_stats_", "2024", "01", "_v1.1_con.area-subset.", coords["MOZ"], ".nc")
    )
  )
utci_moz_poly <- utci_moz_rast %>% terra::as.polygons(values = FALSE, dissolve = FALSE)
```

#### UTCI Grid

```{r}
(
  ggplot()
  + geom_sf(
    data = utci_moz_poly,
    fill = NA,
    color = "gray"
  )
  + geom_sf(
    data = sf_moz,
    fill = NA,
    color = "black",
  )
  + theme(
    panel.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.background = element_blank(),
    axis.title = element_blank(),
    axis.ticks = element_blank(),
    axis.text = element_blank(),
    plot.title = element_text(size = 16, hjust = 0.5, margin = margin(b = 0)),
    plot.subtitle = element_text(size = 14, hjust = 0.5),
    legend.key.height = unit(50, "pt"),
    legend.title = element_text(size = 16, angle = 90, hjust = 0.5),
    legend.text = element_text(size = 14),
    legend.background = element_blank(),
    legend.title.position = "right",
  )
  + labs(
    title = "UTCI Grid",
  )
  # + coord_sf(
  #   xlim = c(30.3, 35.3),
  #   ylim = c(-14, -17.7)
  # )
)
ggsave(
  path = fig_dir,
  filename = "utci_grid_moz.png",
  width = 3,
  height = 5
)
```

#### UTCI Grid Zoom In

```{r}
#| fig-width: 5
#| fig-height: 4
(
  ggplot()
  + geom_spatraster(
    data = rast_pop_moz_2022 %>% terra::crop(terra::ext(32.5, 33.5, -14.8, -13.8)),
    mapping = aes(fill = pop)
  )
  + scale_fill_paletteer_c(
    "scico::devon",
    na.value = "transparent",
    direction = -1
  )
  + geom_sf(
    data = utci_moz_poly,
    fill = NA,
    color = "gray",
    linewidth = 1.3
  )
  + geom_sf(
    data = sf_moz,
    fill = NA,
    color = "black",
    # linewidth = 1.1
  )
  + theme(
    panel.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.background = element_blank(),
    axis.title = element_blank(),
    axis.ticks = element_blank(),
    axis.text = element_blank(),
    plot.title = element_text(size = 16, hjust = 0.5),
    plot.subtitle = element_text(size = 14, hjust = 0.5),
    legend.key.height = unit(50, "pt"),
    legend.title = element_text(size = 18, angle = 90, hjust = 0.5),
    legend.text = element_text(size = 16),
    legend.background = element_blank(),
    legend.title.position = "right",
  )
  + coord_sf(
    xlim = c(32.5, 33.5),
    ylim = c(-14.8, -13.8)
  )
  + labs(
    fill = "Population"
  )
)
ggsave(
  path = fig_dir,
  filename = "utci_grid_moz_zoom_pop.png",
  width = 5,
  height = 4
)
```

#### UTCI times population

```{r}
pop_sum <- (
  terra::extract(
    rast_pop_moz_2022,
    utci_moz_poly,
    cells = TRUE,
    na.rm = TRUE,
    exact = TRUE
  )
  # %>% filter(!is.na(pop))
  %>% group_by(cell)
  %>% mutate(
    fraction = fraction / sum(fraction, na.rm = TRUE)
  )
  %>% group_by(ID)
  %>% summarise(
    pop = sum(pop * fraction, na.rm = TRUE)
  )
)
utci_moz_weighted_mat <- terra::values(utci_moz_rast, mat = TRUE) * pop_sum$pop
utci_moz_weighted <- terra::rast(utci_moz_rast)
terra::values(utci_moz_weighted) <- utci_moz_weighted_mat
```

```{r}
#| fig-width: 6.5
#| fig-height: 4

utci_moz_weighted_cropped <- (
  utci_moz_weighted
  # %>% terra::crop(terra::ext(c(30.3, 35.3, -17.7, -14)))
  %>% terra::crop(terra::ext(32.5, 33.5, -14.8, -13.8))
)

(
  ggplot()
  + geom_spatraster(
    data = utci_moz_weighted_cropped,
    mapping = aes(fill = utci_days_above_32_daily_max)
  )
  + scale_fill_paletteer_c(
    "scico::bilbao",
    na.value = "transparent",
    direction = -1
  )
  + geom_sf(
    data = utci_moz_poly,
    fill = NA,
    color = "gray",
    linewidth = 1.3
  )
  + geom_sf(
    data = sf_moz,
    fill = NA,
    color = "black",
    # linewidth = 1.1
  )
  + theme(
    panel.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.background = element_blank(),
    axis.title = element_blank(),
    axis.ticks = element_blank(),
    axis.text = element_blank(),
    plot.title = element_text(size = 16, hjust = 0.5),
    plot.subtitle = element_text(size = 14, hjust = 0.5),
    legend.key.height = unit(50, "pt"),
    legend.title = element_text(size = 18, angle = 90, hjust = 0.5),
    legend.text = element_text(size = 16),
    legend.background = element_blank(),
    legend.title.position = "right",
  )
  + coord_sf(
    xlim = c(32.5, 33.5),
    ylim = c(-14.8, -13.8)
  )
  # + coord_sf(
  #   xlim = c(30.3, 35.3),
  #   ylim = c(-14, -17.7)
  # )
  + labs(
    fill = "UTCI * Population"
  )
)
ggsave(
  path = fig_dir,
  filename = "utci_pop.png",
  width = 6.5,
  height = 4
)
```

#### Weighted UTCI

```{r}
adm1_utci_month <- (
  utci_moz_weighted
  %>% terra::extract(
    sf_moz,
    cells = TRUE,
    na.rm = TRUE,
    exact = TRUE
  )
  %>% group_by(cell)
  %>% mutate(
    fraction = fraction / sum(fraction, na.rm = TRUE)
  )
  %>% group_by(ID)
  %>% summarise(
    across(-c(cell, fraction), ~ sum((.) * fraction, na.rm = TRUE))
  )
  %>% mutate(
    pop = adm1_pop_moz_2022$pop,
    date = ceiling_date(as.Date(paste0("2024", "-", "01", "-", "01"), format = "%Y-%m-%d"), "month") - days(1)
  )
  %>% mutate(
    across(-c(ID, pop, date), ~ (.)/pop)
  )
  %>% as.data.frame()
  %>% rename(
    adm1_code = ID
  )
)
```

```{r}
sf_adm1_utci_month <- (
  sf_moz
  %>% merge(
    adm1_utci_month,
    by = "adm1_code",
    all.x = TRUE
  )
)
```

```{r}
#| fig-width: 4
#| fig-height: 5
(
  ggplot()
  + geom_sf(
    data = sf_adm1_utci_month %>% filter(adm1_name != "Maputo City"),
    mapping = aes(fill = utci_days_above_32_daily_max),
    color = "black",
  )
  + theme(
    panel.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.background = element_blank(),
    axis.title = element_blank(),
    axis.ticks = element_blank(),
    axis.text = element_blank(),
    plot.title = element_text(size = 16, hjust = 0.5, margin = margin(b = 0)),
    plot.subtitle = element_text(size = 14, hjust = 0.5),
    legend.key.height = unit(50, "pt"),
    legend.title = element_text(size = 16, angle = 90, hjust = 0.5),
    legend.text = element_text(size = 14),
    legend.background = element_blank(),
    legend.title.position = "right",
  )
  + scale_fill_paletteer_c(
    "scico::vik",
    na.value = "transparent",
  )
  + labs(
    title = "Weighted UTCI Index",
    subtitle = "January 2024",
    fill = "# days UTCI max > 32"
  )
)
ggsave(
  path = fig_dir,
  filename = "utci_weighted_moz.png",
  width = 4,
  height = 5
)
```

### Mozambique

```{r}
utci_moz <- build_utci_ts_country("MOZ", rast_pop_moz_2022, adm1_pop_moz_2022, sf_moz)
```

### Zimbabwe

```{r}
utci_zwe <- build_utci_ts_country("ZWE", rast_pop_zwe_2022, adm1_pop_zwe_2022, sf_zwe)
```

### Lesotho

```{r}
utci_lso <- build_utci_ts_country("LSO", rast_pop_lso_2022, adm1_pop_lso_2022, sf_lso)
```

### Namibia

```{r}
utci_nam <- build_utci_ts_country("NAM", rast_pop_nam_2022, adm1_pop_nam_2022, sf_nam)
```

### Zambia

```{r}
utci_zmb <- build_utci_ts_country("ZMB", rast_pop_zmb_2022, adm1_pop_zmb_2022, sf_zmb)
```

### Uganda

```{r}
utci_uga <- build_utci_ts_country("UGA", rast_pop_uga_2022, adm_pop_uga_2022, sf_uga)
```

### Kenya

```{r}
utci_ken <- build_utci_ts_country("KEN", rast_pop_ken_2022, adm_pop_ken_2022, sf_ken)
```
