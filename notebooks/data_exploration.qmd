---
title: "Data Exploration"
format: html
editor: visual
---

# Environment Setup

```{r setup}
library(tidyverse)
library(readxl)
library(sf)
library(patchwork)
library(paletteer)
library(ggtext)
library(scales)

# Set random seed
nb_name <- "Agile 2025 - Data Exploration"
seed <- sum(sapply(str_split(nb_name, pattern = "", simplify = TRUE), FUN = utf8ToInt))

# Folder structure
root <- rprojroot::has_file("agile2025.Rproj")$make_fix_file()
raw_data_dir <- root("data/raw")
proc_data_dir <- root("data/processed")
dir.create(proc_data_dir, showWarnings = FALSE)
fig_dir <- root("figures")
dir.create(fig_dir, showWarnings = FALSE)
```

# Functions

```{r}
clean_column_name <- function(cols) {
  cols <- tolower(cols)
  cols <- gsub("[.,'()]", "", cols)
  cols <- gsub("[$]", "d", cols)
  cols <- gsub("[/]", "_", cols)
  for (i in 1:length(cols)) {
    cols[i] <- paste0(unlist(strsplit(cols[i], " ")), collapse = "_")
  }
  cols
}
```

# Load data

## Geometries

```{r load_data geom}
# Uganda - https://data.humdata.org/dataset/cod-ab-uga

elgon_region <- c(
  "Bududa", 
  "Bukwo",
  "Bulambuli",
  "Kapchorwa",
  "Kween",
  "Manafwa", 
  "Mbale", 
  "Namisindwa",
  "Sironko"
)

sf_uga <- (
  st_read(
    file.path(raw_data_dir, "uga_admbnda_ubos_20200824.gdb", fsep = "/"),
    layer = "uga_admbnda_adm2_ubos_20200824"
  )
  %>% rename_with(tolower)
  %>% select(
    adm1_pcode = admin1pcode,
    adm1_name = admin1name_en,
    adm2_name = admin2name_en,
    geometry = shape
  )
  %>% mutate(
    elgon = ifelse(
      adm2_name %in% elgon_region,
      TRUE, 
      FALSE
    )
  )
)

# Mozambique OCHA - https://data.humdata.org/dataset/cod-ab-moz

sf_ocha_moz <- (
  st_read(
    file.path(raw_data_dir, "moz_adm_20190607b_shp", "moz_admbnda_adm1_ine_20190607.shp", fsep = "/"),
  )
  %>% rename_with(tolower)
  %>% select(
    adm1_pcode,
    adm1_pt, 
    geometry
  )
)

# Mozambique FEWS NET - https://datadryad.org/dataset/doi:10.5061/dryad.vq83bk42w

sf_fewsnet_moz <- (
  st_read(
    file.path(raw_data_dir, "harvestStat", "hvstat_africa_boundary_v1.0.gpkg", fsep = "/"),
    layer = "hvstat_africa_boundary_v1.0"
  )
  %>% filter(
    ADMIN0 == "Mozambique"
  )
  %>% rename_with(tolower)
  %>% select(
    fnid, 
    admin1
  )
)
```

## Population - https://fdw.fews.net/api/cropproductionfacts/?format=csv&cpcv2=R01122AC&indicator=crop:quantity&indicator=crop:yield&indicator=crop:planted&indicator=crop:harvested&country_code=MZ&fields=simple


```{r}
df_population_moz <- (
  read_csv(
    file.path(raw_data_dir, "fews_net_maize_yield_and_production_mozambique.csv", fsep = "/"),
    show_col_types = FALSE
  )
  %>% filter(
    (crop_production_system == "All (PS)")
  )
  %>% mutate(
    year = year(period_date)
  )
  %>% select(
    admin1 = admin_1,
    year,
    population
  )
  %>% distinct()
  %>% arrange(admin1, year)
)
```

```{r}
df_population_moz
```



## DIEM - https://data.humdata.org/dataset/fao-diem-monitoring-system-household-surveys-aggregated-data

https://data-in-emergencies.fao.org/search?q=income


```{r load data diem}

df_diem_shock_uga_new <- (
  read_csv(
    file.path(raw_data_dir, "diem_household_surveys_aggregated_data_income_shocks_and_needs_thematic_areas_sud_kivu_new.csv", fsep = "/"),
    show_col_types = FALSE
  )
   %>% mutate(
    date = as.Date(coll_mid_date, format = "%m/%d/%Y"),
  )
)

df_diem_shock_uga_arc <- (
  read_csv(
    file.path(raw_data_dir, "diem_household_surveys_aggregated_data_income_shocks_and_needs_thematic_areas_sud_kivu_arc.csv", fsep = "/"),
    show_col_types = FALSE
  )
  %>% mutate(
    date = as.Date(`Middle of data collection`, format = "%m/%d/%Y"),
  )
)


df_diem_shock_moz_new <- (
  read_csv(
    file.path(raw_data_dir, "diem_aggregated_data_income_shocks_and_needs_thematic_areas_moz.csv", fsep = "/"),
    show_col_types = FALSE
  )
)

df_diem_shock_moz_arc <- (
  read_csv(
    file.path(raw_data_dir, "diem_aggregated_data_income_shocks_and_needs_thematic_areas_moz_2021.csv", fsep = "/"),
    show_col_types = FALSE
  )
  %>% mutate(
    date = as.Date(`Middle of data collection`, format = "%m/%d/%Y"),
  )
)

df_diem_fs_moz_new <- (
  read_csv(
    file.path(raw_data_dir, "diem_aggregated_data_food_security_thematic_area_moz.csv", fsep = "/"),
    show_col_types = FALSE
  )
)

df_diem_fs_moz_arc <- (
  read_csv(
    file.path(raw_data_dir, "diem_aggregated_data_food_security_thematic_area_moz_2021.csv", fsep = "/"),
    show_col_types = FALSE
  )
)
```

 
## Food Prices


```{r load data food prices}
# WFP - https://data.humdata.org/dataset/global-wfp-food-prices
food_prices_files <- list.files(file.path(raw_data_dir, "wfp_food_prices", fsep = "/"))
list_food_prices <- list()
for (i in seq(length(food_prices_files))) {
  list_food_prices[[i]] <- (
    read_csv(
      file.path(raw_data_dir, "wfp_food_prices", food_prices_files[i], fsep = "/"),
      show_col_types = FALSE
    )
    %>% filter(
    # category == "cereals and tubers"
      pricetype == "Retail",
      !is.na(latitude),
      category %in% c("cereals and tubers", "pulses and nuts", "vegetables and fruits")
    )
    %>% mutate(
      admin2 = str_replace(admin2, " Municipality", "")
    )
  )
}

# FEWS NET - https://fdw.fews.net/api/marketpricefacts/?format=csv&schedule=Weekly&start_date=&end_date=&cpcv2=R01122AC&country_code=MZ&price_type=Retail&product_source=Local&is_active=&fields=simple

df_food_prices_fewsnet_moz_maize <- (
  read_csv(
    file.path(raw_data_dir, "fews_net_maize_prices_mozambique.csv", fsep = "/"),
    show_col_types = FALSE
  )
  %>% mutate(
    date = start_date + 14
  )
  %>% select(
    date,
    admin1 = admin_1,
    admin2 = admin_2,
    market,
    latitude,
    longitude,
    price = value
  )
)
```


## Crop yield and production - https://datadryad.org/dataset/doi:10.5061/dryad.vq83bk42w

```{r load data crop yield}
df_maize_yield_prod <- (
  read_csv(
    file.path(raw_data_dir, "harvestStat", "hvstat_africa_data_v1.0.csv", fsep = "/"),
    show_col_types = FALSE
  )
  %>% filter(
    (product == "Maize")
    & (crop_production_system == "All (PS)")
  )
)
```


## Uganda Violence

```{r}
col_names <- c(
  "dist_id",
  "dist_name",
  "dist_unitcode",
  "dist_unitdesc",
  paste0("sti_", sprintf("%02d", 1:6), "-2025"),
  paste0("ad_", sprintf("%02d", 1:6), "-2025"),
  paste0("inj_", sprintf("%02d", 1:6), "-2025")
)
  
  
df_viol_uga <- (
  read_xlsx(
    file.path(raw_data_dir, "SGBV Data Extract Jan-June Bugisu-Bukedi.xlsx", fsep = "/"),
    sheet = "1",
    col_names = col_names,
    skip = 1
  )
  %>% pivot_longer(
    cols = -c(dist_id, dist_name, dist_unitcode, dist_unitdesc),
    names_to = c("variable", "date"),
    names_sep = "_"
  )
  %>% mutate(
    date = as.Date(paste0("01-", date), format = "%d-%m-%Y"),
    dist_name = str_replace(dist_name, " District", "")
  )
  %>% select(
    dist_name,
    variable,
    date,
    value
  )
)
```


## Uganda Droughts

```{r}
df_alldis_uga <- (
  read_csv(
    file.path(raw_data_dir, "total-number-of-people-affected-by-disasters.csv"),
    show_col_types = FALSE
  )
)
df_drought_uga <- (
  read_csv(
    file.path(raw_data_dir, "total-number-of-people-affected-by-drought.csv"),
    show_col_types = FALSE
  )
)
```


## Uganda Disasters - EM-DAT


```{r}
disaster_list <- c(
  "Storm (General)",
  "Flood (General)",
  "Landslide (wet)",
  "Riverine flood",
  "Drought",
  "Ground movement",
  "Flash flood",
  "Mudslide",
  "Severe weather"
)

df_emdat_uga <- (
  read_xlsx(
    file.path(raw_data_dir, "emdat_uganda_2000_2025.xlsx"),
    sheet = "EM-DAT Data"
  )
  %>% rename_with(clean_column_name)
  %>% mutate(
    start_day = if_else(is.na(start_day), 1, start_day),
    end_day = if_else(is.na(end_day), 1, end_day),
    start_date = make_date(year = start_year, month = start_month, day = start_day),
    end_date = make_date(year = end_year, month = end_month, day = end_day),
    ofda_bha_response = factor(ofda_bha_response, levels = c("Yes", "No")),
    appeal = factor(appeal, levels = c("Yes", "No")),
    declaration = factor(declaration, levels = c("Yes", "No"))
  )
  %>% select(
    disno,
    start_date,
    end_date,
    longitude,
    latitude,
    country,
    admin_units,
    disaster_type,
    disaster_subtype,
    location,
    origin,
    associated_types,
    ofda_bha_response,
    appeal,
    declaration,
    magnitude,
    magnitude_scale,
    total_deaths,
    no_injured,
    no_homeless,
    no_affected,
    total_affected,
    reconstruction_costs_adjusted_000_usd,
    aid_contribution_000_usd,
    insured_damage_adjusted_000_usd,
    total_damage_adjusted_000_usd
  )
  %>% filter(
    disaster_subtype %in% disaster_list
  )
  %>% arrange(
    # ofda_bha_response,
    desc(total_affected)
  )
)
```

```{r}
head(df_emdat_uga)
```


## Meta

### Movements - https://partners.facebook.com/data_for_good/data/640679780696161/about/?partner_id=307300860780730

```{r}
fb_mov_files <- list.files(file.path(raw_data_dir, "Meta/movement_distribution_global_2022-12-01_2025-08-01", fsep = "/"))
list_fb_mov <- list()
for (i in seq(length(fb_mov_files))) {
  list_fb_mov[[i]] <- (
    read_csv(
      file.path(raw_data_dir, "Meta/movement_distribution_global_2022-12-01_2025-08-01", fb_mov_files[i], fsep = "/"),
      show_col_types = FALSE
    )
    %>% filter(
      country == "UGA",
    )
    %>% select(
      date = ds,
      gadm_name,
      dist_cat = home_to_ping_distance_category,
      dist_fraction = distance_category_ping_fraction
    )
  )
}
```

```{r}
df_fb_mov <- (
  bind_rows(list_fb_mov)
  %>% mutate(
    dist_cat_num = case_when(
      dist_cat == "0" ~ 0,
      dist_cat == "(0, 10)" ~ 5,
      dist_cat == "[10, 100)" ~ 50,
      dist_cat == "100+" ~ 100
    ),
    dist = dist_cat_num * dist_fraction
  )
  %>% arrange(gadm_name, date, dist_cat_num)
  %>% group_by(date, gadm_name)
  %>% summarise(
    dist = sum(dist),
    no_mov_prop = ifelse(
      any(dist_cat_num == 0) > 0,
      dist_fraction[dist_cat_num == 0],
      0
    ),
    low_mov_prop = ifelse(
      any((dist_cat_num == 0)|(dist_cat_num == 5)),
      dist_fraction[dist_cat_num == 0] + dist_fraction[dist_cat_num == 5],
      0
    ),
    .groups = "drop"
  )
  %>% mutate(
    dist = zoo::rollmean(dist, k = 14, fill = NA, align = "right"),
    # no_mov_prop = zoo::rollmean(no_mov_prop, k = 14, fill = 0, align = "right"),
    # low_mov_prop = zoo::rollmean(low_mov_prop, k = 14, fill = 0, align = "right")
  )
  %>% na.omit()
  # %>% filter(
  #   date >= "2023-01-01",
  #   date <= "2024-12-31"
  # )
)
```


### Business Activity - https://partners.facebook.com/data_for_good/data/640679780696161/about/?partner_id=307300860780730

```{r}
fb_bus_files_gadm0 <- list.files(file.path(raw_data_dir, "Meta/business_activity_global_2020-03-01_2022-11-29_gadm0", fsep = "/"))
list_fb_bus_gadm0 <- list()
for (i in seq(length(fb_bus_files_gadm0))) {
  list_fb_bus_gadm0[[i]] <- (
    read_csv(
      file.path(raw_data_dir, "Meta/business_activity_global_2020-03-01_2022-11-29_gadm0", fb_bus_files_gadm0[i], fsep = "/"),
      show_col_types = FALSE
    )
    %>% filter(
      country == "UG",
    )
    %>% select(
      date = ds,
      gadm_name,
      business_vertical,
      activity_quantile,
      activity_percentage
    )
  )
}

fb_bus_files_gadm1 <- list.files(file.path(raw_data_dir, "Meta/business_activity_global_2020-03-01_2022-11-29_gadm1", fsep = "/"))
list_fb_bus_gadm1 <- list()
for (i in seq(length(fb_bus_files_gadm1))) {
  list_fb_bus_gadm1[[i]] <- (
    read_csv(
      file.path(raw_data_dir, "Meta/business_activity_global_2020-03-01_2022-11-29_gadm1", fb_bus_files_gadm1[i], fsep = "/"),
      show_col_types = FALSE
    )
    %>% filter(
      country == "UG",
    )
    %>% select(
      date = ds,
      gadm_name,
      business_vertical,
      activity_quantile,
      activity_percentage
    )
  )
}
```

```{r}
df_fb_bus_gadm0 <- (
  bind_rows(list_fb_bus_gadm0)
)

df_fb_bus_gadm1 <- (
  bind_rows(list_fb_bus_gadm1)
)
```




# Data Processing

## DIEM


```{r}

df_diem_shock_uga_new_clean <- (
  df_diem_shock_uga_new
  %>% select(
    date,
    round,
    adm1_pcode,
    adm1_name,
    num_surveys = surveys,
    tot_income_median,
    tot_income_ci_low,
    tot_income_ci_high,
    perc_crop_producers = hh_agricactivity_1,
    perc_female_head = hh_gender_2,
    perc_no_education = hh_education_1,
    perc_married = hh_maritalstat_2,
    perc_prod_and_sale_crops_3_months = income_main_1,
    perc_cold_3_months = shock_coldtemporhail_1,
    perc_drought_3_months = shock_drought_1,
    perc_flood_3_months = shock_flood_1,
    perc_hurricane_3_months = shock_hurricane_1,
    # perc_mvt_restrict_3_months = shock_mvtrestrict_1,
    perc_covid_border_closed_3_months = covid_borderclosed_1,
    perc_covid_stay_at_home_3_months = covid_stayhome_1,
    perc_covid_ban_gathering_3_months = covid_gatherings_1,
    perc_covid_closure_markets_3_months = covid_marketclosed_1
  )
)
df_diem_shock_uga_arc_clean <- (
  df_diem_shock_uga_arc
  %>% select(
    date,
    round,
    adm1_pcode = "Admin 1 PCODE",
    adm1_name = "Admin 1 name",
    num_surveys = "Nb. of households surveyed",
    tot_income_median = "total income - median",
    tot_income_ci_low = "total income - ci low",
    tot_income_ci_high = "total income - ci high",
    perc_crop_producers = "hh agric activity - crop production",
    perc_female_head = "gender head of hh - female",
    perc_no_education = "education head of hh - none",
    perc_married = "marital status head of hh - married",
    perc_prod_and_sale_crops_3_months = "main income - staple crops",
    perc_cold_3_months = "shock - cold temperatures or hail",
    perc_drought_3_months = "shock - drought",
    perc_flood_3_months = "shock - flood",
    perc_hurricane_3_months = "shock - hurricane or cyclone",
    # perc_mvt_restrict_3_months = shock_mvtrestrict_1,
    perc_covid_border_closed_3_months = "covid effect - border closed",
    perc_covid_stay_at_home_3_months = "covid effect - stay at home",
    perc_covid_ban_gathering_3_months = "covid effect - ban on gatherings",
    perc_covid_closure_markets_3_months = "covid effect - closure food markets"
  )
)
  
df_diem_shock_uga <- (
  bind_rows(df_diem_shock_uga_arc_clean, df_diem_shock_uga_new_clean)
  %>% mutate(
    adm1_name = str_to_title(adm1_name),
  )
)

df_diem_shock_moz_new_clean <- (
  df_diem_shock_moz_new
  %>% select(
    date = coll_mid_date,
    round,
    adm1_pcode,
    adm1_name,
    num_surveys = surveys,
    tot_income_median,
    tot_income_ci_low,
    tot_income_ci_high,
    perc_crop_producers = hh_agricactivity_1,
    perc_female_head = hh_gender_2,
    perc_no_education = hh_education_1,
    perc_married = hh_maritalstat_2,
    perc_prod_and_sale_crops_3_months = income_main_1,
    perc_cold_3_months = shock_coldtemporhail_1,
    perc_drought_3_months = shock_drought_1,
    perc_flood_3_months = shock_flood_1,
    perc_hurricane_3_months = shock_hurricane_1,
  )
)
df_diem_shock_moz_arc_clean <- (
  df_diem_shock_moz_arc
  %>% select(
    date,
    round,
    adm1_pcode = "Admin 1 PCODE",
    adm1_name = "Admin 1 name",
    num_surveys = "Nb. of households surveyed",
    tot_income_median = "total income - median",
    tot_income_ci_low = "total income - ci low",
    tot_income_ci_high = "total income - ci high",
    perc_crop_producers = "hh agric activity - crop production",
    perc_female_head = "gender head of hh - female",
    perc_no_education = "education head of hh - none",
    perc_married = "marital status head of hh - married",
    perc_prod_and_sale_crops_3_months = "main income - staple crops",
    perc_cold_3_months = "shock - cold temperatures or hail",
    perc_drought_3_months = "shock - drought",
    perc_flood_3_months = "shock - flood",
    perc_hurricane_3_months = "shock - hurricane or cyclone"
  )
)
  
df_diem_shock_moz <- (
  bind_rows(df_diem_shock_moz_arc_clean, df_diem_shock_moz_new_clean)
  %>% mutate(
    adm1_name = str_to_title(adm1_name),
  )
)
    
df_diem_fs_moz_new_clean <- (
  df_diem_fs_moz_new
  %>% select(
    round,
    adm1_pcode,
    perc_begged_30_days = cs_begged_1,
    perc_borrowed_30_days = cs_borrowed_money_1,
    perc_borrowed_or_help_30_days = cs_borrowed_or_helped_1,
    perc_purc_food_on_credit_30_days = cs_credit_1,
    perc_eat_away_30_days = cs_eat_elsewhere_1,
    perc_migrate_30_days = cs_hh_migration_1,
    perc_illegal_30_days = cs_illegal_1,
    perc_left_school_30days = cs_no_school_1
  )
)

df_diem_fs_moz_arc_clean <- (
  df_diem_fs_moz_arc
  %>% select(
    round,
    adm1_pcode = "Admin 1 PCODE",
    perc_begged_30_days = "cs emergency begged - yes",
    perc_borrowed_30_days = "cs stress borrowed money - yes",
    perc_borrowed_or_help_30_days = "cs stress borrowed or helped - yes",
    perc_purc_food_on_credit_30_days = "cs stress credit - yes",
    perc_eat_away_30_days = "cs stress eat elsewhere - yes",
    perc_migrate_30_days = "cs emergency hh migration - yes",
    perc_illegal_30_days = "cs emergency illegal - yes",
    perc_left_school_30days = "cs crisis - no school - yes"
  )
)

df_diem_fs_moz <- bind_rows(df_diem_fs_moz_arc_clean, df_diem_fs_moz_new_clean)

sf_diem_moz <- (
  sf_ocha_moz
  %>% merge(
    df_diem_shock_moz,
    by = c("adm1_pcode"),
    all.x = TRUE
  )
  %>% merge(
    df_diem_fs_moz,
    by = c("round", "adm1_pcode"),
    all.x = TRUE
  )
)
```

## Food prices

```{r}
sf_food_prices_wfp_uga <- (
  bind_rows(list_food_prices)
  %>% filter(
    countryiso3 == "UGA"
  )
  %>% select(
    date,
    admin1,
    admin2,
    market,
    latitude,
    longitude,
    category,
    commodity,
    unit,
    price
  )
  %>% mutate(
    date = as.Date(date, format = "%Y-%m-%d"),
    latitude = as.numeric(latitude),
    longitude = as.numeric(longitude),
    price = as.numeric(price)
  )
  %>% st_as_sf(
    coords = c("longitude", "latitude"),
    crs = 4326
  )
)

sf_food_prices_wfp_moz <- (
  bind_rows(list_food_prices)
  %>% filter(
    countryiso3 == "MOZ"
  )
  %>% select(
    date,
    admin1,
    admin2,
    market,
    latitude,
    longitude,
    commodity,
    unit,
    price
  )
  %>% mutate(
    date = as.Date(date, format = "%Y-%m-%d"),
    latitude = as.numeric(latitude),
    longitude = as.numeric(longitude),
    price = as.numeric(price)
  )
  %>% st_as_sf(
    coords = c("longitude", "latitude"),
    crs = 4326
  )
)

sf_food_prices_fewsnet_moz_maize <- (
  df_food_prices_fewsnet_moz_maize
  %>% st_as_sf(
    coords = c("longitude", "latitude"),
    crs = 4326
  )
)
```

## Crop yield

```{r}
df_maize_yield_prod_moz <- (
  df_maize_yield_prod
  %>% filter(
    country == "Mozambique"
  )
  %>% mutate(
    date = as.Date(paste0(harvest_year, "-", harvest_month, "-01"), format = "%Y-%m-%d"),
    year = harvest_year,
    admin1 = admin_1
  )
  %>% merge(
    df_population_moz,
    by = c("admin1", "year"),
    all.x = TRUE
  )
  %>% select(
    date,
    fnid,
    admin1,
    area,
    population,
    production,
    yield
  )
  %>% mutate(
    prod_per_person = production / population,
  )
  %>% arrange(
    admin1, date
  )
)
sf_maize_yield_prod_moz <- (
  sf_fewsnet_moz
  %>% merge(
    df_maize_yield_prod_moz,
    by = c("fnid", "admin1"),
    all.x = TRUE
  )
)
```


# Plots

## Mozambique

### Income and shocks Maps

```{r}
#| fig-height: 7
#| fig-width: 10

base_plot <- (
  sf_diem_moz
  %>% filter(round == 7)
  %>% select(
    perc_crop_producers,
    perc_female_head,
    perc_no_education,
    perc_prod_and_sale_crops_3_months,
    perc_drought_3_months,
    perc_flood_3_months
  )
  %>% ggplot()
  + theme(
    panel.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.background = element_blank(),
    axis.title = element_blank(),
    axis.ticks = element_blank(),
    axis.text = element_blank(),
    plot.title = element_text(size = 18),
    legend.key.height = unit(50, "pt"),
    legend.title = element_text(size = 16, angle = 90, hjust = 0.5),
    legend.text = element_text(size = 14),
    legend.background = element_blank(),
    legend.title.position = "right",
  )
)

p1 <- (
  base_plot
  + geom_sf(aes(fill = perc_crop_producers))
  + scale_fill_distiller(
    name = "Crop producers (%)",
    palette = "YlOrBr",
    direction = 1,
    na.value = "white",
  )
  + guides(
    fill = guide_colorbar(barheight = unit(150, "pt"))
  )
)

p2 <- (
  base_plot
  + geom_sf(aes(fill = perc_female_head))
  + scale_fill_distiller(
    name = "Female head of household (%)",
    na.value = "white",
    palette = "BuPu",
    direction = 1
  )
  + guides(
    fill = guide_colorbar(barheight = unit(150, "pt"))
  )
)

p3 <- (
  base_plot
  + geom_sf(aes(fill = perc_no_education))
  + scale_fill_distiller(
    name = "No education (%)",
    na.value = "white",
    palette = "Greys",
    direction = 1
  )
  + guides(
    fill = guide_colorbar(barheight = unit(150, "pt"))
  )
)

p4 <- (
  base_plot
  + geom_sf(aes(fill = perc_prod_and_sale_crops_3_months))
  + scale_fill_distiller(
    name = "Income from crop (%)",
    na.value = "white",
    palette = "Greens",
    direction = 1
  )
  + guides(
    fill = guide_colorbar(barheight = unit(150, "pt"))
  )
)

p5 <- (
  base_plot
  + geom_sf(aes(fill = perc_drought_3_months))
  + scale_fill_distiller(
    name = "Drought in last 3 months (%)",
    palette = "Reds",
    direction = 1,
    na.value = "gray"
  )
  + guides(
    fill = guide_colorbar(barheight = unit(150, "pt"))
  )
)

p6 <- (
  base_plot
  + geom_sf(aes(fill = perc_flood_3_months))
  + scale_fill_distiller(
    name = "Flood in last 3 months (%)",
    palette = "Blues",
    direction = 1,
    na.value = "gray"
  )
  + guides(
    fill = guide_colorbar(barheight = unit(150, "pt"))
  )
)

(
  (p1 + p2 + p3) /
  (p4 + p5 + p6)
  + plot_annotation(
    title = "Mozambique - DIEM Aggregate Survey Data",
    subtitle = "Income and Shocks, October 2024",
    theme = theme(
      plot.title = element_text(size = 20, hjust = 0.5),
      plot.subtitle = element_text(size = 16, hjust = 0.5)
    )
  )
)
ggsave(
  filename = file.path(fig_dir, "diem_income_shocks_moz.png", fsep = "/"),
  width = 10,
  height = 7,
  units = "in"
)
```

### Food Security Maps

```{r}
#| fig-height: 7
#| fig-width: 10

base_plot <- (
  sf_diem_moz
  %>% filter(round == 7)
  %>% select(
    perc_begged_30_days,
    perc_borrowed_30_days,
    perc_migrate_30_days,
    perc_illegal_30_days
  )
  %>% ggplot()
  + theme(
    panel.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.background = element_blank(),
    axis.title = element_blank(),
    axis.ticks = element_blank(),
    axis.text = element_blank(),
    plot.title = element_text(size = 18),
    legend.key.height = unit(50, "pt"),
    legend.title = element_text(size = 16, angle = 90, hjust = 0.5),
    legend.text = element_text(size = 14),
    legend.background = element_blank(),
    legend.title.position = "right",
  )
)

p1 <- (
  base_plot
  + geom_sf(aes(fill = perc_begged_30_days))
  + scale_fill_distiller(
    name = "Begged for food (%)",
    palette = "Greens",
    direction = 1,
    na.value = "white",
  )
  + guides(
    fill = guide_colorbar(barheight = unit(150, "pt"))
  )
)

p2 <- (
  base_plot
  + geom_sf(aes(fill = perc_borrowed_30_days))
  + scale_fill_distiller(
    name = "Borrowed Money (%)",
    na.value = "white",
    palette = "Blues",
    direction = 1
  )
  + guides(
    fill = guide_colorbar(barheight = unit(150, "pt"))
  )
)

p3 <- (
  base_plot
  + geom_sf(aes(fill = perc_migrate_30_days))
  + scale_fill_distiller(
    name = "Migrate (%)",
    na.value = "white",
    palette = "Reds",
    direction = 1
  )
  + guides(
    fill = guide_colorbar(barheight = unit(150, "pt"))
  )
)

p4 <- (
  base_plot
  + geom_sf(aes(fill = perc_illegal_30_days))
  + scale_fill_distiller(
    name = "Illegal activity (%)",
    na.value = "white",
    palette = "Greys",
    direction = 1
  )
  + guides(
    fill = guide_colorbar(barheight = unit(150, "pt"))
  )
)

(
  (p1 + p2 + p3 + p4)
  + plot_annotation(
    title = "Mozambique - DIEM Survey Data",
    subtitle = "Food Insecurity Metrics (last 30 days), October 2024",
    theme = theme(
      plot.title = element_text(size = 20, hjust = 0.5),
      plot.subtitle = element_text(size = 16, hjust = 0.5)
    )
  )
)
ggsave(
  filename = file.path(fig_dir, "diem_food_security_moz.png", fsep = "/"),
  width = 10,
  height = 7,
  units = "in",
  bg = "transparent"
)
```

### Drought and illegal activity over time

```{r}
#| fig-width: 6
#| fig-height: 7
sf_diem_moz_ts <- (
  sf_diem_moz
  %>% group_by(adm1_name)
  %>% mutate(
    max_drought_by_adm = max(perc_drought_3_months, na.rm = TRUE),
    max_illegal_by_adm = max(perc_illegal_30_days, na.rm = TRUE)
  )
  %>% ungroup()
  %>% mutate(
    drought = perc_drought_3_months / max_drought_by_adm,
    illegal = perc_illegal_30_days / max_illegal_by_adm
  )
  %>% select(
    date,
    adm1_name,
    drought,
    illegal
  )
  %>% pivot_longer(
    cols = c(drought, illegal),
    names_to = "variable",
    values_to = "value"
  )
  %>% filter(adm1_name != "Maputo City")
)
min_year <- min(year(sf_diem_moz_ts$date))
max_year <- max(year(sf_diem_moz_ts$date))
years <- seq(min_year, max_year, by = 1)
num_years <- length(years)
(
  ggplot(data = sf_diem_moz_ts)
  + geom_line(
    mapping = aes(x = date, y = value, color = variable),
    linewidth = 1.2
  )
  + geom_point(
    mapping = aes(x = date, y = value, color = variable),
    size = 2
  )
  + facet_wrap(
    ~ adm1_name,
    ncol = 2,
  )
  + theme(
    panel.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(fill = NA, colour = "black", linewidth = 1),
    plot.title = element_markdown(size = 15, hjust = 0.5),
    plot.subtitle = element_markdown(size = 13, hjust = 0.5),
    axis.ticks.length = unit(4, "pt"),
    axis.ticks.y = element_line(linewidth = 1),
    axis.ticks.x = element_line(color = c(rep("black", num_years + 1), rep(NA, num_years + 1))),
    axis.title = element_text(size = 16),
    axis.text.y = element_text(size = 15),
    axis.text.x = element_text(size = 15),
    legend.text = element_text(size = 15),
    legend.title = element_text(size = 16),
    legend.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(size = 12, face = "bold")
    # legend.position = "inside",
    # legend.position.inside = c(0.75, 0.2)
  )
  + scale_x_date(
      breaks = c(as.Date(paste0(c(years, years[length(years)] + 1), "-01-01")), as.Date(paste0(years, "-07-01"))),
      labels = c(rep(c(""), num_years + 1), rep(years)),
      limits = c(as.Date(paste0(years[1], "-01-01")), as.Date(paste0(years[length(years)] + 1, "-01-01")))
  )
  + scale_y_continuous(
    limits = c(0, 1.05),
    breaks = scales::pretty_breaks(n = 3)
  )
  + scale_color_manual(
    values = c("drought" = "firebrick", "illegal" = "slategray"),
    # labels = c("drought" = "", "illegal" = "")
  )
  + labs(
    title = "Respondents reporting impact of",
    subtitle = "<span style='color:firebrick;'>**drought (3 months)**</span> and <span style='color:slategray;'>**illegal activity (1 month)**</span>",
    x = "Date",
    y = "Relative change",
  )
  + guides(
    color = "none"
  )
)
ggsave(
  filename = file.path(fig_dir, "diem_drought_and_illegal_moz.png", fsep = "/"),
  width = 6,
  height = 7,
  units = "in",
  bg = "transparent"
)
```




### Food Prices - WFP

```{r}
(
  sf_food_prices_wfp_moz
  %>% as.data.frame()
  %>% filter(
    # commodity == "Cassava (dry)",
    commodity == "Maize (white)"
    # commodity == "Maize meal"
    # date == max(date, na.rm = TRUE)  # filter for latest date
  )
  %>% group_by(market)
  %>% count()
  %>% arrange(desc(n))
)
```

#### Map



```{r}
sf_food_prices_wfp_moz_maize_latest <- (
  sf_food_prices_wfp_moz
  %>% filter(
    commodity == "Maize (white)",
    # date == max(date, na.rm = TRUE)  # filter for latest date
  )
  %>% group_by(market)
  %>% slice(which.max(date))  # select latest date for each market
)
(
  ggplot()
  + geom_sf(data = sf_ocha_moz, fill = "white", color = "black")
  + geom_sf(
    data = sf_food_prices_wfp_moz_maize_latest,
    # mapping = aes(size = usdprice),
    mapping = aes(color = price),
    size = 4
    # color = "firebrick"
  )
  + scale_color_distiller(
    name = "Maize price (USD/Kg)",
    palette = "YlOrRd",
    direction = 1,
    na.value = "gray"
  )
  + theme(
    panel.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.background = element_blank(),
    axis.title = element_blank(),
    axis.ticks = element_blank(),
    axis.text = element_blank(),
    plot.title = element_text(size = 18),
    legend.key.height = unit(50, "pt"),
    legend.title = element_text(size = 16, angle = 90, hjust = 0.5),
    legend.text = element_text(size = 14),
    legend.background = element_blank(),
    legend.title.position = "right",
  )
)
```

#### By market (markets with most reports)


```{r}
#| fig-width: 9
#| fig-height: 7
sf_food_prices_wfp_moz_top_markets <- (
  sf_food_prices_wfp_moz
  %>% filter(
    (commodity == "Maize (white)")
    # & (date >= "2021-01-01")
  )
  %>% group_by(market)
  %>% filter(n() > 75)
)
min_year <- min(year(sf_food_prices_moz_top_markets$date))
max_year <- max(year(sf_food_prices_moz_top_markets$date))
years <- seq(min_year, max_year, by = 1)
num_years <- length(years)
(
  ggplot(data = sf_food_prices_wfp_moz_top_markets)
  + geom_line(
    mapping = aes(x = date, y = price),
    color = "cornflowerblue",
    linewidth = 1.2
  )
  + geom_point(
    mapping = aes(x = date, y = price),
    color = "cornflowerblue",
    size = 2
  )
  + facet_wrap(
    ~ market,
    ncol = 2,
    # strip.position = "right"
  )
  + theme(
    panel.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(fill = NA, colour = "black", linewidth = 1),
    plot.title = element_text(size = 18, hjust = 0.5),
    plot.subtitle = element_markdown(size = 15, hjust = 0.5),
    axis.ticks.length = unit(4, "pt"),
    axis.ticks.y = element_line(linewidth = 1),
    axis.ticks.x = element_line(color = c(rep("black", num_years + 1), rep(NA, num_years + 1))),
    axis.title = element_text(size = 16),
    axis.text.y = element_text(size = 15),
    axis.text.x = element_text(size = 15, angle = 90, vjust = 0.5),
    legend.text = element_text(size = 15),
    legend.title = element_text(size = 16),
    legend.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(size = 12, face = "bold")
    # legend.position = "inside",
    # legend.position.inside = c(0.75, 0.2)
  )
  # + scale_color_paletteer_d(
  #   palette = "ggthemes::Tableau_10",
  #   name = "Market"
  # )
  + scale_x_date(
      breaks = c(as.Date(paste0(c(years, years[length(years)] + 1), "-01-01")), as.Date(paste0(years, "-07-01"))),
      labels = c(rep(c(""), num_years + 1), rep(years)),
      limits = c(as.Date(paste0(years[1], "-01-01")), as.Date(paste0(years[length(years)] + 1, "-01-01")))
  )
  + labs(
    title = "Mozambique",
    subtitle = "Maize prices by <span style='color:cornflowerblue;'>**market**</span>",
    x = "Date",
    y = "Price (MZN/Kg)",
    color = "Market"
  )
)
```

#### By admin 1 area

```{r}
#| fig-width: 9
#| fig-height: 8
sf_food_prices_wfp_by_adm1 <- (
  sf_food_prices_wfp_moz
  %>% filter(
    (commodity == "Maize (white)")
    & (admin1 != "Maputo")
    # & (date >= "2021-01-01")
  )
  # %>% group_by(market)
  # %>% filter(n() > 60)
  %>% group_by(admin1, date)
  %>% summarise(
    avg_price = mean(price, na.rm = TRUE),
    .groups = "drop"
  )
)
min_year <- min(year(sf_food_prices_wfp_by_adm1$date))
max_year <- max(year(sf_food_prices_wfp_by_adm1$date))
years <- seq(min_year, max_year, by = 1)
num_years <- length(years)
(
  ggplot(data = sf_food_prices_wfp_by_adm1)
  + geom_line(
    mapping = aes(x = date, y = avg_price),
    color = "firebrick",
    linewidth = 1.2,
    alpha = 0.7
  )
  + geom_point(
    mapping = aes(x = date, y = avg_price),
    color = "firebrick",
    size = 2,
    alpha = 0.7
  )
  + facet_wrap(
    ~ admin1,
    ncol = 2,
    scales = "fixed"
  )
  + theme(
    panel.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.spacing = unit(5, "pt"),
    panel.border = element_rect(fill = NA, colour = "black", linewidth = 1),
    plot.title = element_text(size = 18, hjust = 0.5),
    plot.subtitle = element_markdown(size = 15, hjust = 0.5),
    axis.ticks.length = unit(4, "pt"),
    axis.ticks.y = element_line(linewidth = 1),
    axis.ticks.x = element_line(color = c(rep("black", num_years + 1), rep(NA, num_years + 1))),
    axis.title = element_text(size = 16),
    axis.text.y = element_text(size = 15),
    axis.text.x = element_text(size = 15, angle = 90, vjust = 0.5),
    legend.text = element_text(size = 15),
    legend.title = element_text(size = 16),
    legend.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(size = 12, face = "bold")
  )
  + scale_x_date(
      breaks = c(as.Date(paste0(c(years, years[length(years)] + 1), "-01-01")), as.Date(paste0(years, "-07-01"))),
      labels = c(rep(c(""), num_years + 1), rep(years)),
      limits = c(as.Date(paste0(years[1], "-01-01")), as.Date(paste0(years[length(years)] + 1, "-01-01")))
  )
  + labs(
    title = "Mozambique",
    subtitle = "Maize prices by <span style='color:firebrick;'>**admin 1 area**</span>",
    x = "Date", 
    y = "Price (MZN/Kg)",
  )
)
```

### Food Prices - FEWS Net

```{r}
(
  sf_food_prices_fewsnet_moz_maize
  %>% group_by(market)
  %>% count()
  %>% arrange(desc(n))
)
```

#### Map



```{r}
sf_food_prices_fewsnet_moz_maize_latest <- (
  sf_food_prices_fewsnet_moz_maize
  %>% na.omit()
  %>% group_by(market)
  %>% slice(which.max(date))  # select latest date for each market
)
(
  ggplot()
  + geom_sf(data = sf_fewsnet_moz, fill = "white", color = "black")
  + geom_sf(
    data = sf_food_prices_fewsnet_moz_maize_latest,
    mapping = aes(color = price),
    size = 4
  )
  + scale_color_distiller(
    name = "Maize price (MZN/Kg)",
    palette = "YlOrRd",
    direction = 1,
    na.value = "gray"
  )
  + theme(
    panel.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.background = element_blank(),
    axis.title = element_blank(),
    axis.ticks = element_blank(),
    axis.text = element_blank(),
    plot.title = element_text(size = 18),
    legend.key.height = unit(50, "pt"),
    legend.title = element_text(size = 16, angle = 90, hjust = 0.5),
    legend.text = element_text(size = 14),
    legend.background = element_blank(),
    legend.title.position = "right",
  )
)
```

#### By market (sample markets)


```{r}
#| fig-width: 9
#| fig-height: 7
sf_food_prices_fewsnet_moz_sample_markets <- (
  sf_food_prices_fewsnet_moz_maize
  %>% na.omit()
  %>% group_by(market)
  %>% filter(n() > 300)
  %>% ungroup()
  %>% filter(market %in% sample(unique(market), 9))
)
min_year <- min(year(sf_food_prices_fewsnet_moz_sample_markets$date))
max_year <- max(year(sf_food_prices_fewsnet_moz_sample_markets$date))
years <- seq(min_year, max_year, by = 1)
num_years <- length(years)
(
  ggplot(data = sf_food_prices_fewsnet_moz_sample_markets)
  + geom_line(
    mapping = aes(x = date, y = price),
    color = "cornflowerblue",
    linewidth = 1.2
  )
  + geom_point(
    mapping = aes(x = date, y = price),
    color = "cornflowerblue",
    size = 2
  )
  + facet_wrap(
    ~ market,
    ncol = 3,
    # strip.position = "right"
  )
  + theme(
    panel.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(fill = NA, colour = "black", linewidth = 1),
    plot.title = element_text(size = 18, hjust = 0.5),
    plot.subtitle = element_markdown(size = 15, hjust = 0.5),
    axis.ticks.length = unit(4, "pt"),
    axis.ticks.y = element_line(linewidth = 1),
    axis.ticks.x = element_line(color = c(rep("black", num_years + 1), rep(NA, num_years + 1))),
    axis.title = element_text(size = 16),
    axis.text.y = element_text(size = 15),
    axis.text.x = element_text(size = 15, angle = 90, vjust = 0.5),
    legend.text = element_text(size = 15),
    legend.title = element_text(size = 16),
    legend.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(size = 12, face = "bold")
    # legend.position = "inside",
    # legend.position.inside = c(0.75, 0.2)
  )
  # + scale_color_paletteer_d(
  #   palette = "ggthemes::Tableau_10",
  #   name = "Market"
  # )
  + scale_x_date(
      breaks = c(as.Date(paste0(c(years, years[length(years)] + 1), "-01-01")), as.Date(paste0(years, "-07-01"))),
      labels = c(rep(c(""), num_years + 1), rep(years)),
      limits = c(as.Date(paste0(years[1], "-01-01")), as.Date(paste0(years[length(years)] + 1, "-01-01")))
  )
  + labs(
    title = "Mozambique",
    subtitle = "Maize prices by <span style='color:cornflowerblue;'>**market**</span>",
    x = "Date",
    y = "Price (MZN/Kg)",
    color = "Market"
  )
)
```

#### By admin 1 area

```{r}
#| fig-width: 9
#| fig-height: 8
sf_food_prices_fewsnet_maize_by_adm1 <- (
  sf_food_prices_fewsnet_moz_maize
  %>% filter(
    (admin1 != "Maputo")
    & (date >= "2013-01-01")
  )
  %>% group_by(admin1, date)
  %>% summarise(
    avg_price = mean(price, na.rm = TRUE),
    .groups = "drop"
  )
)
min_year <- min(year(sf_food_prices_fewsnet_maize_by_adm1$date))
max_year <- max(year(sf_food_prices_fewsnet_maize_by_adm1$date))
years <- seq(min_year, max_year, by = 1)
num_years <- length(years)
(
  ggplot(data = sf_food_prices_fewsnet_maize_by_adm1)
  + geom_line(
    mapping = aes(x = date, y = avg_price),
    color = "darkorange",
    linewidth = 1.2,
    alpha = 0.7
  )
  + geom_point(
    mapping = aes(x = date, y = avg_price),
    color = "darkorange",
    size = 2,
    alpha = 0.7
  )
  + facet_wrap(
    ~ admin1,
    ncol = 2,
    scales = "fixed"
  )
  + theme(
    panel.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.spacing = unit(5, "pt"),
    panel.border = element_rect(fill = NA, colour = "black", linewidth = 1),
    plot.title = element_text(size = 18, hjust = 0.5),
    plot.subtitle = element_markdown(size = 15, hjust = 0.5),
    axis.ticks.length = unit(4, "pt"),
    axis.ticks.y = element_line(linewidth = 1),
    axis.ticks.x = element_line(color = c(rep("black", num_years + 1), rep(NA, num_years + 1))),
    axis.title = element_text(size = 16),
    axis.text.y = element_text(size = 15),
    axis.text.x = element_text(size = 15, angle = 90, vjust = 0.5),
    legend.text = element_text(size = 15),
    legend.title = element_text(size = 16),
    legend.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(size = 12, face = "bold")
  )
  + scale_x_date(
      breaks = c(as.Date(paste0(c(years, years[length(years)] + 1), "-01-01")), as.Date(paste0(years, "-07-01"))),
      labels = c(rep(c(""), num_years + 1), rep(years)),
      limits = c(as.Date(paste0(years[1], "-01-01")), as.Date(paste0(years[length(years)] + 1, "-01-01")))
  )
  + labs(
    title = "Mozambique - FEWS Net Data",
    subtitle = "<span style='color:darkorange;'>**Maize**</span> prices",
    x = "Date", 
    y = "Price (MZN/Kg)",
  )
)
ggsave(
  filename = file.path(fig_dir, "fewsnet_maize_price_moz.png", fsep = "/"),
  width = 9,
  height = 8,
  units = "in",
  bg = "transparent"
)
```

### Crop Yields


```{r}
#| fig-width: 9
#| fig-height: 9

plot_color <- paletteer_d("MoMAColors::Alkalay2")[4]
sf_maize_prod_moz <- (
  sf_maize_yield_prod_moz
  %>% as.data.frame()
  %>% filter(
    # (admin1 != "Maputo")
    (date >= "2013-01-01")
  )
  %>% select(
    date,
    admin1,
    prod_per_person
  )
  %>% na.omit()
)
min_year <- min(year(sf_maize_prod_moz$date))
max_year <- max(year(sf_maize_prod_moz$date))
years <- seq(min_year, max_year, by = 1)
num_years <- length(years)
(
  ggplot(data = sf_maize_prod_moz)
  + geom_line(
    mapping = aes(x = date, y = prod_per_person),
    color = plot_color,
    linewidth = 1.2,
    alpha = 0.7
  )
  + geom_point(
    mapping = aes(x = date, y = prod_per_person),
    color = plot_color,
    size = 2,
    alpha = 0.7
  )
  + facet_wrap(
    ~ admin1,
    ncol = 2,
    scales = "free_y"
  )
  + theme(
    panel.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.spacing.y = unit(5, "pt"),
    panel.spacing.x = unit(15, "pt"),
    panel.border = element_rect(fill = NA, colour = "black", linewidth = 1),
    plot.title = element_text(size = 18, hjust = 0.5),
    plot.subtitle = element_markdown(size = 15, hjust = 0.5),
    axis.ticks.length = unit(4, "pt"),
    axis.ticks.y = element_line(linewidth = 1),
    axis.ticks.x = element_line(color = c(rep("black", num_years + 1), rep(NA, num_years + 1))),
    axis.title = element_text(size = 16),
    axis.text.y = element_text(size = 15),
    axis.text.x = element_text(size = 15, angle = 90, vjust = 0.5),
    legend.text = element_text(size = 15),
    legend.title = element_text(size = 16),
    legend.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(size = 12, face = "bold")
  )
  + scale_x_date(
      breaks = c(as.Date(paste0(c(years, years[length(years)] + 1), "-01-01")), as.Date(paste0(years, "-07-01"))),
      labels = c(rep(c(""), num_years + 1), rep(years)),
      limits = c(as.Date(paste0(years[1], "-01-01")), as.Date(paste0(years[length(years)] + 1, "-01-01")))
  )
  + scale_y_continuous(
      labels = label_scientific(),
      breaks = pretty_breaks(n = 3)
  )
  + labs(
    title = "Mozambique",
    subtitle = paste0("Maize production per person by <span style='color:", plot_color, ";'>**admin 1 area**</span>"),
    x = "Date", 
    y = "Production (Metric Tons/Person)",
  )
)
```

```{r}
df_maize_yield_prod
```


### Maize Yield and Price over time

```{r}
#| fig-width: 6
#| fig-height: 7

df_food_prices_fewsnet_maize_by_adm1 <- (
  sf_food_prices_fewsnet_maize_by_adm1
  %>% group_by(admin1)
  %>% mutate(
    max_price = max(avg_price, na.rm = TRUE),
  )
  %>% ungroup()
  %>% mutate(
    variable = "Price",
    rel_price = avg_price / max_price,
  )
  %>% as.data.frame
  %>% select(
    admin1,
    date,
    variable,
    value = rel_price
  )
)
    
df_maize_prod_moz <- (
  sf_maize_prod_moz
  %>% group_by(admin1)
  %>% mutate(
    max_prod_per_person = max(prod_per_person, na.rm = TRUE),
  )
  %>% mutate(
    variable = "Yield",
    rel_yield = prod_per_person / max_prod_per_person,
  )
  %>% as.data.frame()
  %>% select(
    admin1,
    date,
    variable,
    value = rel_yield
  )
)

df_maize_price_yield_moz <- (
  df_food_prices_fewsnet_maize_by_adm1
  %>% bind_rows(df_maize_prod_moz)
)
  

min_year <- min(year(df_maize_price_yield_moz$date))
max_year <- max(year(df_maize_price_yield_moz$date))
years <- seq(min_year, max_year, by = 1)
num_years <- length(years)
(
  ggplot(data = df_maize_price_yield_moz)
  + geom_line(
    mapping = aes(x = date, y = value, color = variable),
    linewidth = 1.2
  )
  + geom_point(
    mapping = aes(x = date, y = value, color = variable),
    size = 2
  )
  + facet_wrap(
    ~ admin1,
    ncol = 2,
  )
  + theme(
    panel.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(fill = NA, colour = "black", linewidth = 1),
    plot.title = element_markdown(size = 15, hjust = 0.5),
    plot.subtitle = element_markdown(size = 13, hjust = 0.5),
    axis.ticks.length = unit(4, "pt"),
    axis.ticks.y = element_line(linewidth = 1),
    axis.ticks.x = element_line(color = c(rep("black", num_years + 1), rep(NA, num_years + 1))),
    axis.title = element_text(size = 16),
    axis.text.y = element_text(size = 15),
    axis.text.x = element_text(size = 15),
    legend.text = element_text(size = 15),
    legend.title = element_text(size = 16),
    legend.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(size = 12, face = "bold")
    # legend.position = "inside",
    # legend.position.inside = c(0.75, 0.2)
  )
  + scale_x_date(
      breaks = c(as.Date(paste0(c(years, years[length(years)] + 1), "-01-01")), as.Date(paste0(years, "-07-01"))),
      labels = c(rep(c(""), num_years + 1), rep(years)),
      limits = c(as.Date(paste0(years[1], "-01-01")), as.Date(paste0(years[length(years)] + 1, "-01-01")))
  )
  + scale_y_continuous(
    limits = c(0, 1.05),
    breaks = pretty_breaks(n = 3)
  )
  + scale_color_manual(
    values = c("Yield" = "darkorange", "Price" = "forestgreen"),
  )
  + labs(
    title = "Mozambique - FEWS Net Data",
    subtitle = "Maize <span style='color:darkorange;'>**yield**</span> and <span style='color:forestgreen;'>**price**</span>",
    x = "Date",
    y = "Relative change",
  )
  + guides(
    color = "none"
  )
)
ggsave(
  filename = file.path(fig_dir, "diem_drought_and_illegal_moz.png", fsep = "/"),
  width = 6,
  height = 7,
  units = "in",
  bg = "transparent"
)
```

## Uganda

### Map - Elgon Region

```{r}
#| fig-width: 5
#| fig-height: 5

(
  sf_uga
  %>% ggplot()
   + theme(
    panel.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(),
    plot.background = element_blank(),
    plot.title = element_text(size = 16, hjust = 0.5),
    axis.title = element_blank(),
    axis.ticks = element_blank(),
    axis.text = element_blank(),
    axis.line = element_blank(),
    legend.title = element_text(size = 15, angle = 90, hjust = 0.5),
    legend.title.position = "left",
    legend.text = element_text(size = 13),
    legend.background = element_blank(),
  )
  + geom_sf(
    mapping = aes(fill = elgon),
  )
  + scale_fill_manual(
    name = "Mount Elgon Region",
    values = c("TRUE" = "darkorange", "FALSE" = "whitesmoke"),
  )
  + guides(
    fill = "none"
  )
  + labs(
    title = "Uganda - Mount Elgon Region"
  )
)

ggsave(
  filename = file.path(fig_dir, "uga_map.png", fsep = "/"),
  width = 5,
  height = 5,
  units = "in",
  bg = "transparent"
)
```

###Map - Other regions

```{r}

areas_to_plot <- c("Napak", "Kaabong", "Kotido", "Moroto")

(
  sf_uga
  %>% mutate(
    target_admin = if_else(adm2_name %in% areas_to_plot, TRUE, FALSE)
  )
  %>% ggplot()
  + geom_sf(aes(fill = target_admin), color = "black")
  + scale_fill_manual(
    values = c("TRUE" =  "#dc7726", "FALSE" = "#97DECE")
  )
  + theme(
    panel.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(),
    plot.background = element_blank(),
    plot.title = element_text(size = 16, hjust = 0.5),
    plot.subtitle = element_text(size = 14, hjust = 0.5),
    axis.title = element_blank(),
    axis.ticks = element_blank(),
    axis.text = element_blank(),
    axis.line = element_blank(),
    legend.title = element_text(size = 15, angle = 90, hjust = 0.5),
    legend.title.position = "left",
    legend.text = element_text(size = 13),
    legend.background = element_blank(),
  )
  + guides(
    fill = "none"
  )
  + labs(
    title = "Karamoja Drought - July 2022",
    subtitle = "2400+ deaths, 500k+ affected"
  )
)
ggsave(
  filename = file.path(fig_dir, "karamoja_drought.png", fsep = "/"),
  width = 5,
  height = 5,
  units = "in",
  bg = "transparent"
)
```

### DIEM - Mobility

```{r}
#| fig-width: 5
#| fig-height: 8

min_year <- min(year(df_diem_shock_uga$date))
max_year <- max(year(df_diem_shock_uga$date))
years <- seq(min_year, max_year, by = 1)
num_years <- length(years)

base_plot <- (
  ggplot(data = df_diem_shock_uga)
  + theme(
      panel.background = element_blank(),
      panel.border = element_rect(fill = NA, color = "black", linewidth = 1),
      panel.grid = element_blank(),
      plot.background = element_blank(),
      plot.title = element_text(size = 14, hjust = 0.5),
      axis.title = element_text(size = 14),
      axis.text = element_text(size = 13),
      axis.ticks.x = element_line(color = c(rep("black", num_years + 1), rep(NA, num_years + 1)))
  )
  + scale_x_date(
      breaks = c(as.Date(paste0(c(years, years[length(years)] + 1), "-01-01")), as.Date(paste0(years, "-07-01"))),
      labels = c(rep(c(""), num_years + 1), rep(years)),
      limits = c(as.Date(paste0(years[1], "-01-01")), as.Date(paste0(years[length(years)] + 1, "-01-01")))
  )
)


p1 <- (
  base_plot
  + geom_line(
      aes(x = date, y = perc_covid_border_closed_3_months),
      color = "turquoise4",
      linewidth = 1.2
  )
  + labs(
    x = "Date", 
    y = "Closed Borders"
  )
)

p2 <- (
  base_plot
  + geom_line(
    aes(x = date, y = perc_covid_stay_at_home_3_months),
    color = "turquoise4",
    linewidth = 1.2
  )
  + labs(
    x = "Date",
    y = "Stay at home"
  )
)

p3 <- (
  base_plot
  + geom_line(
    aes(x = date, y = perc_covid_ban_gathering_3_months),
    color = "turquoise4",
    linewidth = 1.2
  )
  + labs(
    x = "Date",
    y = "Banned gathering"
  )
)

p4 <- (
  base_plot
  + geom_line(
    aes(x = date, y = perc_covid_closure_markets_3_months),
    color = "turquoise4",
    linewidth = 1.2
  )
  + labs(
    x = "Date",
    y = "Market Closure"
  )
)


(
  (p1 / p2 / p3 / p4)
  + plot_layout(
    axes = "collect"
  )
)

# ggsave(
#   filename = file.path(img_dir, "model_inputs.png"),
#   width = 6,
#   height = 8,
#   units = "in"
# )
```

### Food Prices - WFP

#### Map locations

```{r}
#| fig-width: 5
#| fig-height: 5

sf_food_prices_wfp_uga_maize_latest <- (
  sf_food_prices_wfp_uga
  %>% filter(
    commodity == "Maize (white)",
    # date == max(date, na.rm = TRUE)  # filter for latest date
  )
  %>% group_by(market)
  %>% slice(which.max(date))  # select latest date for each market
)
(
  ggplot()
  + geom_sf(data = sf_uga, aes(fill = elgon), color = "black")
  + geom_sf(
    data = sf_food_prices_wfp_uga_maize_latest,
    # mapping = aes(size = usdprice),
    color = "dodgerblue",
    size = 5,
  )
  + scale_fill_manual(
    values = c("TRUE" = "salmon", "FALSE" = "whitesmoke")
  )
  + theme(
    panel.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.background = element_blank(),
    axis.title = element_blank(),
    axis.ticks = element_blank(),
    axis.text = element_blank(),
    plot.title = element_text(size = 16, hjust = 0.5),
    plot.subtitle = element_text(size = 14, hjust = 0.5),
    legend.key.height = unit(50, "pt"),
    legend.title = element_text(size = 16, angle = 90, hjust = 0.5),
    legend.text = element_text(size = 14),
    legend.background = element_blank(),
    legend.title.position = "right",
  )
  + guides(
    fill = "none"
  )
  + labs(
    title = "WFP Market Price Data - Uganda",
    subtitle = "Market location"
  )
)
ggsave(
  filename = file.path(fig_dir, "uga_map_market_location.png"),
  height = 5,
  width = 5,
  unit = "in"
)
```

#### Map price

```{r}
sf_food_prices_wfp_uga_maize_latest <- (
  sf_food_prices_wfp_uga
  %>% filter(
    commodity == "Maize (white)",
    # date == max(date, na.rm = TRUE)  # filter for latest date
  )
  %>% group_by(market)
  %>% slice(which.max(date))  # select latest date for each market
)
(
  ggplot()
  + geom_sf(data = sf_uga, aes(fill = elgon), color = "black")
  + geom_sf(
    data = sf_food_prices_wfp_uga_maize_latest,
    # mapping = aes(size = usdprice),
    mapping = aes(color = price),
    size = 5,
    
    # color = "firebrick"
  )
  + scale_color_distiller(
    name = "Maize price (UGX/Kg)",
    palette = "Greens",
    direction = 1,
    na.value = "gray"
  )
  + scale_fill_manual(
    values = c("TRUE" = "orange", "FALSE" = "whitesmoke")
  )
  + theme(
    panel.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.background = element_blank(),
    axis.title = element_blank(),
    axis.ticks = element_blank(),
    axis.text = element_blank(),
    plot.title = element_text(size = 18),
    legend.key.height = unit(50, "pt"),
    legend.title = element_text(size = 16, angle = 90, hjust = 0.5),
    legend.text = element_text(size = 14),
    legend.background = element_blank(),
    legend.title.position = "right",
  )
  + guides(
    fill = "none"
  )
)
```

#### Compare time series

```{r}
(
  sf_food_prices_wfp_uga
  $admin2
  %>% unique()
)
```

##### Elgon Region

```{r}
#| fig-width: 5
#| fig-height: 4

min_year <- min(year(sf_food_prices_wfp_uga$date))
max_year <- max(year(sf_food_prices_wfp_uga$date))
years <- seq(min_year, max_year, by = 1)
num_years <- length(years)

sf_maize_prices_wfp_uga_regions <- (
  sf_food_prices_wfp_uga
  %>% as.data.frame()
  %>% filter(
    commodity == "Maize (white)"
  )
  %>% mutate(
    elgon_region = if_else(
      admin2 %in% elgon_region,
      "Elgon region",
      "Rest of the country"
    )
  )
  %>% mutate(
    elgon_region = factor(elgon_region, c("Rest of the country", "Elgon region"))
  )
  %>% group_by(date, elgon_region)
  %>% summarise(
    price_q07 = quantile(price, probs = 0.07, na.rm = TRUE),
    price_q50 = quantile(price, probs = 0.5, na.rm = TRUE),
    price_q93 = quantile(price, probs = 0.93, na.rm = TRUE)
  )
  %>% ungroup()
)
  
(
  sf_maize_prices_wfp_uga_regions
  %>% ggplot()
  # + geom_line(
  #   aes(x = date, y = price_q50, color = elgon_region, alpha = elgon_region),
  #   linewidth = 1.3
  # )
  + geom_ribbon(
    aes(x = date, ymin = price_q07, ymax = price_q93, fill = elgon_region),
    alpha = 0.5
  )
  + geom_point(
    aes(x = date, y = price_q50, color = elgon_region, alpha = elgon_region),
    size = 2
  )
  + theme(
    panel.background = element_blank(),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 1),
    panel.grid = element_blank(),
    plot.background = element_blank(),
    plot.title = element_text(size = 15, hjust = 0.5),
    plot.subtitle = element_text(size = 13, hjust = 0.5),
    axis.title = element_text(size = 16),
    axis.text.y = element_text(size = 15),
    axis.text.x = element_text(size = 15, angle = 90, vjust = 0.5),
    legend.background = element_blank(),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 13),
    legend.position = "inside",
    legend.position.inside = c(0.25, 0.83),
    axis.ticks.x = element_line(color = c(rep("black", num_years + 1), rep(NA, num_years + 1)))
  )
  + scale_x_date(
      breaks = c(as.Date(paste0(c(years, years[length(years)] + 1), "-01-01")), as.Date(paste0(years, "-07-01"))),
      labels = c(rep(c(""), num_years + 1), rep(years)),
      limits = c(as.Date(paste0(years[1], "-01-01")), as.Date(paste0(years[length(years)] + 1, "-01-01")))
  )
  + scale_color_manual(
    values = c("Elgon region" = "black", "Rest of the country" = "orange"),
  )
  + scale_fill_manual(
    values = c("Elgon region" = "black", "Rest of the country" = "orange"),
  )
  + scale_alpha_manual(
    values = c("Elgon region" = 1, "Rest of the country" = 0.8)
  )
  + labs(
    fill = "Location",
    x = "Date",
    y = "Price (UGX/Kg)",
    subtitle = "Median and 87% interval coverage",
    title = "Uganda - Maize price"
  )
  + guides(
    color = "none",
    alpha = "none",
    fill = guide_legend(override.aes = list(alpha = 1))
  )
)
ggsave(
  filename = file.path(fig_dir, "uganda_maize_price_region.png"),
  width = 5,
  height = 4,
  unit = "in"
)
```

```{r}
(
  sf_maize_prices_wfp_uga_regions
  %>% filter(
    elgon_region == "Elgon region"
  )
)
```


```{r}
(
  sf_maize_prices_wfp_uga_regions
  %>% filter(
    elgon_region == "Elgon region",
    date == "2015-01-15"
  )
)
```

##### Karamoja, 2022 Drough 

```{r}
(
  sf_food_prices_wfp_uga
  %>% as.data.frame()
  %>% filter(
    commodity == "Maize (white)"
  )
  %>% mutate(
    karamoja_region = if_else(
      admin2 %in% areas_to_plot,
      "Affected Areas",
      "Rest of the country"
    )
  )
)
```


```{r}
#| fig-width: 8
#| fig-height: 4

areas_to_plot <- c("Napak", "Kaabong", "Kotido", "Moroto")

min_year <- min(year(sf_food_prices_wfp_uga$date))
max_year <- max(year(sf_food_prices_wfp_uga$date))
years <- seq(min_year, max_year, by = 1)
num_years <- length(years)

sf_maize_prices_wfp_uga_regions <- (
  sf_food_prices_wfp_uga
  %>% as.data.frame()
  %>% filter(
    commodity == "Maize (white)",
    date >= "2021-01-01"
  )
  %>% mutate(
    karamoja_region = if_else(
      admin2 %in% areas_to_plot,
      "Affected Areas",
      "Rest of the country"
    )
  )
  %>% mutate(
    karamoja_region = factor(karamoja_region, c("Rest of the country", "Affected Areas"))
  )
  %>% group_by(date, karamoja_region)
  %>% summarise(
    price_q07 = quantile(price, probs = 0.07, na.rm = TRUE),
    price_q50 = quantile(price, probs = 0.5, na.rm = TRUE),
    price_q93 = quantile(price, probs = 0.93, na.rm = TRUE)
  )
  %>% ungroup()
)

min_year <- min(year(sf_maize_prices_wfp_uga_regions$date))
max_year <- max(year(sf_maize_prices_wfp_uga_regions$date))
years <- seq(min_year, max_year, by = 1)
num_years <- length(years)
  
(
  sf_maize_prices_wfp_uga_regions
  %>% ggplot()
  + geom_ribbon(
    aes(x = date, ymin = price_q07, ymax = price_q93, fill = karamoja_region),
    alpha = 0.5
  )
  + geom_point(
    aes(x = date, y = price_q50, color = karamoja_region, alpha = karamoja_region),
    size = 2
  )
  + theme(
    panel.background = element_blank(),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 1),
    panel.grid = element_blank(),
    plot.background = element_blank(),
    plot.title = element_text(size = 15, hjust = 0.5),
    plot.subtitle = element_text(size = 13, hjust = 0.5),
    axis.title = element_text(size = 16),
    axis.text.y = element_text(size = 15),
    axis.text.x = element_text(size = 15),
    legend.background = element_blank(),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 13),
    # legend.position = "inside",
    # legend.position.inside = c(0.25, 0.83),
    axis.ticks.x = element_line(color = c(rep("black", num_years), rep(NA, num_years + 1)))
  )
  + scale_x_date(
      breaks = c(as.Date(paste0(c(years, years[length(years)] + 1), "-01-01")), as.Date(paste0(years, "-07-01"))),
      labels = c(rep(c(""), num_years + 1), rep(years)),
      limits = c(as.Date(paste0(years[1], "-01-01")), as.Date("2025-07-01"))
  )
  + scale_color_manual(
    values = c("Affected Areas" = "#dc7726", "Rest of the country" = "#97DECE"),
  )
  + scale_fill_manual(
    values = c("Affected Areas" = "#dc7726", "Rest of the country" = "#97DECE"),
  )
  + scale_alpha_manual(
    values = c("Affected Areas" = 1, "Rest of the country" = 0.8)
  )
  + labs(
    fill = "Location",
    x = "Date",
    y = "Price (UGX/Kg)",
    subtitle = "Median and 87% interval coverage",
    title = "Maize price comparison"
  )
  + guides(
    color = "none",
    alpha = "none",
    fill = guide_legend(override.aes = list(alpha = 1))
  )
)
ggsave(
  filename = file.path(fig_dir, "uganda_maize_price_karamoja_2022.png")
)
```

```{r}
#| fig-width: 8
#| fig-height: 8

areas_to_plot <- c("Napak", "Kaabong", "Kotido", "Moroto")
commodities_to_plot <- c("Maize (white)", "Maize flour", "Cassava flour", "Sorghum")

min_year <- min(year(sf_food_prices_wfp_uga$date))
max_year <- max(year(sf_food_prices_wfp_uga$date))
years <- seq(min_year, max_year, by = 1)
num_years <- length(years)

sf_maize_prices_wfp_uga_regions <- (
  sf_food_prices_wfp_uga
  %>% as.data.frame()
  %>% filter(
    # commodity == "Maize (white)",
    commodity %in% commodities_to_plot,
    date >= "2021-01-01"
  )
  %>% mutate(
    karamoja_region = if_else(
      admin2 %in% areas_to_plot,
      "Affected Areas",
      "Rest of the country"
    )
  )
  %>% mutate(
    karamoja_region = factor(karamoja_region, c("Rest of the country", "Affected Areas"))
  )
  %>% group_by(date, karamoja_region, commodity)
  %>% summarise(
    price_q07 = quantile(price, probs = 0.07, na.rm = TRUE),
    price_q50 = quantile(price, probs = 0.5, na.rm = TRUE),
    price_q93 = quantile(price, probs = 0.93, na.rm = TRUE),
    .groups = "drop"
  )
  %>% ungroup()
)

min_year <- min(year(sf_maize_prices_wfp_uga_regions$date))
max_year <- max(year(sf_maize_prices_wfp_uga_regions$date))
years <- seq(min_year, max_year, by = 1)
num_years <- length(years)
  
(
  sf_maize_prices_wfp_uga_regions
  %>% ggplot()
  + geom_ribbon(
    aes(x = date, ymin = price_q07, ymax = price_q93, fill = karamoja_region),
    alpha = 0.5
  )
  + geom_point(
    aes(x = date, y = price_q50, color = karamoja_region, alpha = karamoja_region),
    size = 2
  )
  + facet_wrap(
    ~commodity,
    ncol = 1,
    # strip.position = "right",
    scales = "free_y"
  )
  + theme(
    panel.background = element_blank(),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 1),
    panel.grid = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(size = 15, face = "bold"),
    plot.background = element_blank(),
    plot.title = element_text(size = 15, hjust = 0.5),
    plot.subtitle = element_text(size = 13, hjust = 0.5),
    axis.title = element_text(size = 16),
    axis.text.y = element_text(size = 15),
    axis.text.x = element_text(size = 15),
    legend.background = element_blank(),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 13),
    # legend.position = "inside",
    # legend.position.inside = c(0.25, 0.83),
    axis.ticks.x = element_line(color = c(rep("black", num_years), rep(NA, num_years + 1)))
  )
  + scale_x_date(
      breaks = c(as.Date(paste0(c(years, years[length(years)] + 1), "-01-01")), as.Date(paste0(years, "-07-01"))),
      labels = c(rep(c(""), num_years + 1), rep(years)),
      limits = c(as.Date(paste0(years[1], "-01-01")), as.Date("2025-07-01"))
  )
  + scale_color_manual(
    values = c("Affected Areas" = "#dc7726", "Rest of the country" = "#97DECE"),
  )
  + scale_fill_manual(
    values = c("Affected Areas" = "#dc7726", "Rest of the country" = "#97DECE"),
  )
  + scale_alpha_manual(
    values = c("Affected Areas" = 1, "Rest of the country" = 0.8)
  )
  + labs(
    fill = "Location",
    x = "Date",
    y = "Price (UGX/Kg)",
    subtitle = "Median and 87% interval coverage",
    title = "Maize price comparison"
  )
  + guides(
    color = "none",
    alpha = "none",
    fill = guide_legend(override.aes = list(alpha = 1))
  )
)
ggsave(
  filename = file.path(fig_dir, "uganda_maize_price_karamoja_2022.png")
)
```

### Violence

```{r}
#| fig-width: 6
#| fig-height: 8

(
  ggplot(data = df_viol_uga)
  + geom_line(
    aes(x = date, y = value, color = dist_name),
    linewidth = 1.5
  )
  + facet_wrap(
    ~ variable,
    ncol = 1,
    scales = "free_y"
  )
  + theme(
    panel.background = element_blank(),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 1),
    panel.grid = element_blank(),
    plot.background = element_blank(),
    plot.title = element_text(size = 16, hjust = 0.5),
    axis.title = element_text(size = 14),
    axis.text = element_text(size = 13),
    strip.background = element_blank(),
    strip.text = element_text(size = 14, face = "bold")
    # axis.ticks.x = element_line(color = c(rep("black", num_years + 1), rep(NA, num_years + 1)))
  )
  # + scale_x_date(
  #     breaks = c(as.Date(paste0(c(years, years[length(years)] + 1), "-01-01")), as.Date(paste0(years, "-07-01"))),
  #     labels = c(rep(c(""), num_years + 1), rep(years)),
  #     limits = c(as.Date(paste0(years[1], "-01-01")), as.Date(paste0(years[length(years)] + 1, "-01-01")))
  # )
)
    
    
```

```{r}
#| fig-width: 6
#| fig-height: 8

(
  df_viol_uga
  %>% filter(
    dist_name %in% c("Budaka", "Bududa", "Bukwo", "Mbale"),
    variable == "inj"
  )
  %>% ggplot()
  + geom_line(
    aes(x = date, y = value),
    color = "firebrick",
    linewidth = 1.5
  )
  + facet_wrap(
    ~ dist_name,
    ncol = 1,
    scales = "free_y"
  )
  + theme(
    panel.background = element_blank(),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 1),
    panel.grid = element_blank(),
    plot.background = element_blank(),
    plot.title = element_text(size = 16, hjust = 0.5),
    axis.title = element_text(size = 14),
    axis.text = element_text(size = 13),
    strip.background = element_blank(),
    strip.text = element_text(size = 14, face = "bold"),
    legend.background = element_blank(),
    legend.text = element_text(size = 13),
    legend.title = element_text(size = 14)
  )
  + labs(
    x = "Date",
    y = "Counts",
    title = "Anxiety Disorder due to GBV",
    color = "District"
  )
  # + scale_color_manual(
  + guides(
    color = guide_legend(override.aes = list(linewidth = 3))
  )
)
```

```{r}
#| fig-width: 6
#| fig-height: 8

(
  df_viol_uga
  %>% filter(
    dist_name %in% c("Budaka", "Bududa", "Bukwo", "Mbale"),
    variable == "ad"
  )
  %>% ggplot()
  + geom_line(
    aes(x = date, y = value),
    color = "darkturquoise",
    linewidth = 1.5
  )
  + facet_wrap(
    ~ dist_name,
    ncol = 1,
    scales = "free_y"
  )
  + theme(
    panel.background = element_blank(),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 1),
    panel.grid = element_blank(),
    plot.background = element_blank(),
    plot.title = element_text(size = 16, hjust = 0.5),
    axis.title = element_text(size = 14),
    axis.text = element_text(size = 13),
    strip.background = element_blank(),
    strip.text = element_text(size = 14, face = "bold"),
    legend.background = element_blank(),
    legend.text = element_text(size = 13),
    legend.title = element_text(size = 14)
  )
  + labs(
    x = "Date",
    y = "Counts",
    title = "Injuries due to GBV",
    color = "District"
  )
  # + scale_color_manual(
  + guides(
    color = guide_legend(override.aes = list(linewidth = 3))
  )
)
```

```{r}
#| fig-width: 8
#| fig-height: 6

(
  df_viol_uga
  %>% filter(
    dist_name %in% c("Bududa", "Butaleja", "Mbale", "Mbale City"),
  )
  %>% mutate(
    variable = fct_recode(
      variable,
      !!!c(
        "Anxiety Disorder" = "ad",
        "Sexually Transmitted\nInfections" = "sti",
        "Injury" = "inj"
      )
    )
  )
  %>% ggplot()
  + geom_line(
    aes(x = date, y = value, color = variable),
    linewidth = 1.5
  )
  + facet_grid(
    dist_name ~ variable,
    scales = "free"
  )
  + theme(
    panel.background = element_blank(),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 1),
    panel.grid = element_blank(),
    plot.background = element_blank(),
    plot.title = element_text(size = 18, hjust = 0.5),
    axis.title = element_text(size = 16),
    axis.text.y = element_text(size = 15),
    axis.text.x = element_text(size = 15, angle = 90, vjust = 0.5),
    strip.background = element_blank(),
    strip.text = element_text(size = 14, face = "bold"),
    legend.background = element_blank(),
    legend.text = element_text(size = 13),
    legend.title = element_text(size = 14)
  )
  + labs(
    x = "Date",
    y = "Counts",
    title = "Uganda, Impact of SGBV - 2025",
    color = "District"
  )
  # + scale_color_manual(
    # values = c("ad", 
  + guides(
    color = "none"
  )
)
ggsave(
  filename = file.path(fig_dir, "violence_indicators_uga.png"),
  width = 8,
  height = 6,
  unit = "in"
)
```


### Disasters

```{r}
df_alldis_uga
```


```{r}
#| fig-width: 5
#| fig-height: 5

p1 <- (
  ggplot(data = df_alldis_uga)
  + geom_col(
    aes(x = Year, y = `Number of total people affected by disasters`),
    fill = "gray"
  )
  + theme(
    panel.background = element_blank(),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 1),
    panel.grid = element_blank(),
    plot.background = element_blank(),
    plot.title = element_text(size = 18, hjust = 0.5),
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 15),
    legend.background = element_blank(),
    legend.text = element_text(size = 13),
    legend.title = element_text(size = 14)
  )
  + scale_x_continuous(
    limits = c(1999, 2023)
  )
  + scale_y_continuous(
    limits = c(0, 8e+05)
  )
  + labs(
    x = "Year",
    y = "# People Affected", 
    title = "All disasters"
  )
)

p2 <- (
  ggplot(data = df_drought_uga)
  + geom_col(
    aes(x = Year, y = `Number of total people affected by drought`),
    fill = "cornflowerblue"
  )
  + theme(
    panel.background = element_blank(),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 1),
    panel.grid = element_blank(),
    plot.background = element_blank(),
    plot.title = element_text(size = 18, hjust = 0.5),
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 15),
    legend.background = element_blank(),
    legend.text = element_text(size = 13),
    legend.title = element_text(size = 14)
  )
  + labs(
    x = "Year",
    y = "# People Affected", 
    title = "Droughts"
  )
  + scale_x_continuous(
    limits = c(1999, 2023)
  )
  + scale_y_continuous(
    limits = c(0, 8e+05)
  )
)

(
  p1/p2
  + plot_layout(
    axes = "collect"
  )
    
)

ggsave(
  filename = file.path(fig_dir, "dis_drought_uga.png"),
  width = 5,
  height = 5, 
  unit = "in"
)

```

### Disaster - EM-DAT

```{r}
clean_admins <- function(col) {
  admins <- rep(NA, length(col))
  for (j in 1:length(col)) {
    if (!is.na(col[j])) {
      start_search <- str_locate_all(pattern = "name", col[j])
      start_locs <- unname(start_search[[1]][,2])
      end_search <- str_locate_all(pattern = "adm1_code", col[j])
      end_locs <- unname(end_search[[1]][,1])
      locs <- c()
      for (i in 1:length(start_locs)) {
        if (i == length(start_locs)) {
          new_loc <- substr(col[j], start_locs[i] + 4, nchar(col[j]) - 3)
        } else {
          new_loc <- substr(col[j], start_locs[i] + 4, end_locs[i+1] - 6)
        }
        if (!is.na(new_loc)) {
          locs <- c(locs, new_loc)
        }
      }
    } else {
      locs <- c(NA)
    }
    locs <- paste(locs, collapse = ", ")
    admins[j] <- locs
  }
  admins
}
```


```{r}
df_uga_important_disasters <- (
  df_emdat_uga
  %>% filter(start_date > "2010-01-01")
  %>% mutate(
    admins = clean_admins(admin_units)
  )
  %>% select(
    disno,
    start_date,
    end_date,
    country,
    location,
    # admin_list = admins,
    disaster_type,
    disaster_subtype,
    origin,
    associated_types,
    total_deaths,
    no_injured,
    no_homeless,
    no_affected,
    total_affected,
    aid_contribution_000_usd,
    total_damage_adjusted_000_usd
  )
  %>% arrange(desc(total_affected))
)
```

```{r}
write_csv(df_uga_important_disasters, file = file.path(proc_data_dir, "uganda_relevant_disasters_2010_2025.csv"))
```




### Movement Distribution

```{r}
#| fig-width: 5
#| fig-height: 7


p1 <- (
  df_fb_mov
  %>% filter(gadm_name %in% elgon_region)
  %>% ggplot(aes(x = date, y = dist, color = gadm_name))
  + geom_line()
  + theme_classic()
)
p2 <- (
  df_fb_mov
  %>% filter(gadm_name %in% elgon_region)
  %>% ggplot(aes(x = date, y = low_mov_prop, color = gadm_name))
  + geom_line()
  + theme_classic()
)
p3 <- (
  df_fb_mov
  %>% filter(gadm_name %in% elgon_region)
  %>% ggplot(aes(x = date, y = no_mov_prop, color = gadm_name))
  + geom_line()
  + theme_classic()
)

(
  (p1/p2/p3)
  + plot_layout(
    axes = "collect"
  )
)
```


### Business Activity

```{r}
#| fig-width: 8
#| fig-height: 7

var_to_plot <- "activity_quantile"
if (var_to_plot == "activity_quantile") {
  thresh <- 0.5
  high_lim <- 1.0
} else {
  thresh <- 50
  high_lim <- 130
}
business_to_plot <- c(
  "All",
  "Professional Services",
  "Business & Utility Services",
  "Public Good",
  "Retail"
)

p1 <- (
  df_fb_bus_gadm0
  %>% filter(
    business_vertical %in% business_to_plot
  )
  %>% select(
    date,
    y = var_to_plot,
    business_vertical
  )
  %>% ggplot(
    aes(x = date, y = y)
  )
  + geom_line(color = "turquoise4", linewidth = 1.3)
  + geom_hline(
    yintercept = thresh,
    linewidth = 1,
    linetype = "dashed"
  )
  + facet_wrap(
    ~ business_vertical,
    ncol = 1
  )
  + theme(
    panel.background = element_blank(),
    panel.grid = element_blank(),
    panel.border = element_rect(fill = NA, colour = "black", linewidth = 1.5),
    strip.background = element_blank(),
    strip.text = element_text(size = 15),
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
    axis.title = element_text(size = 15),
    axis.text = element_text(size = 14)
  )
  + scale_y_continuous(limits = c(0, high_lim))
  + guides(
    color = guide_legend(override.aes = list(linewidth = 4))
  )
  + labs(
    x = "Date",
    y = "Activity Quantile",
    title = "Whole Country"
  )
)

p2 <- (
  df_fb_bus_gadm1
  %>% filter(
    business_vertical %in% business_to_plot,
    gadm_name %in% elgon_region
  )
  %>% select(
    date,
    gadm_name,
    y = var_to_plot,
    business_vertical
  )
  %>% ggplot(
    aes(x = date, y = y)
  )
  + geom_line(aes(color = gadm_name), linewidth = 1.3)
  + geom_hline(
    yintercept = thresh,
    linewidth = 1,
    linetype = "dashed"
  )
  + facet_wrap(
    ~ business_vertical,
    ncol = 1
  )
  + theme(
    panel.background = element_blank(),
    panel.grid = element_blank(),
    panel.border = element_rect(fill = NA, colour = "black", linewidth = 1.5),
    strip.background = element_blank(),
    strip.text = element_text(size = 15),
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
    axis.title = element_text(size = 15),
    axis.text = element_text(size = 14)
  )
  + scale_y_continuous(limits = c(0, high_lim))
  + guides(
    color = guide_legend(override.aes = list(linewidth = 4))
  )
  + labs(
    x = "Date",
    y = "Activity Quantile",
    title = "Elgon"
  )
)

(
  (p1 + p2)
  + plot_layout(
    axes = "collect"
  )
)
```