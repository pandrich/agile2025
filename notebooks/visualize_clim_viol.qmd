---
title: "Visualize Climate and Violence"
format: html
editor: visual
---

# Environment Setup

```{r setup}
# Packages
library(tidyverse)
library(sf)
library(patchwork)

# Folder Structure
root <- rprojroot::has_file("agile2025.Rproj")$make_fix_file()
raw_data_dir <- root("data/raw")
proc_data_dir <- root("data/processed")
fig_dir <- root("figures")
dir.create(fig_dir, showWarnings = FALSE)
mod_dir <- root("models")

# Settings
nb_name <-  "Visualize climate-violence dataset - new"
seed <- sum(sapply(str_split(nb_name, pattern = "", simplify = TRUE), FUN = utf8ToInt))
set.seed(seed)
date <- lubridate::today()

# Viz settings
col_palette <- c("#dc7726", "#eebb93", "#ecc046", "#f6e0a3", "#0292b7", "#81c9db", "#35A29F", "#97DECE")
```

# Viz Settings

```{r}
feature_map <- c(
  "log_pop_density" = "Pop. Density (log)",
  "in_school" = "Enrolled in school",
  "work" = "Worked",
  "rural" = "Rural Area",
  "value_utci_days_above_26_daily_max_sum_12m" = "UTCI days max above 26",
  "value_utci_days_above_26_daily_min_sum_12m" = "UTCI days min above 26",
  "value_utci_days_above_32_daily_min_sum_12m" = "UTCI days min above 32",
  "value_utci_days_above_32_daily_max_sum_12m" = "UTCI days max above 32",
  "value_utci_days_above_38_daily_max_sum_12m" = "UTCI days max above 38",
  "value_utci_days_below_0_daily_min_sum_12m" = "UTCI days min below 0",
  "value_utci_days_below_9_daily_max_sum_12m" = "UTCI days max below 9",
  "value_utci_days_below_9_daily_min_sum_12m" = "UTCI days min below 9",
  "value_utci_monthly_max_max_12m" = "Max UTCI max",
  "value_utci_monthly_max_mean_12m" = "Mean UTCI max",
  "value_utci_monthly_min_max_12m" = "Max UTCI low",
  "value_spei_crop_mean_12m" = "Mean SPEI",
  "value_spei_crop_max_12m" = "Max SPEI",
  "value_spei_crop_below_15q_sum_12m" = "SPEI months below 15th quantile",
  "value_spei_crop_above_85q_sum_12m" = "SPEI months above 85th quantile",
  "dev_value_utci_days_above_26_daily_max_sum_12m" = "UTCI days max above 26\n(dev from mean)",
  "dev_value_utci_days_above_26_daily_min_sum_12m" = "UTCI days min above 26\n(dev from mean)",
  "dev_value_utci_days_above_32_daily_max_sum_12m" = "UTCI days max above 32\n(dev from mean)",
  "dev_value_utci_days_above_38_daily_max_sum_12m" = "UTCI days max above 38\n(dev from mean)",
  "dev_value_utci_days_below_0_daily_min_sum_12m" = "UTCI days min below 0\n(dev from mean)",
  "dev_value_utci_days_below_9_daily_max_sum_12m" = "UTCI days max below 9\n(dev from mean)",
  "dev_value_utci_days_below_9_daily_min_sum_12m" = "UTCI days min below 9\n(dev from mean)",
  "dev_value_utci_monthly_max_max_12m" = "Max UTCI high\n(dev from mean)",
  "dev_value_utci_monthly_max_mean_12m" = "Mean UTCI high\n(dev from mean)",
  "dev_value_utci_monthly_min_max_12m" = "Max UTCI low\n(dev from mean)",
  "dev_value_spei_crop_mean_12m" = "Mean SPEI\n(dev from mean)",
  "dev_value_spei_crop_max_12m" = "Max SPEI\n(dev from mean)",
  "dev_value_spei_crop_below_15q_sum_12m" = "SPEI days below 15th quantile\n(dev from mean)",
  "dev_value_spei_crop_above_85q_sum_12m" = "SPEI days above 85th quantile\n(dev from mean)"
)
```

# Import Data

```{r}
df_clim_viol_new <- (
  read_csv(
    file.path(
      proc_data_dir,
      "climate_violence_new_vacs.csv"
    ),
    show_col_types = FALSE
  )
  %>% filter(
    female == 1
  )
)

df_clim_viol_both <- (
  read_csv(
    file.path(
      proc_data_dir,
      "climate_violence_bothaina.csv"
    ),
    show_col_types = FALSE
  )
)
```

# Visualizations

## Group data for plots

### Group by Admin 1 areas

```{r}
df_clim_viol_adm1_new <- (
  df_clim_viol_new
  %>% group_by(country, adm1_name, log_pop_density)
  %>% summarise(
    across(-c(date, cluster, sample_weight), ~ mean(., na.rm = TRUE)),
    n = n(),
    .groups = "drop"
  )
)

df_clim_viol_adm1_both <- (
  df_clim_viol_both
  %>% group_by(country, adm1_name, log_pop_density)
  %>% summarise(
    across(-c(date, cluster, sample_weight), ~ mean(., na.rm = TRUE)),
    n = n(),
    .groups = "drop"
  )
)
```

### Group by cluster

```{r}
df_clim_viol_clus_both <- (
  df_clim_viol_both
  %>% group_by(country, cluster)
  %>% summarise(
    across(-c(date, adm1_name, sample_weight), ~ mean(., na.rm = TRUE)),
    n = n(),
    .groups = "drop"
  )
  %>% mutate(
    value_binned = cut_width(value_utci_days_above_32_daily_max_sum_12m, 5),
    dev_value_binned = cut_width(dev_value_utci_days_above_32_daily_max_sum_12m, 2)
  )
)
```

```{r}
df_clim_viol_clus_both %>% write_csv(file.path(proc_data_dir, paste0("climate_violence_cluster_", date, "_both.csv")))
```

```{r}
df_clim_viol_clus_new <- (
  df_clim_viol_new
  %>% group_by(country, cluster)
  %>% summarise(
    across(-c(date, adm1_name, sample_weight), ~ mean(., na.rm = TRUE)),
    n = n(),
    .groups = "drop"
  )
  %>% mutate(
    value_binned = cut_width(value_utci_days_above_32_daily_max_sum_12m, 5),
    dev_value_binned = cut_width(dev_value_utci_days_above_32_daily_max_sum_12m, 2)
  )
)
```

```{r}
df_clim_viol_clus_new %>% write_csv(file.path(proc_data_dir, paste0("climate_violence_cluster_", date, "_new.csv")))
```

## By administrative area

```{r}
df_viz <- (
  df_clim_viol_adm1_new
  %>% select(
    -c(age)
  )
  %>% pivot_longer(
    cols = -c(country, adm1_name, sv, sv_np, sv_ip),
    names_to = "variable",
    values_to = "value"
  )
)
```

### Mozambique

#### Climate vs Any Sex Violence

```{r}
#| fig-width: 11
#| fig-height: 7.5
(
  ggplot(
    data = (
      df_viz 
      %>% filter(
        country == "Mozambique",
        variable %in% c(
          "value_utci_days_above_32_daily_max_sum_12m",
          "value_utci_monthly_max_mean_12m",
          "value_utci_monthly_max_max_12m",
          "value_spei_mean_12m",
          "value_spei_crop_mean_12m",
          "value_spei_max_12m",
          "value_spei_crop_max_12m",
          "value_spei_below_15q_sum_12m",
          "value_spei_crop_below_15q_sum_12m",
          "value_spei_above_85q_sum_12m",
          "value_spei_crop_above_85q_sum_12m"
        )
      )
      %>% mutate(
        variable = fct_relevel(
          variable,
          c(
           "value_utci_days_above_32_daily_max_sum_12m",
           "value_utci_monthly_max_mean_12m",
           "value_utci_monthly_max_max_12m",
           "value_spei_mean_12m",
           "value_spei_crop_mean_12m",
           "value_spei_max_12m",
           "value_spei_crop_max_12m",
           "value_spei_below_15q_sum_12m",
           "value_spei_crop_below_15q_sum_12m",
           "value_spei_above_85q_sum_12m",
           "value_spei_crop_above_85q_sum_12m"
         )
        )
      )
    ),
    aes(
      x = value,
      y = sv,
      label = adm1_name
    )
  )
  + geom_point(color = col_palette[6], size = 3)
  + geom_text(hjust = -0.1, vjust = 0.3, size = 3.5)
  + theme(
    panel.background = element_blank(),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 1),
    panel.grid = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(size = 14),
    plot.background = element_blank(),
    plot.title = element_text(size = 16),
    plot.margin = margin(t = 0, r = 10, b = 0, l = 10, unit = "pt"),
    axis.ticks = element_line(linewidth = 1),
    axis.ticks.length = unit(4, "pt"),
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 15),
  )
  + facet_wrap(
    ~variable,
    ncol = 3,
    scales = "free_x",
    labeller = as_labeller(feature_map)
  )
  + scale_y_continuous(
    labels = scales::percent,
    expand = expansion(mult = c(0.1, 0.1))
  )
  + scale_x_continuous(
    expand = expansion(mult = c(0.05, 0.45))
  )
  + labs(
    x = NULL,
    y = "Reporting violence",
  )
)
```

#### Climate Dev vs Any Sex Violence

```{r}
#| fig-width: 11
#| fig-height: 7.5
(
  ggplot(
    data = (
      df_viz 
      %>% filter(
        country == "Mozambique",
        variable %in% c(
          "dev_value_utci_days_above_32_daily_max_sum_12m",
          "dev_value_utci_monthly_max_mean_12m",
          "dev_value_utci_monthly_max_max_12m",
          "dev_value_spei_crop_mean_12m",
          "dev_value_spei_crop_max_12m",
          "dev_value_spei_crop_below_15q_sum_12m",
          "dev_value_spei_crop_above_85q_sum_12m"
        )
      )
      %>% mutate(
        variable = fct_relevel(
          variable,
          c(
            "dev_value_utci_days_above_32_daily_max_sum_12m",
            "dev_value_utci_monthly_max_mean_12m",
            "dev_value_utci_monthly_max_max_12m",
            "dev_value_spei_crop_mean_12m",
            "dev_value_spei_crop_max_12m",
            "dev_value_spei_crop_below_15q_sum_12m",
            "dev_value_spei_crop_above_85q_sum_12m"
          )
        )
      )
    ),
    aes(
      x = value,
      y = sv,
      label = adm1_name
    )
  )
  + geom_point(color = col_palette[3], size = 3)
  + geom_text(hjust = -0.1, vjust = 0.3, size = 3.5)
  + theme(
    panel.background = element_blank(),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 1),
    panel.grid = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(size = 14),
    plot.background = element_blank(),
    plot.title = element_text(size = 16),
    plot.margin = margin(t = 0, r = 10, b = 0, l = 10, unit = "pt"),
    axis.ticks = element_line(linewidth = 1),
    axis.ticks.length = unit(4, "pt"),
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 15),
  )
  + facet_wrap(
    ~variable,
    ncol = 3,
    scales = "free_x",
    labeller = as_labeller(feature_map)
  )
  + scale_y_continuous(
    labels = scales::percent,
    expand = expansion(mult = c(0.1, 0.1))
  )
  + scale_x_continuous(
    expand = expansion(mult = c(0.05, 0.45))
  )
  + labs(
    x = NULL,
    y = "Reporting violence",
  )
)
```

#### Climate vs non-partner Sex Violence

```{r}
#| fig-width: 11
#| fig-height: 7.5
(
  ggplot(
    data = (
      df_viz 
      %>% filter(
        country == "Mozambique",
        variable %in% c(
          "value_utci_days_above_32_daily_max_sum_12m",
          "value_utci_monthly_max_mean_12m",
          "value_utci_monthly_max_max_12m",
          "value_spei_crop_mean_12m",
          "value_spei_crop_max_12m",
          "value_spei_crop_below_15q_sum_12m",
          "value_spei_crop_above_85q_sum_12m"
        )
      )
      %>% mutate(
        variable = fct_relevel(
          variable,
          c(
           "value_utci_days_above_32_daily_max_sum_12m",
           "value_utci_monthly_max_mean_12m",
           "value_utci_monthly_max_max_12m",
           "value_spei_crop_mean_12m",
           "value_spei_crop_max_12m",
           "value_spei_crop_below_15q_sum_12m",
           "value_spei_crop_above_85q_sum_12m"
         )
        )
      )
    ),
    aes(
      x = value,
      y = sv_np,
      label = adm1_name
    )
  )
  + geom_point(color = col_palette[6], size = 3)
  + geom_text(hjust = -0.1, vjust = 0.3, size = 3.5)
  + theme(
    panel.background = element_blank(),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 1),
    panel.grid = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(size = 14),
    plot.background = element_blank(),
    plot.title = element_text(size = 16),
    plot.margin = margin(t = 0, r = 10, b = 0, l = 10, unit = "pt"),
    axis.ticks = element_line(linewidth = 1),
    axis.ticks.length = unit(4, "pt"),
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 15),
  )
  + facet_wrap(
    ~variable,
    ncol = 3,
    scales = "free_x",
    labeller = as_labeller(feature_map)
  )
  + scale_y_continuous(
    labels = scales::percent,
    expand = expansion(mult = c(0.1, 0.1))
  )
  + scale_x_continuous(
    expand = expansion(mult = c(0.05, 0.45))
  )
  + labs(
    x = NULL,
    y = "Reporting violence",
  )
)
```

#### Climate Dev vs non-partner Sex Violence

```{r}
#| fig-width: 11
#| fig-height: 7.5
(
  ggplot(
    data = (
      df_viz 
      %>% filter(
        country == "Mozambique",
        variable %in% c(
          "dev_value_utci_days_above_32_daily_max_sum_12m",
          "dev_value_utci_monthly_max_mean_12m",
          "dev_value_utci_monthly_max_max_12m",
          "dev_value_spei_crop_mean_12m",
          "dev_value_spei_crop_max_12m",
          "dev_value_spei_crop_below_15q_sum_12m",
          "dev_value_spei_crop_above_85q_sum_12m"
        )
      )
      %>% mutate(
        variable = fct_relevel(
          variable,
          c(
            "dev_value_utci_days_above_32_daily_max_sum_12m",
            "dev_value_utci_monthly_max_mean_12m",
            "dev_value_utci_monthly_max_max_12m",
            "dev_value_spei_crop_mean_12m",
            "dev_value_spei_crop_max_12m",
            "dev_value_spei_crop_below_15q_sum_12m",
            "dev_value_spei_crop_above_85q_sum_12m"
          )
        )
      )
    ),
    aes(
      x = value,
      y = sv_np,
      label = adm1_name
    )
  )
  + geom_point(color = col_palette[3], size = 3)
  + geom_text(hjust = -0.1, vjust = 0.3, size = 3.5)
  + theme(
    panel.background = element_blank(),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 1),
    panel.grid = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(size = 14),
    plot.background = element_blank(),
    plot.title = element_text(size = 16),
    plot.margin = margin(t = 0, r = 10, b = 0, l = 10, unit = "pt"),
    axis.ticks = element_line(linewidth = 1),
    axis.ticks.length = unit(4, "pt"),
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 15),
  )
  + facet_wrap(
    ~variable,
    ncol = 3,
    scales = "free_x",
    labeller = as_labeller(feature_map)
  )
  + scale_y_continuous(
    labels = scales::percent,
    expand = expansion(mult = c(0.1, 0.1))
  )
  + scale_x_continuous(
    expand = expansion(mult = c(0.05, 0.45))
  )
  + labs(
    x = NULL,
    y = "Reporting violence",
  )
)
```

#### Climate vs intimate partner Sex Violence

```{r}
#| fig-width: 11
#| fig-height: 7.5
(
  ggplot(
    data = (
      df_viz 
      %>% filter(
        country == "Mozambique",
        variable %in% c(
          "value_utci_days_above_32_daily_max_sum_12m",
          "value_utci_monthly_max_mean_12m",
          "value_utci_monthly_max_max_12m",
          "value_spei_crop_mean_12m",
          "value_spei_crop_max_12m",
          "value_spei_crop_below_15q_sum_12m",
          "value_spei_crop_above_85q_sum_12m"
        )
      )
      %>% mutate(
        variable = fct_relevel(
          variable,
          c(
           "value_utci_days_above_32_daily_max_sum_12m",
           "value_utci_monthly_max_mean_12m",
           "value_utci_monthly_max_max_12m",
           "value_spei_crop_mean_12m",
           "value_spei_crop_max_12m",
           "value_spei_crop_below_15q_sum_12m",
           "value_spei_crop_above_85q_sum_12m"
         )
        )
      )
    ),
    aes(
      x = value,
      y = sv_ip,
      label = adm1_name
    )
  )
  + geom_point(color = col_palette[6], size = 3)
  + geom_text(hjust = -0.1, vjust = 0.3, size = 3.5)
  + theme(
    panel.background = element_blank(),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 1),
    panel.grid = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(size = 14),
    plot.background = element_blank(),
    plot.title = element_text(size = 16),
    plot.margin = margin(t = 0, r = 10, b = 0, l = 10, unit = "pt"),
    axis.ticks = element_line(linewidth = 1),
    axis.ticks.length = unit(4, "pt"),
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 15),
  )
  + facet_wrap(
    ~variable,
    ncol = 3,
    scales = "free_x",
    labeller = as_labeller(feature_map)
  )
  + scale_y_continuous(
    labels = scales::percent,
    expand = expansion(mult = c(0.1, 0.1))
  )
  + scale_x_continuous(
    expand = expansion(mult = c(0.05, 0.45))
  )
  + labs(
    x = NULL,
    y = "Reporting violence",
  )
)
```

#### Climate Dev vs intimate partner Sex Violence

```{r}
#| fig-width: 11
#| fig-height: 7.5
(
  ggplot(
    data = (
      df_viz 
      %>% filter(
        country == "Mozambique",
        variable %in% c(
          "dev_value_utci_days_above_32_daily_max_sum_12m",
          "dev_value_utci_monthly_max_mean_12m",
          "dev_value_utci_monthly_max_max_12m",
          "dev_value_spei_crop_mean_12m",
          "dev_value_spei_crop_max_12m",
          "dev_value_spei_crop_below_15q_sum_12m",
          "dev_value_spei_crop_above_85q_sum_12m"
        )
      )
      %>% mutate(
        variable = fct_relevel(
          variable,
          c(
            "dev_value_utci_days_above_32_daily_max_sum_12m",
            "dev_value_utci_monthly_max_mean_12m",
            "dev_value_utci_monthly_max_max_12m",
            "dev_value_spei_crop_mean_12m",
            "dev_value_spei_crop_max_12m",
            "dev_value_spei_crop_below_15q_sum_12m",
            "dev_value_spei_crop_above_85q_sum_12m"
          )
        )
      )
    ),
    aes(
      x = value,
      y = sv_ip,
      label = adm1_name
    )
  )
  + geom_point(color = col_palette[3], size = 3)
  + geom_text(hjust = -0.1, vjust = 0.3, size = 3.5)
  + theme(
    panel.background = element_blank(),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 1),
    panel.grid = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(size = 14),
    plot.background = element_blank(),
    plot.title = element_text(size = 16),
    plot.margin = margin(t = 0, r = 10, b = 0, l = 10, unit = "pt"),
    axis.ticks = element_line(linewidth = 1),
    axis.ticks.length = unit(4, "pt"),
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 15),
  )
  + facet_wrap(
    ~variable,
    ncol = 3,
    scales = "free_x",
    labeller = as_labeller(feature_map)
  )
  + scale_y_continuous(
    labels = scales::percent,
    expand = expansion(mult = c(0.1, 0.1))
  )
  + scale_x_continuous(
    expand = expansion(mult = c(0.05, 0.45))
  )
  + labs(
    x = NULL,
    y = "Reporting violence",
  )
)
```

#### Selected Climate vs non-partner Violence

```{r}
#| fig-width: 5.5
#| fig-height: 5

p1 <- (
  ggplot(
    data = df_clim_viol_adm1_new %>% filter(country == "Mozambique"),
    mapping = aes(
      x = value_utci_days_above_32_daily_max_sum_12m, 
      # y = sv_any_12m_mean,
      y = sv_np,
      label = adm1_name
    )
  )
  # + geom_point(color = "#dc7726", size = 3)
  + geom_point(
    aes(color = rural), 
    size = 3
  )
  + geom_text(hjust = -0.1, vjust = 0.3, size = 3.5)
   + scale_y_continuous(
    labels = scales::percent,
    expand = expansion(mult = c(0.1, 0.1))
  )
  + scale_x_continuous(
    expand = expansion(mult = c(0.05, 0.35))
  )
  + scale_color_viridis_c(
    option = "viridis"
  )
  + theme(
    panel.background = element_blank(),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 1),
    panel.grid = element_blank(),
    panel.spacing.x = unit(25, "pt"),
    strip.background = element_blank(),
    strip.text = element_text(size = 14),
    plot.background = element_blank(),
    plot.title = element_text(size = 16),
    axis.ticks = element_line(linewidth = 1),
    axis.ticks.length = unit(4, "pt"),
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 15),
  )
  + labs(
    x = "# days UTCI max > 32",
    y = "Reporting violence"
  )
)

p2 <- (
  ggplot(
    data = df_clim_viol_adm1_new %>% filter(country == "Mozambique"),
    mapping = aes(
      x = dev_value_utci_days_above_32_daily_max_sum_12m, 
      # y = sv_any_12m_mean,
      y = sv_np,
      label = adm1_name
    )
  )
  # + geom_point(color = "#ecc046", size = 3)
  + geom_point(
    aes(color = rural), 
    size = 3
  )
  + geom_text(hjust = -0.1, vjust = 0.3, size = 3.5)
   + scale_y_continuous(
    labels = scales::percent,
    expand = expansion(mult = c(0.1, 0.1))
  )
  + scale_x_continuous(
    expand = expansion(mult = c(0.05, 0.15))
  )
  + scale_color_viridis_c(
    option = "viridis"
  )
  + theme(
    panel.background = element_blank(),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 1),
    panel.grid = element_blank(),
    # panel.spacing.x = unit(25, "pt"),
    strip.background = element_blank(),
    strip.text = element_text(size = 14),
    plot.background = element_blank(),
    plot.title = element_text(size = 16),
    axis.ticks = element_line(linewidth = 1),
    axis.ticks.length = unit(4, "pt"),
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 15),
  )
  + labs(
    x = "Dev. days UTCI max > 32",
    y = "Reporting violence"
  )
)

(
  (
    p1 
    # / plot_spacer() 
    / p2
  )
  # + plot_layout(
  #   heights = c(0.48, 0.04, 0.48)
  # )
)

ggsave(
  path = fig_dir,
  filename = "utci_max_above_32_value_vs_dev_moz.png",
)
```

#### All Covariates

```{r}
#| fig-width: 11
#| fig-height: 7.5
(
  ggplot(
    data = (
      df_viz 
      %>% filter(
        country == "Mozambique",
        variable %in% c(
          # "child_mar",
          # "married",
          # "food_insec",
          # "no_education",
          # "poor",
          # "vpoor",
          "rural",
          "in_school", 
          "work",
          "live_with_mother",
          "live_with_father",
          "live_with_partner",
          "men_sex_control",
          "tolerate_women_violence",
          "sexexpl",
          "log_pop_density"
        )
      )
      %>% mutate(
        variable = fct_relevel(
          variable,
         c(
           # "child_mar",
           # "married",
           # "food_insec",
           # "no_education",
           # "school_enrol",
           # "poor",
           # "vpoor",
           "rural",
           "in_school", 
           "work",
           "live_with_mother",
           "live_with_father",
           "live_with_partner",
           "men_sex_control",
           "tolerate_women_violence",
           "sexexpl",
           "log_pop_density"
          )
        )
      )
    ),
    aes(
      x = value,
      # y = sv_any_12m_mean,
      y = sv_np,
      label = adm1_name
    )
  )
  + geom_point(color = "skyblue", size = 3)
  + geom_text(hjust = -0.1, vjust = 0.3, size = 3.5)
  + theme(
    panel.background = element_blank(),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 1),
    panel.grid = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(size = 14),
    plot.background = element_blank(),
    plot.title = element_text(size = 16),
    plot.margin = margin(t = 0, r = 10, b = 0, l = 10, unit = "pt"),
    axis.ticks = element_line(linewidth = 1),
    axis.ticks.length = unit(4, "pt"),
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 15),
  )
  + facet_wrap(
    ~variable,
    ncol = 3,
    scales = "free_x",
    # labeller = as_labeller(feature_map)
  )
  + scale_y_continuous(
    labels = scales::percent,
    expand = expansion(mult = c(0.1, 0.1))
  )
  + scale_x_continuous(
    expand = expansion(mult = c(0.05, 0.45))
  )
  + labs(
    x = NULL,
    y = "Reporting violence",
  )
)
```

#### Selected Covariate vs Violence

```{r}
#| fig-width: 9
#| fig-height: 5

p1 <- (
  ggplot(
    data = df_clim_viol_adm1 %>% filter(country == "Mozambique"),
    mapping = aes(
      x = child_mar, 
      y = sv_np,
      label = adm1_name
    )
  )
  + geom_point(color = "#35A29F", size = 3)
  + geom_text(hjust = -0.1, vjust = 0.3, size = 3.5)
   + scale_y_continuous(
    labels = scales::percent,
    expand = expansion(mult = c(0.1, 0.1))
  )
  + scale_x_continuous(
    expand = expansion(mult = c(0.05, 0.35))
  )
  + theme(
    panel.background = element_blank(),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 1),
    panel.grid = element_blank(),
    panel.spacing.x = unit(25, "pt"),
    strip.background = element_blank(),
    strip.text = element_text(size = 14),
    plot.background = element_blank(),
    plot.title = element_text(size = 16),
    axis.ticks = element_line(linewidth = 1),
    axis.ticks.length = unit(4, "pt"),
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 15),
  )
  + labs(
    x = "Proportion married as child",
    y = "Reporting violence"
  )
)

p2 <- (
  ggplot(
    data = df_utci_viol_adm1 %>% filter(country == "Mozambique"),
    mapping = aes(
      x = no_education, 
      y = sv_any_12m_mean,
      label = adm1_name
    )
  )
  + geom_point(color = "#35A29F", size = 3)
  + geom_text(hjust = -0.1, vjust = 0.3, size = 3.5)
   + scale_y_continuous(
    labels = scales::percent,
    expand = expansion(mult = c(0.1, 0.1))
  )
  + scale_x_continuous(
    expand = expansion(mult = c(0.05, 0.3))
  )
  + theme(
    panel.background = element_blank(),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 1),
    panel.grid = element_blank(),
    # panel.spacing.x = unit(25, "pt"),
    strip.background = element_blank(),
    strip.text = element_text(size = 14),
    plot.background = element_blank(),
    plot.title = element_text(size = 16),
    axis.ticks = element_line(linewidth = 1),
    axis.ticks.length = unit(4, "pt"),
    axis.title.x = element_text(size = 16),
    axis.title.y = element_blank(),
    axis.text.x = element_text(size = 15),
    axis.text.y = element_blank()
  )
  + labs(
    x = "Proportion lacking education",
    y = "Reporting violence"
  )
)

p3 <- (
  ggplot(
    data = df_utci_viol_adm1 %>% filter(country == "Mozambique"),
    mapping = aes(
      x = poor, 
      y = sv_any_12m_mean,
      label = adm1_name
    )
  )
  + geom_point(color = "#35A29F", size = 3)
  + geom_text(hjust = -0.1, vjust = 0.3, size = 3.5)
   + scale_y_continuous(
    labels = scales::percent,
    expand = expansion(mult = c(0.1, 0.1))
  )
  + scale_x_continuous(
    expand = expansion(mult = c(0.05, 0.38))
  )
  + theme(
    panel.background = element_blank(),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 1),
    panel.grid = element_blank(),
    # panel.spacing.x = unit(25, "pt"),
    strip.background = element_blank(),
    strip.text = element_text(size = 14),
    plot.background = element_blank(),
    plot.title = element_text(size = 16),
    axis.ticks = element_line(linewidth = 1),
    axis.ticks.length = unit(4, "pt"),
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 15),
  )
  + labs(
    x = "Proportion in poverty",
    y = "Reporting violence"
  )
)

p4 <- (
  ggplot(
    data = df_utci_viol_adm1 %>% filter(country == "Mozambique"),
    mapping = aes(
      x = log_pop_density, 
      y = sv_any_12m_mean,
      label = adm1_name
    )
  )
  + geom_point(color = "#35A29F", size = 3)
  + geom_text(hjust = -0.1, vjust = 0.3, size = 3.5)
   + scale_y_continuous(
    labels = scales::percent,
    expand = expansion(mult = c(0.1, 0.1))
  )
  + scale_x_continuous(
    expand = expansion(mult = c(0.05, 0.3))
  )
  + theme(
    panel.background = element_blank(),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 1),
    panel.grid = element_blank(),
    # panel.spacing.x = unit(25, "pt"),
    strip.background = element_blank(),
    strip.text = element_text(size = 14),
    plot.background = element_blank(),
    plot.title = element_text(size = 16),
    axis.ticks = element_line(linewidth = 1),
    axis.ticks.length = unit(4, "pt"),
    axis.title.x = element_text(size = 16),
    axis.title.y = element_blank(),
    axis.text.x = element_text(size = 15),
    axis.text.y = element_blank()
  )
  + labs(
    x = "Population density (log)",
    y = "Reporting violence"
  )
)

(
  (p1 + p2)
  # / plot_spacer()
  / (p3 + p4)
  # + plot_layout(
  #   heights = c(0.49, 0.02, 0.49)
  # )
)

ggsave(
  path = fig_dir,
  filename = "cov_vs_viol_moz.png",
)
```

### Zimbabwe

#### UTCI

```{r}
#| fig-width: 9
#| fig-height: 5

(
  df_clim_adm1_roll
  %>% filter(
    date > "2010-01-01",
    date < "2025-01-01",
    country == "Zimbabwe",
    # !(adm1_name %in% c("Tete", "Zambezia"))
  )
  %>% select(
    date,
    adm1_name,
    utci_days_above_32_daily_max,
  )
  %>% ggplot(
    mapping = aes(x = date, y = utci_days_above_32_daily_max)
  )
  + geom_line(
    color = "#0292b7",
    linewidth = 1.3
  )
  + facet_wrap(
    ~ adm1_name,
    ncol = 3
  )
  + theme(
    panel.background = element_blank(),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 1),
    panel.grid = element_blank(),
    panel.spacing.x = unit(25, "pt"),
    strip.background = element_blank(),
    strip.text = element_text(size = 14),
    plot.background = element_blank(),
    plot.title = element_text(size = 16),
    plot.margin = margin(t = 0, r = 20, b = 0, l = 10, unit = "pt"),
    axis.ticks = element_line(linewidth = 1),
    axis.ticks.length = unit(4, "pt"),
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 15),
  )
  + labs(
    x = "Date",
    y = "# days UTCI max > 32 (month)"
  )
)
ggsave(
  path = fig_dir,
  filename = "utci_max_above_32_month_zwe.png",
  width = 9,
  height = 5
)
```

```{r}
#| fig-width: 9
#| fig-height: 5

(
  df_clim_adm1_roll
  %>% filter(
    date > "2010-01-01",
    date < "2025-01-01",
    country == "Zimbabwe",
  )
  %>% select(
    date,
    adm1_name,
    utci_days_above_32_daily_max_sum_12m,
  )
  %>% ggplot(
    mapping = aes(x = date, y = utci_days_above_32_daily_max_sum_12m)
  )
  + geom_line(
    color = "#dc7726",
    linewidth = 1.3
  )
  + facet_wrap(
    ~ adm1_name,
    ncol = 3
  )
  + theme(
    panel.background = element_blank(),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 1),
    panel.grid = element_blank(),
    panel.spacing.x = unit(25, "pt"),
    strip.background = element_blank(),
    strip.text = element_text(size = 14),
    plot.background = element_blank(),
    plot.title = element_text(size = 16),
    plot.margin = margin(t = 0, r = 20, b = 0, l = 10, unit = "pt"),
    axis.ticks = element_line(linewidth = 1),
    axis.ticks.length = unit(4, "pt"),
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 15),
  )
  + labs(
    x = "Date",
    y = "# days UTCI max > 32 (year)"
  )
)
ggsave(
  path = fig_dir,
  filename = "utci_max_above_32_year_zwe.png",
  width = 9,
  height = 5
)
```

```{r}
#| fig-width: 9
#| fig-height: 5

(
  df_clim_adm1_roll_dev
  %>% filter(
    date > "2010-01-01",
    date < "2025-01-01",
    country == "Zimbabwe",
  )
  %>% select(
    date,
    adm1_name,
    dev_value_utci_days_above_32_daily_max_sum_12m,
  )
  %>% ggplot(
    mapping = aes(x = date, y = dev_value_utci_days_above_32_daily_max_sum_12m)
  )
  + geom_line(
    color = "#ecc046",
    linewidth = 1.3
  )
  + facet_wrap(
    ~ adm1_name,
    ncol = 3
  )
  + theme(
    panel.background = element_blank(),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 1),
    panel.grid = element_blank(),
    panel.spacing.x = unit(25, "pt"),
    strip.background = element_blank(),
    strip.text = element_text(size = 14),
    plot.background = element_blank(),
    plot.title = element_text(size = 16),
    plot.margin = margin(t = 0, r = 20, b = 0, l = 10, unit = "pt"),
    axis.ticks = element_line(linewidth = 1),
    axis.ticks.length = unit(4, "pt"),
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 15),
  )
  + labs(
    x = "Date",
    y = "# days UTCI max > 32 (dev. from mean year)"
  )
)
ggsave(
  path = fig_dir,
  filename = "dev_utci_max_above_32_year_zwe.png",
  width = 9,
  height = 5
)
```

#### Climate vs Violence

```{r}
#| fig-width: 11
#| fig-height: 7.5
(
  ggplot(
    data = (
      df_viz 
      %>% filter(
        country == "Zimbabwe",
        variable %in% c(
          "value_utci_days_above_26_daily_max_sum_12m",
          "value_utci_days_above_26_daily_min_sum_12m",
          "value_utci_days_above_32_daily_max_sum_12m",
          "value_utci_days_above_38_daily_max_sum_12m",
          "value_utci_days_below_0_daily_min_sum_12m",
          "value_utci_days_below_9_daily_max_sum_12m",
          "value_utci_days_below_9_daily_min_sum_12m",
          "value_utci_monthly_max_max_12m",
          "value_utci_monthly_min_max_12m"
        )
      )
      %>% mutate(
        variable = fct_relevel(
          variable,
          c(
           "value_utci_days_above_26_daily_max_sum_12m",
           "value_utci_days_above_26_daily_min_sum_12m",
           "value_utci_days_above_32_daily_max_sum_12m",
           "value_utci_days_above_38_daily_max_sum_12m",
           "value_utci_days_below_0_daily_min_sum_12m",
           "value_utci_days_below_9_daily_max_sum_12m",
           "value_utci_days_below_9_daily_min_sum_12m",
           "value_utci_monthly_max_max_12m",
           "value_utci_monthly_min_max_12m"
         )
        )
      )
    ),
    aes(
      x = value,
      y = sv_any_12m_mean,
      label = adm1_name
    )
  )
  + geom_point(color = "skyblue", size = 3)
  + geom_text(hjust = -0.1, vjust = 0.3, size = 3.5)
  + theme(
    panel.background = element_blank(),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 1),
    panel.grid = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(size = 14),
    plot.background = element_blank(),
    plot.title = element_text(size = 16),
    plot.margin = margin(t = 0, r = 10, b = 0, l = 10, unit = "pt"),
    axis.ticks = element_line(linewidth = 1),
    axis.ticks.length = unit(4, "pt"),
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 15),
  )
  + facet_wrap(
    ~variable,
    ncol = 3,
    scales = "free_x",
    labeller = as_labeller(feature_map)
  )
  + scale_y_continuous(
    labels = scales::percent,
    expand = expansion(mult = c(0.1, 0.1))
  )
  + scale_x_continuous(
    expand = expansion(mult = c(0.05, 0.45))
  )
  + labs(
    x = NULL,
    y = "Reporting violence",
  )
)
```

#### All UTCI Dev vs Violence

```{r}
#| fig-width: 11
#| fig-height: 7.5
(
  ggplot(
    data = (
      df_viz 
      %>% filter(
        country == "Zimbabwe",
        variable %in% c(
          "dev_value_utci_days_above_26_daily_max_sum_12m",
          "dev_value_utci_days_above_26_daily_min_sum_12m",
          "dev_value_utci_days_above_32_daily_max_sum_12m",
          "dev_value_utci_days_above_38_daily_max_sum_12m",
          "dev_value_utci_days_below_0_daily_min_sum_12m",
          "dev_value_utci_days_below_9_daily_max_sum_12m",
          "dev_value_utci_days_below_9_daily_min_sum_12m",
          "dev_value_utci_monthly_max_max_12m",
          "dev_value_utci_monthly_min_max_12m"
        )
      )
      %>% mutate(
        variable = fct_relevel(
          variable,
          c(
           "dev_value_utci_days_above_26_daily_max_sum_12m",
           "dev_value_utci_days_above_26_daily_min_sum_12m",
           "dev_value_utci_days_above_32_daily_max_sum_12m",
           "dev_value_utci_days_above_38_daily_max_sum_12m",
           "dev_value_utci_days_below_0_daily_min_sum_12m",
           "dev_value_utci_days_below_9_daily_max_sum_12m",
           "dev_value_utci_days_below_9_daily_min_sum_12m",
           "dev_value_utci_monthly_max_max_12m",
           "dev_value_utci_monthly_min_max_12m"
         )
        )
      )
    ),
    aes(
      x = value,
      y = sv_any_12m_mean,
      label = adm1_name
    )
  )
  + geom_point(color = "skyblue", size = 3)
  + geom_text(hjust = -0.1, vjust = 0.3, size = 3.5)
  + theme(
    panel.background = element_blank(),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 1),
    panel.grid = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(size = 14),
    plot.background = element_blank(),
    plot.title = element_text(size = 16),
    plot.margin = margin(t = 0, r = 10, b = 0, l = 10, unit = "pt"),
    axis.ticks = element_line(linewidth = 1),
    axis.ticks.length = unit(4, "pt"),
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 15),
  )
  + facet_wrap(
    ~variable,
    ncol = 3,
    scales = "free_x",
    labeller = as_labeller(feature_map)
  )
  + scale_y_continuous(
    labels = scales::percent,
    expand = expansion(mult = c(0.1, 0.1))
  )
  + scale_x_continuous(
    expand = expansion(mult = c(0.05, 0.45))
  )
  + labs(
    x = NULL,
    y = "Reporting violence",
  )
)
```

#### Selected UTCI vs Violence

```{r}
#| fig-width: 5.5
#| fig-height: 5

p1 <- (
  ggplot(
    data = df_utci_viol_adm1 %>% filter(country == "Zimbabwe"),
    mapping = aes(
      x = value_utci_days_above_32_daily_max_sum_12m, 
      y = sv_any_12m_mean,
      label = adm1_name
    )
  )
  + geom_point(color = "#dc7726", size = 3)
  + geom_text(hjust = -0.1, vjust = 0.3, size = 3.5)
   + scale_y_continuous(
    labels = scales::percent,
    expand = expansion(mult = c(0.1, 0.1))
  )
  + scale_x_continuous(
    expand = expansion(mult = c(0.05, 0.45))
  )
  + theme(
    panel.background = element_blank(),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 1),
    panel.grid = element_blank(),
    panel.spacing.x = unit(25, "pt"),
    strip.background = element_blank(),
    strip.text = element_text(size = 14),
    plot.background = element_blank(),
    plot.title = element_text(size = 16),
    axis.ticks = element_line(linewidth = 1),
    axis.ticks.length = unit(4, "pt"),
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 15),
  )
  + labs(
    x = "# days UTCI max > 32",
    y = "Reporting violence"
  )
)

p2 <- (
  ggplot(
    data = df_utci_viol_adm1 %>% filter(country == "Zimbabwe"),
    mapping = aes(
      x = dev_value_utci_days_above_32_daily_max_sum_12m, 
      y = sv_any_12m_mean,
      label = adm1_name
    )
  )
  + geom_point(color = "#ecc046", size = 3)
  + geom_text(hjust = -0.1, vjust = 0.3, size = 3.5)
   + scale_y_continuous(
    labels = scales::percent,
    expand = expansion(mult = c(0.1, 0.1))
  )
  + scale_x_continuous(
    expand = expansion(mult = c(0.05, 0.2))
  )
  + theme(
    panel.background = element_blank(),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 1),
    panel.grid = element_blank(),
    # panel.spacing.x = unit(25, "pt"),
    strip.background = element_blank(),
    strip.text = element_text(size = 14),
    plot.background = element_blank(),
    plot.title = element_text(size = 16),
    axis.ticks = element_line(linewidth = 1),
    axis.ticks.length = unit(4, "pt"),
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 15),
  )
  + labs(
    x = "Dev. days UTCI max > 32",
    y = "Reporting violence"
  )
)

(
  (
    p1 
    # / plot_spacer() 
    / p2
  )
  # + plot_layout(
  #   heights = c(0.48, 0.04, 0.48)
  # )
)

ggsave(
  path = fig_dir,
  filename = "utci_max_above_32_value_vs_dev_zwe.png",
)
```

#### All Covariates

```{r}
#| fig-width: 11
#| fig-height: 7.5
(
  ggplot(
    data = (
      df_viz 
      %>% filter(
        country == "Zimbabwe",
        variable %in% c(
          "child_mar",
          "married",
          "food_insec",
          "no_education",
          "poor",
          "vpoor",
          "rural",
          "school_enrol",
          "log_pop_density"
        )
      )
      %>% mutate(
        variable = fct_relevel(
          variable,
         c(
           "child_mar",
           "married",
           "food_insec",
           "no_education",
           "school_enrol",
           "poor",
           "vpoor",
           "rural",
           "log_pop_density"
          )
        )
      )
    ),
    aes(
      x = value,
      y = sv_any_12m_mean,
      label = adm1_name
    )
  )
  + geom_point(color = "skyblue", size = 3)
  + geom_text(hjust = -0.1, vjust = 0.3, size = 3.5)
  + theme(
    panel.background = element_blank(),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 1),
    panel.grid = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(size = 14),
    plot.background = element_blank(),
    plot.title = element_text(size = 16),
    plot.margin = margin(t = 0, r = 10, b = 0, l = 10, unit = "pt"),
    axis.ticks = element_line(linewidth = 1),
    axis.ticks.length = unit(4, "pt"),
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 15),
  )
  + facet_wrap(
    ~variable,
    ncol = 3,
    scales = "free_x",
    labeller = as_labeller(feature_map)
  )
  + scale_y_continuous(
    labels = scales::percent,
    expand = expansion(mult = c(0.1, 0.1))
  )
  + scale_x_continuous(
    expand = expansion(mult = c(0.05, 0.45))
  )
  + labs(
    x = NULL,
    y = "Reporting violence",
  )
)
```

#### Selected Covariate vs Violence

```{r}
#| fig-width: 9
#| fig-height: 5

p1 <- (
  ggplot(
    data = df_utci_viol_adm1 %>% filter(country == "Zimbabwe"),
    mapping = aes(
      x = child_mar, 
      y = sv_any_12m_mean,
      label = adm1_name
    )
  )
  + geom_point(color = "#35A29F", size = 3)
  + geom_text(hjust = -0.1, vjust = 0.3, size = 3.5)
   + scale_y_continuous(
    labels = scales::percent,
    expand = expansion(mult = c(0.1, 0.1))
  )
  + scale_x_continuous(
    expand = expansion(mult = c(0.05, 0.62))
  )
  + theme(
    panel.background = element_blank(),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 1),
    panel.grid = element_blank(),
    panel.spacing.x = unit(25, "pt"),
    strip.background = element_blank(),
    strip.text = element_text(size = 14),
    plot.background = element_blank(),
    plot.title = element_text(size = 16),
    axis.ticks = element_line(linewidth = 1),
    axis.ticks.length = unit(4, "pt"),
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 15),
  )
  + labs(
    x = "Proportion married as child",
    y = "Reporting violence"
  )
)

p2 <- (
  ggplot(
    data = df_utci_viol_adm1 %>% filter(country == "Zimbabwe"),
    mapping = aes(
      x = no_education, 
      y = sv_any_12m_mean,
      label = adm1_name
    )
  )
  + geom_point(color = "#35A29F", size = 3)
  + geom_text(hjust = -0.1, vjust = 0.3, size = 3.5)
   + scale_y_continuous(
    labels = scales::percent,
    expand = expansion(mult = c(0.1, 0.1))
  )
  + scale_x_continuous(
    expand = expansion(mult = c(0.05, 0.2))
  )
  + theme(
    panel.background = element_blank(),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 1),
    panel.grid = element_blank(),
    # panel.spacing.x = unit(25, "pt"),
    strip.background = element_blank(),
    strip.text = element_text(size = 14),
    plot.background = element_blank(),
    plot.title = element_text(size = 16),
    axis.ticks = element_line(linewidth = 1),
    axis.ticks.length = unit(4, "pt"),
    axis.title.x = element_text(size = 16),
    axis.title.y = element_blank(),
    axis.text.x = element_text(size = 15),
    axis.text.y = element_blank()
  )
  + labs(
    x = "Proportion lacking education",
    y = "Reporting violence"
  )
)

p3 <- (
  ggplot(
    data = df_utci_viol_adm1 %>% filter(country == "Zimbabwe"),
    mapping = aes(
      x = poor, 
      y = sv_any_12m_mean,
      label = adm1_name
    )
  )
  + geom_point(color = "#35A29F", size = 3)
  + geom_text(hjust = -0.1, vjust = 0.3, size = 3.5)
   + scale_y_continuous(
    labels = scales::percent,
    expand = expansion(mult = c(0.1, 0.1))
  )
  + scale_x_continuous(
    expand = expansion(mult = c(0.05, 0.25))
  )
  + theme(
    panel.background = element_blank(),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 1),
    panel.grid = element_blank(),
    # panel.spacing.x = unit(25, "pt"),
    strip.background = element_blank(),
    strip.text = element_text(size = 14),
    plot.background = element_blank(),
    plot.title = element_text(size = 16),
    axis.ticks = element_line(linewidth = 1),
    axis.ticks.length = unit(4, "pt"),
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 15),
  )
  + labs(
    x = "Proportion in poverty",
    y = "Reporting violence"
  )
)

p4 <- (
  ggplot(
    data = df_utci_viol_adm1 %>% filter(country == "Zimbabwe"),
    mapping = aes(
      x = log_pop_density, 
      y = sv_any_12m_mean,
      label = adm1_name
    )
  )
  + geom_point(color = "#35A29F", size = 3)
  + geom_text(hjust = -0.1, vjust = 0.3, size = 3.5)
   + scale_y_continuous(
    labels = scales::percent,
    expand = expansion(mult = c(0.1, 0.1))
  )
  + scale_x_continuous(
    expand = expansion(mult = c(0.05, 0.2))
  )
  + theme(
    panel.background = element_blank(),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 1),
    panel.grid = element_blank(),
    # panel.spacing.x = unit(25, "pt"),
    strip.background = element_blank(),
    strip.text = element_text(size = 14),
    plot.background = element_blank(),
    plot.title = element_text(size = 16),
    axis.ticks = element_line(linewidth = 1),
    axis.ticks.length = unit(4, "pt"),
    axis.title.x = element_text(size = 16),
    axis.title.y = element_blank(),
    axis.text.x = element_text(size = 15),
    axis.text.y = element_blank()
  )
  + labs(
    x = "Population density (log)",
    y = "Reporting violence"
  )
)

(
  (p1 + p2)
  # / plot_spacer()
  / (p3 + p4)
  # + plot_layout(
  #   heights = c(0.49, 0.02, 0.49)
  # )
)

ggsave(
  path = fig_dir,
  filename = "cov_vs_viol_zwe.png",
)
```

### Lesotho

#### UTCI

```{r}
#| fig-width: 9
#| fig-height: 5

(
  df_utci_adm1_roll
  %>% filter(
    date > "2010-01-01",
    date < "2025-01-01",
    country == "Lesotho",
  )
  %>% select(
    date,
    adm1_name,
    utci_days_above_32_daily_max,
  )
  %>% ggplot(
    mapping = aes(x = date, y = utci_days_above_32_daily_max)
  )
  + geom_line(
    color = "#0292b7",
    linewidth = 1.3
  )
  + facet_wrap(
    ~ adm1_name,
    ncol = 3
  )
  + theme(
    panel.background = element_blank(),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 1),
    panel.grid = element_blank(),
    panel.spacing.x = unit(25, "pt"),
    strip.background = element_blank(),
    strip.text = element_text(size = 14),
    plot.background = element_blank(),
    plot.title = element_text(size = 16),
    plot.margin = margin(t = 0, r = 20, b = 0, l = 10, unit = "pt"),
    axis.ticks = element_line(linewidth = 1),
    axis.ticks.length = unit(4, "pt"),
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 15),
  )
  + labs(
    x = "Date",
    y = "# days UTCI max > 32 (month)"
  )
)
ggsave(
  path = fig_dir,
  filename = "utci_max_above_32_month_lso.png",
  width = 9,
  height = 5
)
```

```{r}
#| fig-width: 9
#| fig-height: 5

(
  df_utci_adm1_roll
  %>% filter(
    date > "2010-01-01",
    date < "2025-01-01",
    country == "Lesotho",
  )
  %>% select(
    date,
    adm1_name,
    utci_days_above_32_daily_max_sum_12m,
  )
  %>% ggplot(
    mapping = aes(x = date, y = utci_days_above_32_daily_max_sum_12m)
  )
  + geom_line(
    color = "#dc7726",
    linewidth = 1.3
  )
  + facet_wrap(
    ~ adm1_name,
    ncol = 3
  )
  + theme(
    panel.background = element_blank(),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 1),
    panel.grid = element_blank(),
    panel.spacing.x = unit(25, "pt"),
    strip.background = element_blank(),
    strip.text = element_text(size = 14),
    plot.background = element_blank(),
    plot.title = element_text(size = 16),
    plot.margin = margin(t = 0, r = 20, b = 0, l = 10, unit = "pt"),
    axis.ticks = element_line(linewidth = 1),
    axis.ticks.length = unit(4, "pt"),
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 15),
  )
  + labs(
    x = "Date",
    y = "# days UTCI max > 32 (year)"
  )
)
ggsave(
  path = fig_dir,
  filename = "utci_max_above_32_year_lso.png",
  width = 9,
  height = 5
)
```

```{r}
#| fig-width: 9
#| fig-height: 5

(
  df_utci_adm1_roll_dev
  %>% filter(
    date > "2010-01-01",
    date < "2025-01-01",
    country == "Lesotho",
  )
  %>% select(
    date,
    adm1_name,
    dev_value_utci_days_above_32_daily_max_sum_12m,
  )
  %>% ggplot(
    mapping = aes(x = date, y = dev_value_utci_days_above_32_daily_max_sum_12m)
  )
  + geom_line(
    color = "#ecc046",
    linewidth = 1.3
  )
  + facet_wrap(
    ~ adm1_name,
    ncol = 3
  )
  + theme(
    panel.background = element_blank(),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 1),
    panel.grid = element_blank(),
    panel.spacing.x = unit(25, "pt"),
    strip.background = element_blank(),
    strip.text = element_text(size = 14),
    plot.background = element_blank(),
    plot.title = element_text(size = 16),
    plot.margin = margin(t = 0, r = 20, b = 0, l = 10, unit = "pt"),
    axis.ticks = element_line(linewidth = 1),
    axis.ticks.length = unit(4, "pt"),
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 15),
  )
  + labs(
    x = "Date",
    y = "# days UTCI max > 32 (dev. from mean year)"
  )
)
ggsave(
  path = fig_dir,
  filename = "dev_utci_max_above_32_year_lso.png",
  width = 9,
  height = 5
)
```

#### All UTCI vs Violence

```{r}
#| fig-width: 11
#| fig-height: 7.5
(
  ggplot(
    data = (
      df_viz 
      %>% filter(
        country == "Lesotho",
        variable %in% c(
          "value_utci_days_above_26_daily_max_sum_12m",
          "value_utci_days_above_26_daily_min_sum_12m",
          "value_utci_days_above_32_daily_max_sum_12m",
          "value_utci_days_above_38_daily_max_sum_12m",
          "value_utci_days_below_0_daily_min_sum_12m",
          "value_utci_days_below_9_daily_max_sum_12m",
          "value_utci_days_below_9_daily_min_sum_12m",
          "value_utci_monthly_max_max_12m",
          "value_utci_monthly_min_max_12m"
        )
      )
      %>% mutate(
        variable = fct_relevel(
          variable,
          c(
           "value_utci_days_above_26_daily_max_sum_12m",
           "value_utci_days_above_26_daily_min_sum_12m",
           "value_utci_days_above_32_daily_max_sum_12m",
           "value_utci_days_above_38_daily_max_sum_12m",
           "value_utci_days_below_0_daily_min_sum_12m",
           "value_utci_days_below_9_daily_max_sum_12m",
           "value_utci_days_below_9_daily_min_sum_12m",
           "value_utci_monthly_max_max_12m",
           "value_utci_monthly_min_max_12m"
         )
        )
      )
    ),
    aes(
      x = value,
      y = sv_any_12m_mean,
      label = adm1_name
    )
  )
  + geom_point(color = "skyblue", size = 3)
  + geom_text(hjust = -0.1, vjust = 0.3, size = 3.5)
  + theme(
    panel.background = element_blank(),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 1),
    panel.grid = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(size = 14),
    plot.background = element_blank(),
    plot.title = element_text(size = 16),
    plot.margin = margin(t = 0, r = 10, b = 0, l = 10, unit = "pt"),
    axis.ticks = element_line(linewidth = 1),
    axis.ticks.length = unit(4, "pt"),
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 15),
  )
  + facet_wrap(
    ~variable,
    ncol = 3,
    scales = "free_x",
    labeller = as_labeller(feature_map)
  )
  + scale_y_continuous(
    labels = scales::percent,
    expand = expansion(mult = c(0.1, 0.1))
  )
  + scale_x_continuous(
    expand = expansion(mult = c(0.05, 0.45))
  )
  + labs(
    x = NULL,
    y = "Reporting violence",
  )
)
```

#### All UTCI Dev vs Violence

```{r}
#| fig-width: 11
#| fig-height: 7.5
(
  ggplot(
    data = (
      df_viz 
      %>% filter(
        country == "Lesotho",
        variable %in% c(
          "dev_value_utci_days_above_26_daily_max_sum_12m",
          "dev_value_utci_days_above_26_daily_min_sum_12m",
          "dev_value_utci_days_above_32_daily_max_sum_12m",
          "dev_value_utci_days_above_38_daily_max_sum_12m",
          "dev_value_utci_days_below_0_daily_min_sum_12m",
          "dev_value_utci_days_below_9_daily_max_sum_12m",
          "dev_value_utci_days_below_9_daily_min_sum_12m",
          "dev_value_utci_monthly_max_max_12m",
          "dev_value_utci_monthly_min_max_12m"
        )
      )
      %>% mutate(
        variable = fct_relevel(
          variable,
          c(
           "dev_value_utci_days_above_26_daily_max_sum_12m",
           "dev_value_utci_days_above_26_daily_min_sum_12m",
           "dev_value_utci_days_above_32_daily_max_sum_12m",
           "dev_value_utci_days_above_38_daily_max_sum_12m",
           "dev_value_utci_days_below_0_daily_min_sum_12m",
           "dev_value_utci_days_below_9_daily_max_sum_12m",
           "dev_value_utci_days_below_9_daily_min_sum_12m",
           "dev_value_utci_monthly_max_max_12m",
           "dev_value_utci_monthly_min_max_12m"
         )
        )
      )
    ),
    aes(
      x = value,
      y = sv_any_12m_mean,
      label = adm1_name
    )
  )
  + geom_point(color = "skyblue", size = 3)
  + geom_text(hjust = -0.1, vjust = 0.3, size = 3.5)
  + theme(
    panel.background = element_blank(),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 1),
    panel.grid = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(size = 14),
    plot.background = element_blank(),
    plot.title = element_text(size = 16),
    plot.margin = margin(t = 0, r = 10, b = 0, l = 10, unit = "pt"),
    axis.ticks = element_line(linewidth = 1),
    axis.ticks.length = unit(4, "pt"),
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 15),
  )
  + facet_wrap(
    ~variable,
    ncol = 3,
    scales = "free_x",
    labeller = as_labeller(feature_map)
  )
  + scale_y_continuous(
    labels = scales::percent,
    expand = expansion(mult = c(0.1, 0.1))
  )
  + scale_x_continuous(
    expand = expansion(mult = c(0.05, 0.45))
  )
  + labs(
    x = NULL,
    y = "Reporting violence",
  )
)
```

#### Selected UTCI vs Violence

```{r}
#| fig-width: 5.5
#| fig-height: 5

p1 <- (
  ggplot(
    data = df_utci_viol_adm1 %>% filter(country == "Lesotho"),
    mapping = aes(
      x = value_utci_days_above_32_daily_max_sum_12m, 
      y = sv_any_12m_mean,
      label = adm1_name
    )
  )
  + geom_point(color = "#dc7726", size = 3)
  + geom_text(hjust = -0.1, vjust = 0.3, size = 3.5)
   + scale_y_continuous(
    labels = scales::percent,
    expand = expansion(mult = c(0.1, 0.1))
  )
  + scale_x_continuous(
    expand = expansion(mult = c(0.05, 0.15))
  )
  + theme(
    panel.background = element_blank(),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 1),
    panel.grid = element_blank(),
    panel.spacing.x = unit(25, "pt"),
    strip.background = element_blank(),
    strip.text = element_text(size = 14),
    plot.background = element_blank(),
    plot.title = element_text(size = 16),
    axis.ticks = element_line(linewidth = 1),
    axis.ticks.length = unit(4, "pt"),
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 15),
  )
  + labs(
    x = "# days UTCI max > 32",
    y = "Reporting violence"
  )
)

p2 <- (
  ggplot(
    data = df_utci_viol_adm1 %>% filter(country == "Lesotho"),
    mapping = aes(
      x = dev_value_utci_days_above_32_daily_max_sum_12m, 
      y = sv_any_12m_mean,
      label = adm1_name
    )
  )
  + geom_point(color = "#ecc046", size = 3)
  + geom_text(hjust = -0.1, vjust = 0.3, size = 3.5)
   + scale_y_continuous(
    labels = scales::percent,
    expand = expansion(mult = c(0.1, 0.1))
  )
  + scale_x_continuous(
    expand = expansion(mult = c(0.05, 0.15))
  )
  + theme(
    panel.background = element_blank(),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 1),
    panel.grid = element_blank(),
    # panel.spacing.x = unit(25, "pt"),
    strip.background = element_blank(),
    strip.text = element_text(size = 14),
    plot.background = element_blank(),
    plot.title = element_text(size = 16),
    axis.ticks = element_line(linewidth = 1),
    axis.ticks.length = unit(4, "pt"),
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 15),
  )
  + labs(
    x = "Dev. days UTCI max > 32",
    y = "Reporting violence"
  )
)

(
  (
    p1 
    # / plot_spacer() 
    / p2
  )
  # + plot_layout(
  #   heights = c(0.48, 0.04, 0.48)
  # )
)

ggsave(
  path = fig_dir,
  filename = "utci_max_above_32_value_vs_dev_lso.png",
)
```

#### All Covariates

```{r}
#| fig-width: 11
#| fig-height: 7.5
(
  ggplot(
    data = (
      df_viz 
      %>% filter(
        country == "Lesotho",
        variable %in% c(
          "child_mar",
          "married",
          "food_insec",
          "no_education",
          "poor",
          "vpoor",
          "rural",
          "school_enrol",
          "log_pop_density"
        )
      )
      %>% mutate(
        variable = fct_relevel(
          variable,
         c(
           "child_mar",
           "married",
           "food_insec",
           "no_education",
           "school_enrol",
           "poor",
           "vpoor",
           "rural",
           "log_pop_density"
          )
        )
      )
    ),
    aes(
      x = value,
      y = sv_any_12m_mean,
      label = adm1_name
    )
  )
  + geom_point(color = "skyblue", size = 3)
  + geom_text(hjust = -0.1, vjust = 0.3, size = 3.5)
  + theme(
    panel.background = element_blank(),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 1),
    panel.grid = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(size = 14),
    plot.background = element_blank(),
    plot.title = element_text(size = 16),
    plot.margin = margin(t = 0, r = 10, b = 0, l = 10, unit = "pt"),
    axis.ticks = element_line(linewidth = 1),
    axis.ticks.length = unit(4, "pt"),
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 15),
  )
  + facet_wrap(
    ~variable,
    ncol = 3,
    scales = "free_x",
    labeller = as_labeller(feature_map)
  )
  + scale_y_continuous(
    labels = scales::percent,
    expand = expansion(mult = c(0.1, 0.1))
  )
  + scale_x_continuous(
    expand = expansion(mult = c(0.05, 0.45))
  )
  + labs(
    x = NULL,
    y = "Reporting violence",
  )
)
```

#### Selected Covariate vs Violence

```{r}
#| fig-width: 9
#| fig-height: 5

p1 <- (
  ggplot(
    data = df_utci_viol_adm1 %>% filter(country == "Lesotho"),
    mapping = aes(
      x = child_mar, 
      y = sv_any_12m_mean,
      label = adm1_name
    )
  )
  + geom_point(color = "#35A29F", size = 3)
  + geom_text(hjust = -0.1, vjust = 0.3, size = 3.5)
   + scale_y_continuous(
    labels = scales::percent,
    expand = expansion(mult = c(0.1, 0.1))
  )
  + scale_x_continuous(
    expand = expansion(mult = c(0.05, 0.32))
  )
  + theme(
    panel.background = element_blank(),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 1),
    panel.grid = element_blank(),
    panel.spacing.x = unit(25, "pt"),
    strip.background = element_blank(),
    strip.text = element_text(size = 14),
    plot.background = element_blank(),
    plot.title = element_text(size = 16),
    axis.ticks = element_line(linewidth = 1),
    axis.ticks.length = unit(4, "pt"),
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 15),
  )
  + labs(
    x = "Proportion married as child",
    y = "Reporting violence"
  )
)

p2 <- (
  ggplot(
    data = df_utci_viol_adm1 %>% filter(country == "Lesotho"),
    mapping = aes(
      x = no_education, 
      y = sv_any_12m_mean,
      label = adm1_name
    )
  )
  + geom_point(color = "#35A29F", size = 3)
  + geom_text(hjust = -0.1, vjust = 0.3, size = 3.5)
   + scale_y_continuous(
    labels = scales::percent,
    expand = expansion(mult = c(0.1, 0.1))
  )
  + scale_x_continuous(
    expand = expansion(mult = c(0.05, 0.17))
  )
  + theme(
    panel.background = element_blank(),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 1),
    panel.grid = element_blank(),
    # panel.spacing.x = unit(25, "pt"),
    strip.background = element_blank(),
    strip.text = element_text(size = 14),
    plot.background = element_blank(),
    plot.title = element_text(size = 16),
    axis.ticks = element_line(linewidth = 1),
    axis.ticks.length = unit(4, "pt"),
    axis.title.x = element_text(size = 16),
    axis.title.y = element_blank(),
    axis.text.x = element_text(size = 15),
    axis.text.y = element_blank()
  )
  + labs(
    x = "Proportion lacking education",
    y = "Reporting violence"
  )
)

p3 <- (
  ggplot(
    data = df_utci_viol_adm1 %>% filter(country == "Lesotho"),
    mapping = aes(
      x = poor, 
      y = sv_any_12m_mean,
      label = adm1_name
    )
  )
  + geom_point(color = "#35A29F", size = 3)
  + geom_text(hjust = -0.1, vjust = 0.3, size = 3.5)
   + scale_y_continuous(
    labels = scales::percent,
    expand = expansion(mult = c(0.1, 0.1))
  )
  + scale_x_continuous(
    expand = expansion(mult = c(0.05, 0.3))
  )
  + theme(
    panel.background = element_blank(),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 1),
    panel.grid = element_blank(),
    # panel.spacing.x = unit(25, "pt"),
    strip.background = element_blank(),
    strip.text = element_text(size = 14),
    plot.background = element_blank(),
    plot.title = element_text(size = 16),
    axis.ticks = element_line(linewidth = 1),
    axis.ticks.length = unit(4, "pt"),
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 15),
  )
  + labs(
    x = "Proportion in poverty",
    y = "Reporting violence"
  )
)

p4 <- (
  ggplot(
    data = df_utci_viol_adm1 %>% filter(country == "Lesotho"),
    mapping = aes(
      x = log_pop_density, 
      y = sv_any_12m_mean,
      label = adm1_name
    )
  )
  + geom_point(color = "#35A29F", size = 3)
  + geom_text(hjust = -0.1, vjust = 0.3, size = 3.5)
   + scale_y_continuous(
    labels = scales::percent,
    expand = expansion(mult = c(0.1, 0.1))
  )
  + scale_x_continuous(
    expand = expansion(mult = c(0.05, 0.17))
  )
  + theme(
    panel.background = element_blank(),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 1),
    panel.grid = element_blank(),
    # panel.spacing.x = unit(25, "pt"),
    strip.background = element_blank(),
    strip.text = element_text(size = 14),
    plot.background = element_blank(),
    plot.title = element_text(size = 16),
    axis.ticks = element_line(linewidth = 1),
    axis.ticks.length = unit(4, "pt"),
    axis.title.x = element_text(size = 16),
    axis.title.y = element_blank(),
    axis.text.x = element_text(size = 15),
    axis.text.y = element_blank()
  )
  + labs(
    x = "Population density (log)",
    y = "Reporting violence"
  )
)

(
  (p1 + p2)
  # / plot_spacer()
  / (p3 + p4)
  # + plot_layout(
  #   heights = c(0.49, 0.02, 0.49)
  # )
)

ggsave(
  path = fig_dir,
  filename = "cov_vs_viol_lso.png",
)
```

### Combined

#### Selected UTCI vs Violence

```{r}
#| fig-width: 6
#| fig-height: 5

p1 <- (
  ggplot(
    data = df_utci_viol_adm1,
    mapping = aes(
      x = value_utci_days_above_32_daily_max_sum_12m, 
      y = sv_any_12m_mean,
      color = country
    )
  )
  + geom_point(size = 3)
   + scale_y_continuous(
    labels = scales::percent,
  )
  + scale_color_manual(
    values = c("Lesotho" = "#dc7726", "Zimbabwe" = "#ecc046", "Mozambique" = "#0292b7")
  )
  + theme(
    panel.background = element_blank(),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 1),
    panel.grid = element_blank(),
    panel.spacing.x = unit(25, "pt"),
    strip.background = element_blank(),
    strip.text = element_text(size = 14),
    plot.background = element_blank(),
    plot.title = element_text(size = 16),
    axis.ticks = element_line(linewidth = 1),
    axis.ticks.length = unit(4, "pt"),
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 15),
    legend.title = element_blank(),
    legend.text = element_text(size = 15),
    legend.background = element_blank(),
    legend.position = "inside",
    legend.position.inside = c(0.16, 0.75),
  )
  + labs(
    x = "# days UTCI max > 32",
    y = "Reporting violence",
  )
)

p2 <- (
  ggplot(
    data = df_utci_viol_adm1,
    mapping = aes(
      x = dev_value_utci_days_above_32_daily_max_sum_12m, 
      y = sv_any_12m_mean,
      color = country
    )
  )
  + geom_point(size = 3)
   + scale_y_continuous(
    labels = scales::percent,
  )
  + scale_color_manual(
    values = c("Lesotho" = "#dc7726", "Zimbabwe" = "#ecc046", "Mozambique" = "#0292b7")
  )
  + theme(
    panel.background = element_blank(),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 1),
    panel.grid = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(size = 14),
    plot.background = element_blank(),
    plot.title = element_text(size = 16),
    axis.ticks = element_line(linewidth = 1),
    axis.ticks.length = unit(4, "pt"),
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 15),
  )
  + labs(
    x = "Dev. days UTCI max > 32",
    y = "Reporting violence"
  )
  + guides(
    color = "none"
  )
)

(
  (
    p1 
    # / plot_spacer() 
    / p2
  )
  # + plot_layout(
  #   heights = c(0.48, 0.04, 0.48)
  # )
)

ggsave(
  path = fig_dir,
  filename = "utci_max_above_32_value_vs_dev_comb.png",
)
```

## By cluster

```{r}
(
  ggplot(
    df_utci_viol_clus,
    aes(x = n)
  )
  + geom_histogram()
)
```

#### Selected UTCI vs Violence

```{r}
bin_centers_from_levels <- function(levels_chr) {
  # strip brackets, split at comma
  parts <- strsplit(str_remove_all(levels_chr, "[\\[\\]\\(\\)]"), ",", fixed = FALSE)
  lo <- as.numeric(trimws(vapply(parts, `[`, "", 1)))
  hi <- as.numeric(trimws(vapply(parts, `[`, "", 2)))
  centers <- (lo + hi) / 2
  centers
}
values_lvls <- levels(df_utci_viol_clus$value_binned)
values_centers = bin_centers_from_levels(values_lvls)
dev_values_lvls <- levels(df_utci_viol_clus$dev_value_binned)
dev_values_centers = bin_centers_from_levels(dev_values_lvls)

ur_map <- c(
  "0" = "Urban",
  "1" = "Rural"
)
```

```{r}
df_utci_viol_clus_box <- (
  df_utci_viol_clus
  %>% filter(
    country == "Lesotho",
    n > 20
  )
)
```

```{r}
#| fig-width: 8
#| fig-height: 5

p1 <- (
  ggplot(
    data = df_utci_viol_clus_box,
    mapping = aes(
      x = value_binned, 
      y = sv_any_12m_mean,
    )
  )
  + geom_boxplot(fill = "#eebb93")
  + facet_wrap(
    ~ rural,
    ncol = 2,
    labeller = as_labeller(ur_map),
    scales = "free_x"
  )
  + scale_y_continuous(
    labels = scales::percent,
  )
  + scale_x_discrete(
    labels = setNames(
      values_centers,
      values_lvls
    )
  )
  + theme(
    panel.background = element_blank(),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 1),
    panel.grid = element_blank(),
    panel.spacing.x = unit(25, "pt"),
    strip.background = element_blank(),
    strip.text = element_text(size = 14),
    plot.background = element_blank(),
    plot.title = element_text(size = 16),
    axis.ticks = element_line(linewidth = 1),
    axis.ticks.length = unit(4, "pt"),
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 15),
  )
  + labs(
    x = "# days UTCI max > 32",
    y = "Reporting violence"
  )
)

p2 <- (
  ggplot(
    data = df_utci_viol_clus_box,
    mapping = aes(
      x = dev_value_binned, 
      y = sv_any_12m_mean,
    )
  )
  + geom_boxplot(
    fill = "#f6e0a3"
  )
  + facet_wrap(
    ~ rural,
    ncol = 2,
    labeller = as_labeller(ur_map),
    scales = "free_x"
  )
  + scale_y_continuous(
    labels = scales::percent
  )
  + scale_x_discrete(
    labels = setNames(
      dev_values_centers,
      dev_values_lvls
    )
  )
  + theme(
    panel.background = element_blank(),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 1),
    panel.grid = element_blank(),
    # panel.spacing.x = unit(25, "pt"),
    strip.background = element_blank(),
    strip.text = element_text(size = 14),
    plot.background = element_blank(),
    plot.title = element_text(size = 16),
    axis.ticks = element_line(linewidth = 1),
    axis.ticks.length = unit(4, "pt"),
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 15),
  )
  + labs(
    x = "Dev. days UTCI max > 32",
    y = "Reporting violence"
  )
)

(
  (
    p1 
    # / plot_spacer() 
    / p2
  )
  # + plot_layout(
  #   heights = c(0.48, 0.04, 0.48)
  # )
)

ggsave(
  path = fig_dir,
  filename = "cluster_comparison_lso.png",
)
```
