---
title: "Test CAR Impact"
format: html
editor: visual
---

# Environment Setup

```{r setup}
# Packages
library(tidyverse)
library(sf)
library(spdep)
library(brms)
options(brms.backend = "cmdstanr", mc.cores = 4)
library(cmdstanr)
library(posterior)
library(ggdist)
library(bayesplot)
library(tidybayes)
library(patchwork)
library(tidytext)

# Folder Structure
root <- rprojroot::has_file("agile2025.Rproj")$make_fix_file()
temp_dir <- root("temp")
dir.create(temp_dir, showWarnings = FALSE)
raw_data_dir <- root("data/raw")
model_data_dir <- root("data/processed/model_data")
fig_dir <- root("figures")
dir.create(fig_dir, showWarnings = FALSE)
mod_dir <- root("models")
src_dir <- root("src")
```

# Notebook settings

```{r}
# Settings
nb_name <-  "Test CAR effect with simulations"
seed <- 3953168 #7392034 2602313 # #sum(sapply(str_split(nb_name, pattern = "", simplify = TRUE), FUN = utf8ToInt))

# Vis settings
col_palette <- c("#dc7726", "#eebb93", "#ecc046", "#f6e0a3", "#0292b7", "#81c9db", "#35A29F", "#97DECE")

# Simulation settings
N <- 5000

# Computation settings
adapt_delta = 0.95
```

# Functions

```{r}
source(file.path(src_dir, "viz.R"))
source(file.path(src_dir, "model_check_utils.R"))

inv_logit <- function(x) {
  exp(x) / (1 + exp(x))
}
```

# Import spatial data

## Mozambique

```{r}
sf_moz <- (
  st_read(
    file.path(raw_data_dir, "geographies", "Mozambique 2022 DHS - sdr_subnational_boundaries", "shps", "sdr_subnational_boundaries.shp")
  )
  %>% st_make_valid()
  %>% rename_with(tolower)
  %>% select(
    country = cntrynamee,
    adm_name = dhsregen,
    adm_code = regcode
  )
  %>% arrange(adm_code)
)
```

## Zimbabwe

```{r}
sf_zwe <- (
  st_read(
    file.path(raw_data_dir, "geographies", "Zimbabwe 2015 DHS - sdr_subnational_boundaries", "shps", "sdr_subnational_boundaries.shp")
  )
  %>% st_make_valid()
  %>% rename_with(tolower)
  %>% select(
    country = cntrynamee,
    adm_name = dhsregen,
    adm_code = regcode
  )
  %>% arrange(adm_code)
)
```

## Lesotho

```{r}
sf_lso <- (
  st_read(
    file.path(raw_data_dir, "geographies", "Lesotho 2023 DHS - sdr_subnational_boundaries", "shps", "sdr_subnational_boundaries.shp")
  )
  %>% st_make_valid()
  %>% rename_with(tolower)
  %>% select(
    country = cntrynamee,
    adm_name = dhsregen,
    adm_code = regcode
  )
  %>% arrange(adm_code)
)
```

## Namibia

```{r}
sf_nam <- (
  st_read(
    file.path(raw_data_dir, "geographies", "Namibia 2013 DHS - sdr_subnational_boundaries", "shps", "sdr_subnational_boundaries.shp")
  )
  %>% st_make_valid()
  %>% rename_with(tolower)
  %>% select(
    country = cntrynamee,
    adm_name = dhsregen,
    adm_code = regcode
  )
  %>% arrange(adm_code)
)
```

admin\_## Zambia

```{r}
sf_zmb <- (
  st_read(
    file.path(raw_data_dir, "geographies", "Zambia 2018 DHS - sdr_subnational_boundaries", "shps", "sdr_subnational_boundaries.shp")
  )
  %>% st_make_valid()
  %>% rename_with(tolower)
  %>% select(
    country = cntrynamee,
    adm_name = dhsregen,
    adm_code = regcode
  )
  %>% arrange(adm_code)
)
```

## Create combined shapes

```{r}
sf_all <- (
  bind_rows(
    sf_moz,
    sf_zwe,
    # sf_lso,
    # sf_nam,
    sf_zmb,
  )
  %>% st_transform(3857)
  %>% mutate(
    centroid = st_centroid(geometry),
    lon = st_coordinates(centroid)[,1],
    lat = st_coordinates(centroid)[,2]
  )
  %>% filter(adm_name != "Inhambane")
  %>% mutate(
    adm_code = row_number()
  )
  %>% select(
    country,
    adm_name,
    adm_code,
  )
)
sf_all$adm_code <- factor(as.character(sf_all$adm_code), levels = as.character(seq(1, nrow(sf_all))))
```

# Adjacency matrix

```{r}
sf_data <- sf_all
```

```{r}
nb_list <- poly2nb(sf_data)
W <- nb2mat(nb_list, style = "B", zero.policy = TRUE)
rownames(W) <- sf_data$adm_code
colnames(W) <- sf_data$adm_code
```

```{r}
edges <- (
  geostan::edges(W, unique_pairs_only = TRUE, shape = sf_data$geometry)
)
graph <- st_geometry(edges)
```

```{r}
plot(sf_data$geometry, lwd = .15)
plot(graph, add = TRUE, type = "p", col = "red")
plot(graph, add = TRUE, type = "l", col = "black")
```

# Centroid Locations

```{r}
cent <- (
  sf_all
  %>% mutate(
     lon = scale(st_coordinates(st_centroid(geometry))[, 1]),
     lat = scale(st_coordinates(st_centroid(geometry))[, 2]),
  )
  %>% as.data.frame()
  %>% select(lon, lat)
)
```

# Model parts

```{r}
prior_list_ns <- c(
  prior(student_t(3, -2, 0.4), class = "Intercept"),
  prior(normal(0, 0.5), class = "b")
)

form_ns <- bf(sv ~ 1 + clim)

prior_list_adm_only <- c(
  prior(student_t(3, -2, 0.4), class = "Intercept")
)

form_adm_only <- bf(sv ~ 1 + (1 | adm_code))

prior_list_adm <- c(
  prior(student_t(3, -2, 0.4), class = "Intercept"),
  prior(normal(0, 0.5), class = "b")
)

form_adm <- bf(sv ~ 1 + clim + (1 | adm_code))

prior_list_with_u <- c(
  prior(student_t(3, -2, 0.4), class = "Intercept"),
  prior(normal(0, 0.5), class = "b")
)

form_with_u <- bf(sv ~ 1 + clim + u + (1 | adm_code))

prior_list_only_sp <- c(
  prior(normal(-1, 0.5), class = "Intercept")
  # prior(normal(0, 0.5), class = "rhocar"),
  # prior(normal(0, 0.5), class = "car"),
  # prior(exponential(1), class = "sdcar")
)

form_only_sp <- bf(
  sv ~ (
    1 
    + gp(
      x1, 
      x2, 
      # k = 10, 
      cov = "matern32", 
      gr = TRUE
    )
    # + car(
    #   W,
    #   gr = adm_code,
    #   # type = "bym2"
    #   type = "escar"
    # )
  )
)

prior_list_sp <- c(
  prior(normal(-1, 0.5), class = "Intercept"),
  prior(normal(0, 1), class = "b")
  # prior(normal(0, 0.5), class = "rhocar"),
  # prior(normal(0, 0.5), class = "car"),
  # prior(exponential(1), class = "sdcar")
)

form_sp <- bf(
  sv ~ (
    1 
    + clim 
    + gp(
      x1, 
      x2, 
      # k = 10, 
      cov = "matern32", 
      gr = TRUE
    )
    # + car(
    #   W,
    #   gr = adm_code,
    #   # type = "bym2"
    #   type = "escar"
    # )
  )
)
```

# Fixed climate per admin area, no SAR

## Simulation

```{r}
set.seed(seed)
n_loc <- nrow(sf_data)  # locations
clim_adm <- matrix(rnorm(n_loc, 0, 1), nrow = 1)
rownames(clim_adm) <- "clim"
alpha <- -1
b_clim <- 0.2

loc <- vector("integer", length = N)
x1 <- vector("numeric", length = N)
x2 <- vector("numeric", length = N)
clim <- vector("numeric", length = N)
sv <- vector("integer", length = N)
for (i in 1:N) {
  loc[[i]] <- sample(1:n_loc, 1, replace = TRUE)
  x1[[i]] <- cent[["lon"]][loc[[i]]]
  x2[[i]] <- cent[["lon"]][loc[[i]]]
  clim[[i]] <- clim_adm[loc[[i]]]
  sv[[i]] <- rbinom(1, size = 1, p = inv_logit(alpha + b_clim * clim[[i]]))
}

df_sim_1 <- (
  tibble(
    adm_code = factor(as.character(loc), levels = as.character(seq(1, n_loc))),
    x1 = x1,
    x2 = x2,
    clim = clim,
    sv = sv
  )
  %>% arrange(adm_code)
)

sf_clim_1 <- bind_cols(sf_data, t(clim_adm))
```

```{r}
(
  ggplot(data = sf_clim_1)
  + geom_sf(
    aes(fill = clim),
    color = "black",
    linewidth = 0.1
  )
  + scale_fill_viridis_c()
  + theme(
    panel.background = element_blank(),
    panel.grid = element_blank(),
    panel.border = element_blank(),
    plot.background = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    legend.background = element_blank(),
    legend.text = element_text(size = 14),
    legend.title = element_blank(),
    legend.position = "inside",
    legend.position.inside = c(0.8, 0.2)
  )
)

ggsave(
  path = fig_dir,
  filename = "map_no_sp_sim_multi_country.png"
)
```

## Modeling

### No Spatial Autocorrelation

```{r}
fit_ns_1 <- brm(
  formula = form_ns,
  family = bernoulli("logit"),
  prior = prior_list_ns,
  data = df_sim_1,
  data2 = list(W = W),
  seed = seed,
  refresh = 1000,
  # control = list(adapt_delta = adapt_delta),
  # sample_prior = "only"
  sample_prior = TRUE
)
```

```{r}
fit_ns_1
```

### With only admin level random effects

```{r}
fit_adm_only_1 <- brm(
  formula = form_adm_only,
  family = bernoulli("logit"),
  prior = prior_list_adm_only,
  data = df_sim_1,
  data2 = list(W = W),
  seed = seed,
  refresh = 1000,
  # control = list(adapt_delta = adapt_delta),
  # sample_prior = "only"
  sample_prior = TRUE
)
```

```{r}
fit_adm_only_1
```

### With admin level random effects

```{r}
fit_adm_1 <- brm(
  formula = form_adm,
  family = bernoulli("logit"),
  prior = prior_list_adm,
  data = df_sim_1,
  data2 = list(W = W),
  seed = seed,
  refresh = 1000,
  # control = list(adapt_delta = adapt_delta),
  # sample_prior = "only"
  sample_prior = TRUE
)
```

```{r}
fit_adm_1
```

### With Spatial Autocorrelation

```{r}
fit_sp_1 <- brm(
  formula = form_sp,
  family = bernoulli("logit"),
  prior = prior_list_sp,
  data = df_sim_1,
  data2 = list(W = W),
  seed = seed,
  refresh = 1000,
  control = list(
    adapt_delta = 0.99,
    max_treedepth = 15
  ),
  # sample_prior = "only"
  # sample_prior = TRUE
)
```

#### Prior Checks

```{r}
test_data <- (
  expand.grid(
    clim = seq(
      min(df_sim_1$clim),
      max(df_sim_1$clim),
      length.out = 20
    ),
    adm_code = unique(df_sim_1$adm_code),
    x1 = unique(df_sim_1$x1),
    x2 = unique(df_sim_1$x2)
  )
)
```

```{r}
prior_epred_1 <- (
  test_data
  %>% add_epred_draws(
    fit_sp_1,
    ndraws = 20,
    re_formula = NULL
  )
)
```

```{r}
(
  prior_epred_1
  %>% ggplot(
    aes(
      x = .epred,
      height = after_stat("density")
    )
  )
  + geom_density()
)
```

#### Model Checks

```{r}
sp <- rstan::get_sampler_params(fit_sp_1$fit, inc_warmup = FALSE)
ebfmi_per_chain <- sapply(sp, function(chain_mat) {
  ener <- chain_mat[,"energy__"]
  mean(diff(ener)^2) / var(ener)
})
print(ebfmi_per_chain)
```

```{r}
mcmc_trace(
  as_draws_df(fit_sp_1), 
  pars = c(
    "car",
    "sdcar",
    "rcar[1]"
    # "sdgp_gpx1x2",
    # "lscale_gpx1x2",
    # "zgp_gpx1x2[1]"
  )
)
```

```{r}
fit_sp_1
```

### Compare Models

```{r}
clim_draws_ns_1 <- (
  as_draws_df(fit_ns_1)
  %>% select(clim = b_clim)
  %>% mutate(
    model = "No spatial terms"
  )
)

clim_draws_adm_1 <- (
  as_draws_df(fit_adm_1)
  %>% select(clim = b_clim)
  %>% mutate(
    model = "Adm level intercept"
  )
)

clim_draws_sp_1 <- (
  as_draws_df(fit_sp_1)
  %>% select(clim = b_clim)
  %>% mutate(
    model = "With spatial corr."
  )
)

clim_draws_1 <- (
  bind_rows(clim_draws_ns_1, clim_draws_adm_1, clim_draws_sp_1)
  %>% mutate(
    model = factor(model, levels = c("No spatial terms", "Adm level intercept", "With spatial corr.")
    )
  )
)
```

```{r}
#| fig-width: 2.5
#| fig-height: 4.5
(
  ggplot(
    data = clim_draws_1,
    mapping = aes(
      x = clim,
    )
  )
  + stat_dotsinterval(
    quantiles = 100,
    slab_color = col_palette[3],
    slab_fill = col_palette[4],
    .width = c(0.5, 0.95),
  )
  + geom_vline(xintercept = 0, linetype = "dashed", color = "gray50")
  + facet_wrap(
    ~model,
    ncol = 1,
    scales = "free_y",
    # strip.position = "left"
  )
  + theme(
    panel.background = element_blank(),
    panel.grid = element_blank(),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 1),
    plot.background = element_blank(),
    plot.title = element_text(size = 16, hjust = 0.5),
    plot.subtitle = element_text(size = 14, hjust = 0.5),
    axis.title.y = element_blank(),
    axis.title.x = element_text(size = 16),
    axis.text.y = element_blank(),
    axis.text.x = element_text(size = 15),
    axis.ticks.y = element_blank(),
    legend.background = element_blank(),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 13),
    strip.background = element_blank(),
    # strip.placement = "outside",
    strip.text = element_text(size = 15)
  )
  + labs(
    x = "Posterior Value",
    # title = "Sim: No spatial correlation"
  )
  + scale_y_discrete(
    expand = expansion(mult = c(0.2, 0.75))
  )
  + scale_x_continuous(
    limits = c(-0.3, 0.55)
  )
)

ggsave(
  path = fig_dir,
  filename = "clim_post_no_sp_sim_multi_country.png"
)
```

# Flexible climate for admin area, no SAR

## Simulation

```{r}
set.seed(seed)
n_loc <- nrow(sf_data)  # locations
clim_adm <- rnorm(n_loc, 0, 1)
alpha <- -1
b_clim <- 0.2

loc <- vector("integer", length = N)
x1 <- vector("numeric", length = N)
x2 <- vector("numeric", length = N)
clim <- vector("numeric", length = N)
sv <- vector("integer", length = N)

for (i in 1:N) {
  loc[[i]] <- sample(1:n_loc, 1, replace = TRUE)
  x1[[i]] <- cent[["lon"]][loc[[i]]]
  x2[[i]] <- cent[["lon"]][loc[[i]]]
  clim[[i]] <- rnorm(1, clim_adm[loc[[i]]], 0.2)
  sv[[i]] <- rbinom(1, size = 1, p = inv_logit(alpha + b_clim * clim[[i]]))
}

df_sim_2 <- (
  tibble(
    adm_code = factor(as.character(loc), levels = as.character(seq(1, n_loc))),
    x1 = x1,
    x2 = x2,
    clim = clim,
    sv = sv
  )
  %>% arrange(adm_code)
)
```

## Modeling

### No Spatial Autocorrelation

```{r}
fit_ns_2 <- brm(
  formula = form_ns,
  family = bernoulli("logit"),
  prior = prior_list_ns,
  data = df_sim_2,
  data2 = list(W = W),
  seed = seed,
  refresh = 1000,
  # control = list(adapt_delta = adapt_delta),
  # sample_prior = "only"
  sample_prior = TRUE
)
```

```{r}
fit_ns_2
```

### With admin level random effects

```{r}
fit_adm_2 <- brm(
  formula = form_adm,
  family = bernoulli("logit"),
  prior = prior_list_adm,
  data = df_sim_2,
  data2 = list(W = W),
  seed = seed,
  refresh = 1000,
  # control = list(adapt_delta = adapt_delta),
  # sample_prior = "only"
  sample_prior = TRUE
)
```

```{r}
fit_adm_2
```

### With Spatial Autocorrelation

```{r}
fit_sp_2 <- brm(
  formula = form_sp,
  family = bernoulli("logit"),
  prior = prior_list_sp,
  data = df_sim_2,
  data2 = list(W = W),
  seed = seed,
  refresh = 1000,
  # control = list(
  #   adapt_delta = 0.99,
  #   max_treedepth = 15
  # ),
  # sample_prior = "only"
  # sample_prior = TRUE
)
```

#### Prior Checks

```{r}
test_data_2 <- (
  expand.grid(
    clim = seq(
      min(df_sim_2$clim),
      max(df_sim_2$clim),
      length.out = 20
    ),
    adm_code = unique(df_sim_2$adm_code),
    x1 = unique(df_sim_2$x1),
    x2 = unique(df_sim_2$x2)
  )
)
```

```{r}
prior_epred_2 <- (
  test_data_2
  %>% add_epred_draws(
    fit_sp_2,
    ndraws = 20,
    re_formula = NULL
  )
)
```

```{r}
(
  prior_epred_2
  %>% ggplot(
    aes(
      x = .epred,
      height = after_stat("density")
    )
  )
  + geom_density()
)
```

#### Model Checks

```{r}
sp <- rstan::get_sampler_params(fit_sp_2$fit, inc_warmup = FALSE)
ebfmi_per_chain <- sapply(sp, function(chain_mat) {
  ener <- chain_mat[,"energy__"]
  mean(diff(ener)^2) / var(ener)
})
print(ebfmi_per_chain)
```

```{r}
mcmc_trace(
  as_draws_df(fit_sp_2), 
  pars = c(
    "car",
    "sdcar",
    "rcar[1]"
    # "sdgp_gpx1x2",
    # "lscale_gpx1x2",
    # "zgp_gpx1x2[1]"
  )
)
```

```{r}
fit_sp_2
```

# Spatial correlation through common confounder

## Simulation

```{r}
set.seed(seed)

# Parameters
n_loc <- nrow(W)
n_ind <- N %/% n_loc  # number of individual responders per location (we simplify by taking the same number everywhere)
adm_code <- rep(1:n_loc, each = n_ind) # we create a vector of admin areas representing the location of the individual responders 

beta_uc <- 0.2    # effect of the unobserved variable on climate
clim_noise_sd <- 0.1

alpha_sv <- -1    # sexual violence intercept
beta_us <- 0.15      # effect of the unobserved variable on sexual violence

# CAR precision matrix
# D <- diag(rowSums(W))
# rho_true <- 0.95
# sigma2_u <- 0.2
# Q <- D - rho_true * W
# Sigma_u <- sigma2_u * solve(Q)

# GP Covariance matrix
gp_sigma <- 0.5
gp_lambda <- 2
d_mat <- as.matrix(dist(cent))
r <- sqrt(3) * (d_mat / gp_lambda)
Sigma_u <- (gp_sigma ** 2) * (1 + r) * exp(-r)

# Unobserved confounder (there is just one of this that applies to all the individual data)
u_adm <- MASS::mvrnorm(n = 1, mu = rep(0, n_loc), Sigma = Sigma_u)

# Climate variable dependent on confounder (here we also assume that this is the same for all people in the same area)
clim_adm <- matrix(beta_uc * u_adm + rnorm(n_loc, 0, clim_noise_sd), nrow = 1)
rownames(clim_adm) <- "clim"

# Individual level data
x1 <- cent[["lon"]][adm_code]
x2 <- cent[["lat"]][adm_code]
u <- u_adm[adm_code]
clim <- clim_adm[adm_code]

# Sexual violence data
logit_p_sv <- alpha_sv + beta_us * u # Sexual violence only depends on the unobserved variable
sv <- rbinom(length(logit_p_sv), size = 1, prob = inv_logit(logit_p_sv))

df_sim_3 <- (
  tibble(
    adm_code = factor(as.character(adm_code)),
    x1 = x1,
    x2 = x2,
    clim = clim,
    u = u,
    sv = sv
  )
  %>% arrange(adm_code)
)

sf_clim_3 <- bind_cols(sf_data, t(clim_adm))
```

```{r}
(
  ggplot(data = sf_clim_3)
  + geom_sf(
    aes(fill = clim),
    color = "black",
    linewidth = 0.1
  )
  + scale_fill_viridis_c()
  + theme(
    panel.background = element_blank(),
    panel.grid = element_blank(),
    panel.border = element_blank(),
    plot.background = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    legend.background = element_blank(),
    legend.text = element_text(size = 14),
    legend.title = element_blank(),
    legend.position = "inside",
    legend.position.inside = c(0.8, 0.2)
  )
  # + labs(
  #   fill = "Climate Variable"
  # )
)

ggsave(
  path = fig_dir,
  filename = "map_conf_sim_multi_country.png"
)
```

## Modeling

### No Spatial Autocorrelation

```{r}
fit_ns_3 <- brm(
  formula = form_ns,
  family = bernoulli("logit"),
  prior = prior_list_ns,
  data = df_sim_3,
  data2 = list(W = W),
  seed = seed,
  refresh = 1000
)
```

```{r}
fit_ns_3
```

### With admin level random effects

```{r}
fit_adm_3 <- brm(
  formula = form_adm,
  family = bernoulli("logit"),
  prior = prior_list_adm,
  data = df_sim_3,
  data2 = list(W = W),
  seed = seed,
  refresh = 1000
)
```

```{r}
fit_adm_3
```

### With confounder

```{r}
fit_with_u_3 <- brm(
  formula = form_with_u,
  family = bernoulli("logit"),
  prior = prior_list_with_u,
  data = df_sim_3,
  data2 = list(W = W),
  seed = seed,
  refresh = 1000
)
```

```{r}
fit_with_u_3
```

### With only spatial autocorrelation

```{r}
fit_only_sp_3 <- brm(
  formula = form_only_sp,
  family = bernoulli("logit"),
  prior = prior_list_only_sp,
  data = df_sim_3,
  data2 = list(W = W),
  seed = seed,
  refresh = 1000,
  # control = list(adapt_delta = adapt_delta)
)
```

```{r}
fit_only_sp_3
```

### With with Climate and Spatial Autocorrelation

```{r}
fit_sp_3 <- brm(
  formula = form_sp,
  family = bernoulli("logit"),
  prior = prior_list_sp,
  data = df_sim_3,
  data2 = list(W = W),
  seed = seed,
  refresh = 1000,
  # control = list(adapt_delta = adapt_delta)
)
```

#### Prior Checks

```{r}
test_data <- (
  expand.grid(
    clim = seq(
      min(df_sim_3$clim),
      max(df_sim_3$clim),
      length.out = 20
    ),
    adm_code = unique(df_sim_2$adm_code),
    x1 = unique(df_sim_2$x1),
    x2 = unique(df_sim_2$x2)
  )
)
```

```{r}
prior_epred_3 <- (
  test_data
  %>% add_epred_draws(
    fit_sp_3,
    ndraws = 20,
    re_formula = NULL
  )
)
```

```{r}
(
  prior_epred_3
  %>% ggplot(
    aes(
      x = .epred,
      height = after_stat("density")
    )
  )
  + geom_density()
)
```

#### Model Checks

```{r}
sp <- rstan::get_sampler_params(fit_sp_3$fit, inc_warmup = FALSE)
ebfmi_per_chain <- sapply(sp, function(chain_mat) {
  ener <- chain_mat[,"energy__"]
  mean(diff(ener)^2) / var(ener)
})
print(ebfmi_per_chain)
```

```{r}
mcmc_trace(
  as_draws_df(fit_sp_3), 
  pars = c(
    "car",
    "sdcar",
    "rcar[1]"
    # "sdgp_gpx1x2",
    # "lscale_gpx1x2",
    # "zgp_gpx1x2[1]"
  )
)
```

```{r}
fit_sp_3
```

### Compare Models

```{r}
clim_draws_ns_3 <- (
  as_draws_df(fit_ns_3)
  %>% select(clim = b_clim)
  %>% mutate(
    model = "No spatial terms"
  )
)

clim_draws_adm_3 <- (
  as_draws_df(fit_adm_3)
  %>% select(clim = b_clim)
  %>% mutate(
    model = "Adm level intercept"
  )
)

clim_draws_sp_3 <- (
  as_draws_df(fit_sp_3)
  %>% select(clim = b_clim)
  %>% mutate(
    model = "With spatial corr."
  )
)

clim_draws_3 <- (
  bind_rows(clim_draws_ns_3, clim_draws_adm_3, clim_draws_sp_3)
  %>% mutate(
    model = factor(model, levels = c("No spatial terms", "Adm level intercept", "With spatial corr.")
    )
  )
)
```

```{r}
#| fig-width: 2.5
#| fig-height: 4.5
(
  ggplot(
    data = clim_draws_3,
    mapping = aes(
      x = clim,
    )
  )
  + stat_dotsinterval(
    quantiles = 100,
    slab_color = col_palette[3],
    slab_fill = col_palette[4],
    .width = c(0.5, 0.95),
  )
  + geom_vline(xintercept = 0, linetype = "dashed", color = "gray50")
  + facet_wrap(
    ~model,
    ncol = 1,
    scales = "free_y",
    # strip.position = "left"
  )
  + theme(
    panel.background = element_blank(),
    panel.grid = element_blank(),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 1),
    plot.background = element_blank(),
    plot.title = element_text(size = 16, hjust = 0.5),
    plot.subtitle = element_text(size = 14, hjust = 0.5),
    axis.title.y = element_blank(),
    axis.title.x = element_text(size = 16),
    axis.text.y = element_blank(),
    axis.text.x = element_text(size = 15),
    axis.ticks.y = element_blank(),
    legend.background = element_blank(),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 13),
    strip.background = element_blank(),
    # strip.placement = "outside",
    strip.text = element_text(size = 15)
  )
  + labs(
    x = "Posterior Value",
    # title = "Sim: unobserved confounder"
  )
  + scale_y_discrete(
    expand = expansion(mult = c(0.2, 0.75))
  )
  + scale_x_continuous(
    limits = c(-0.3, 0.85)
  )
)

ggsave(
  path = fig_dir,
  filename = "clim_post_conf_sim_multi_country.png"
)
```

# Separate spatially correlated climate and violence

## Simulation

### Select seed

```{r, message = FALSE, warning = FALSE, results = "hide"}

# Parameters

# num_tries <- 50
# test_seeds <- vector(mode = "integer", length = num_tries)
# test_clim <- vector(mode = "integer", length = num_tries)
# 
# for (i in 1:num_tries) {
#   seed <- sample.int(1E7, size = 1)
#   test_seeds[[i]] <- seed
#   set.seed(seed)
# 
#   n_loc <- nrow(W)
#   n_ind <- N %/% n_loc
#   adm_code <- rep(1:n_loc, each = n_ind)
# 
#   # CAR precision matrix
#   # D <- diag(rowSums(W))
#   # rho_true <- 0.85
#   # sigma2 <- 1.0
#   # Q <- D - rho_true * W
#   # Sigma <- sigma2 * solve(Q)
# 
#   # GP Covariance matrix
#   gp_sigma <- 0.5
#   gp_lambda <- 2
#   d_mat <- as.matrix(dist(cent))
#   r <- sqrt(3) * (d_mat / gp_lambda)
#   Sigma <- (gp_sigma ** 2) * (1 + r) * exp(-r)
# 
#   # Climate variable
#   clim_adm <- rmulti_normal(n = 1, mu = rep(0, n_loc), Sigma = Sigma)
#   rownames(clim_adm) <- "clim"
# 
#   # Sexual violence risk factor
#   logit_p_sv_adm <- rmulti_normal(n = 1, mu = rep(0, n_loc), Sigma = Sigma)
# 
#   # Individual level data
#   x1 <- cent[["lon"]][adm_code]
#   x2 <- cent[["lat"]][adm_code]
#   clim <- clim_adm[adm_code]
#   logit_p_sv <- logit_p_sv_adm[adm_code]
# 
#   # Generate sexual violence data
#   sv <- rbinom(length(logit_p_sv), size = 1, prob = inv_logit(logit_p_sv))
# 
#   df_sim <- (
#     tibble(
#       adm_code = factor(as.character(adm_code)),
#       x1 = x1,
#       x2 = x2,
#       clim = clim,
#       sv = sv
#     )
#     %>% arrange(adm_code)
#   )
# 
#   fit_ns <- brm(
#     formula = form_ns,
#     family = bernoulli("logit"),
#     prior = prior_list_ns,
#     data = df_sim,
#     data2 = list(W = W),
#     seed = seed,
#     refresh = 0,
#     silent = TRUE
#   )
# 
#   summ <- summary(fit_ns)
#   test_clim[[i]] <- summ$fixed[2,]$Estimate
# }
  
```

```{r}
hist(test_clim)
```

```{r}
# test_seeds[which.max(test_clim)]
```

```{r}
# test_seeds[which.min(abs(test_clim - 0.2))]
```

```{r}
# Parameters
# 
set.seed(9702874)

num_tries <- 50
test_seeds <- vector(mode = "integer", length = num_tries)
test_clim <- vector(mode = "integer", length = num_tries)

n_loc <- nrow(W)
n_ind <- N %/% n_loc  # number of individual responders per location (we simplify by taking the same number everywhere)
adm_code <- rep(1:n_loc, each = n_ind)

# CAR precision matrix
# D <- diag(rowSums(W))
# rho_true <- 0.85
# sigma2 <- 1.0
# Q <- D - rho_true * W  
# Sigma <- sigma2 * solve(Q)

# GP Covariance matrix
gp_sigma <- 0.5
gp_lambda <- 2
d_mat <- as.matrix(dist(cent))
r <- sqrt(3) * (d_mat / gp_lambda)
Sigma <- (gp_sigma ** 2) * (1 + r) * exp(-r)

# Climate variable
clim_adm <- rmulti_normal(n = 1, mu = rep(0, n_loc), Sigma = Sigma)
rownames(clim_adm) <- "clim"

# Sexual violence risk factor
logit_p_sv_adm <- rmulti_normal(n = 1, mu = rep(0, n_loc), Sigma = Sigma)

# Individual level data
x1 <- cent[["lon"]][adm_code]
x2 <- cent[["lat"]][adm_code]
clim <- clim_adm[adm_code]
logit_p_sv <- logit_p_sv_adm[adm_code]


# Generate sexual violence data
sv <- rbinom(length(logit_p_sv), size = 1, prob = inv_logit(logit_p_sv))

df_sim_4 <- (
  tibble(
    adm_code = factor(as.character(adm_code)),
    x1 = x1,
    x2 = x2,
    clim = clim,
    sv = sv
  )
  %>% arrange(adm_code)
)

sf_clim_4 <- bind_cols(sf_data, t(clim_adm))
```

```{r}
(
  ggplot(data = sf_clim_4)
  + geom_sf(
    aes(fill = clim),
    color = "black",
    linewidth = 0.1
  )
  + scale_fill_viridis_c()
  + theme(
    panel.background = element_blank(),
    panel.grid = element_blank(),
    panel.border = element_blank(),
    plot.background = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    legend.background = element_blank(),
    legend.text = element_text(size = 14),
    legend.title = element_blank(),
    legend.position = "inside",
    legend.position.inside = c(0.8, 0.2)
  )
  # + labs(
  #   fill = "Climate Variable"
  # )
)

ggsave(
  path = fig_dir,
  filename = "map_ind_sp_sim_multi_country.png"
)
```

## Modeling

### No Spatial Autocorrelation

```{r}
fit_ns_4 <- brm(
  formula = form_ns,
  family = bernoulli("logit"),
  prior = prior_list_ns,
  data = df_sim_4,
  data2 = list(W = W),
  seed = seed,
  refresh = 1000
)
```

```{r}
fit_ns_4
```

### With admin level random effects

```{r}
fit_adm_4 <- brm(
  formula = form_adm,
  family = bernoulli("logit"),
  prior = prior_list_adm,
  data = df_sim_4,
  data2 = list(W = W),
  seed = seed,
  refresh = 1000
)
```

```{r}
fit_adm_4
```

### With only spatial autocorrelation

```{r}
fit_only_sp_4 <- brm(
  formula = form_only_sp,
  family = bernoulli("logit"),
  prior = prior_list_only_sp,
  data = df_sim_4,
  data2 = list(W = W),
  seed = seed,
  refresh = 1000,
  # control = list(adapt_delta = adapt_delta)
)
```

```{r}
fit_only_sp_4
```

### With with Climate and Spatial Autocorrelation

```{r}
fit_sp_4 <- brm(
  formula = form_sp,
  family = bernoulli("logit"),
  prior = prior_list_sp,
  data = df_sim_4,
  data2 = list(W = W),
  seed = seed,
  refresh = 1000,
  control = list(adapt_delta = adapt_delta)
)
```

#### Prior Checks

```{r}
test_data <- (
  expand.grid(
    clim = seq(
      min(df_sim_4$clim),
      max(df_sim_4$clim),
      length.out = 20
    ),
    adm_code = unique(df_sim_4$adm_code),
    x1 = unique(df_sim_4$x1),
    x2 = unique(df_sim_4$x2)
  )
)
```

```{r}
prior_epred_4 <- (
  test_data
  %>% add_epred_draws(
    fit_sp_4,
    ndraws = 20,
    re_formula = NULL
  )
)
```

```{r}
(
  prior_epred_4
  %>% ggplot(
    aes(
      x = .epred,
      height = after_stat("density")
    )
  )
  + geom_density()
)
```

#### Model Checks

```{r}
sp <- rstan::get_sampler_params(fit_sp_4$fit, inc_warmup = FALSE)
ebfmi_per_chain <- sapply(sp, function(chain_mat) {
  ener <- chain_mat[,"energy__"]
  mean(diff(ener)^2) / var(ener)
})
print(ebfmi_per_chain)
```

```{r}
mcmc_trace(
  as_draws_df(fit_sp_4), 
  pars = c(
    "car",
    "sdcar",
    "rcar[1]"
    # "sdgp_gpx1x2",
    # "lscale_gpx1x2",
    # "zgp_gpx1x2[1]"
  )
)
```

```{r}
fit_sp_4
```

### Compare Models

```{r}
clim_draws_ns_4 <- (
  as_draws_df(fit_ns_4)
  %>% select(clim = b_clim)
  %>% mutate(
    model = "No spatial terms"
  )
)

clim_draws_adm_4 <- (
  as_draws_df(fit_adm_4)
  %>% select(clim = b_clim)
  %>% mutate(
    model = "Adm level intercept"
  )
)

clim_draws_sp_4 <- (
  as_draws_df(fit_sp_4)
  %>% select(clim = b_clim)
  %>% mutate(
    model = "With spatial corr."
  )
)

clim_draws_4 <- (
  bind_rows(clim_draws_ns_4, clim_draws_adm_4, clim_draws_sp_4)
  %>% mutate(
    model = factor(model, levels = c("No spatial terms", "Adm level intercept", "With spatial corr.")
    )
  )
)
```

```{r}
#| fig-width: 2.5
#| fig-height: 4.5
(
  ggplot(
    data = clim_draws_4,
    mapping = aes(
      x = clim,
    )
  )
  + stat_dotsinterval(
    quantiles = 100,
    slab_color = col_palette[3],
    slab_fill = col_palette[4],
    .width = c(0.5, 0.95),
  )
  + geom_vline(xintercept = 0, linetype = "dashed", color = "gray50")
  + facet_wrap(
    ~model,
    ncol = 1,
    scales = "free_y",
    # strip.position = "left"
  )
  + theme(
    panel.background = element_blank(),
    panel.grid = element_blank(),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 1),
    plot.background = element_blank(),
    plot.title = element_text(size = 16, hjust = 0.5),
    plot.subtitle = element_text(size = 14, hjust = 0.5),
    axis.title.y = element_blank(),
    axis.title.x = element_text(size = 16),
    axis.text.y = element_blank(),
    axis.text.x = element_text(size = 15),
    axis.ticks.y = element_blank(),
    legend.background = element_blank(),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 13),
    strip.background = element_blank(),
    # strip.placement = "outside",
    strip.text = element_text(size = 15)
  )
  + labs(
    x = "Posterior Value",
    # title = "Sim: independent spatial corr."
  )
  + scale_y_discrete(
    expand = expansion(mult = c(0.2, 0.75))
  )
  + scale_x_continuous(
    limits = c(-0.3, 0.55)
  )
)

ggsave(
  path = fig_dir,
  filename = "clim_post_ind_sp_sim_multi_country.png"
)
```

# Spatially correlated climate directly affecting violence

## Simulation

```{r}
# Parameters
# 
set.seed(seed)

n_loc <- nrow(W)
n_ind <- N %/% n_loc  # number of individual responders per location (we simplify by taking the same number everywhere)
adm_code <- rep(1:n_loc, each = n_ind)
alpha_sv <- -1    # sexual violence intercept
beta_cs <- 0.2      # effect of climate on sexual violence

# CAR precision matrix
# D <- diag(rowSums(W))
# rho_true <- 0.95
# sigma2 <- 0.05
# Q <- D - rho_true * W  
# Sigma <- sigma2 * solve(Q)

# GP Covariance matrix
gp_sigma <- 3
gp_lambda <- 0.5
d_mat <- as.matrix(dist(cent))
r <- sqrt(3) * (d_mat / gp_lambda)
Sigma <- (gp_sigma ** 2) * (1 + r) * exp(-r)

# Climate variable
clim_adm <- rmulti_normal(n = 1, mu = rep(0, n_loc), Sigma = Sigma)
rownames(clim_adm) <- "clim"

# Individual level data
x1 <- cent[["lon"]][adm_code]
x2 <- cent[["lat"]][adm_code]
clim <- clim_adm[adm_code]

# Sexual violence data
logit_p_sv <- alpha_sv + beta_cs * clim # Sexual violence depends on climate
sv <- rbinom(length(logit_p_sv), size = 1, prob = inv_logit(logit_p_sv))

df_sim_5 <- (
  tibble(
    adm_code = factor(as.character(adm_code)),
    x1 = x1,
    x2 = x2,
    clim = clim,
    sv = sv
  )
  %>% arrange(adm_code)
)

sf_clim_5 <- bind_cols(sf_data, t(clim_adm))
```

```{r}
(
  ggplot(data = sf_clim_5)
  + geom_sf(
    aes(fill = clim),
    color = "black",
    linewidth = 0.1
  )
  + scale_fill_viridis_c()
  + theme(
    panel.background = element_blank(),
    panel.grid = element_blank(),
    panel.border = element_blank(),
    plot.background = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    legend.background = element_blank(),
    legend.text = element_text(size = 14),
    legend.title = element_blank(),
    legend.position = "inside",
    legend.position.inside = c(0.8, 0.2)
  )
  # + labs(
  #   fill = "Climate Variable"
  # )
)

ggsave(
  path = fig_dir,
  filename = "map_corr_clim_sim_multi_country.png"
)
```

## Modeling

### No Spatial Autocorrelation

```{r}
fit_ns_5 <- brm(
  formula = form_ns,
  family = bernoulli("logit"),
  prior = prior_list_ns,
  data = df_sim_5,
  data2 = list(W = W),
  seed = seed,
  refresh = 1000
)
```

```{r}
fit_ns_5
```

### With admin level random effects

```{r}
fit_adm_5 <- brm(
  formula = form_adm,
  family = bernoulli("logit"),
  prior = prior_list_adm,
  data = df_sim_5,
  data2 = list(W = W),
  seed = seed,
  refresh = 1000
)
```

```{r}
fit_adm_5
```

### With only spatial autocorrelation

```{r}
fit_only_sp_5 <- brm(
  formula = form_only_sp,
  family = bernoulli("logit"),
  prior = prior_list_only_sp,
  data = df_sim_5,
  data2 = list(W = W),
  seed = seed,
  refresh = 1000,
  # control = list(adapt_delta = adapt_delta)
)
```

```{r}
fit_only_sp_5
```

### With with Climate and Spatial Autocorrelation

```{r}
fit_sp_5 <- brm(
  formula = form_sp,
  family = bernoulli("logit"),
  prior = prior_list_sp,
  data = df_sim_5,
  data2 = list(W = W),
  seed = seed,
  refresh = 1000,
  control = list(adapt_delta = adapt_delta)
)
```

#### Prior Checks

```{r}
test_data <- (
  expand.grid(
    clim = seq(
      min(df_sim_5$clim),
      max(df_sim_5$clim),
      length.out = 20
    ),
    adm_code = unique(df_sim_5$adm_code),
    x1 = unique(df_sim_5$x1),
    x2 = unique(df_sim_5$x2)
  )
)
```

```{r}
prior_epred_5 <- (
  test_data
  %>% add_epred_draws(
    fit_sp_5,
    ndraws = 20,
    re_formula = NULL
  )
)
```

```{r}
(
  prior_epred_5
  %>% ggplot(
    aes(
      x = .epred,
      height = after_stat("density")
    )
  )
  + geom_density()
)
```

#### Model Checks

```{r}
sp <- rstan::get_sampler_params(fit_sp_5$fit, inc_warmup = FALSE)
ebfmi_per_chain <- sapply(sp, function(chain_mat) {
  ener <- chain_mat[,"energy__"]
  mean(diff(ener)^2) / var(ener)
})
print(ebfmi_per_chain)
```

```{r}
mcmc_trace(
  as_draws_df(fit_sp_5), 
  pars = c(
    # "car",
    # "sdcar",
    # "rcar[1]"
    "sdgp_gpx1x2",
    "lscale_gpx1x2",
    "zgp_gpx1x2[1]"
  )
)
```

```{r}
fit_sp_5
```

### Compare Models

```{r}
clim_draws_ns_5 <- (
  as_draws_df(fit_ns_5)
  %>% select(clim = b_clim)
  %>% mutate(
    model = "No spatial terms"
  )
)

clim_draws_adm_5 <- (
  as_draws_df(fit_adm_5)
  %>% select(clim = b_clim)
  %>% mutate(
    model = "Adm level intercept"
  )
)

clim_draws_sp_5 <- (
  as_draws_df(fit_sp_5)
  %>% select(clim = b_clim)
  %>% mutate(
    model = "With spatial corr."
  )
)

clim_draws_5 <- (
  bind_rows(clim_draws_ns_5, clim_draws_adm_5, clim_draws_sp_5)
  %>% mutate(
    model = factor(model, levels = c("No spatial terms", "Adm level intercept", "With spatial corr.")
    )
  )
)
```

```{r}
#| fig-width: 2.5
#| fig-height: 4.5
(
  ggplot(
    data = clim_draws_5,
    mapping = aes(
      x = clim,
    )
  )
  + stat_dotsinterval(
    quantiles = 100,
    slab_color = col_palette[3],
    slab_fill = col_palette[4],
    .width = c(0.5, 0.95),
  )
  + geom_vline(xintercept = 0, linetype = "dashed", color = "gray50")
  + facet_wrap(
    ~model,
    ncol = 1,
    scales = "free_y",
    # strip.position = "left"
  )
  + theme(
    panel.background = element_blank(),
    panel.grid = element_blank(),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 1),
    plot.background = element_blank(),
    plot.title = element_text(size = 16, hjust = 0.5),
    plot.subtitle = element_text(size = 14, hjust = 0.5),
    axis.title.y = element_blank(),
    axis.title.x = element_text(size = 16),
    axis.text.y = element_blank(),
    axis.text.x = element_text(size = 15),
    axis.ticks.y = element_blank(),
    legend.background = element_blank(),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 13),
    strip.background = element_blank(),
    # strip.placement = "outside",
    strip.text = element_text(size = 15)
  )
  + labs(
    x = "Posterior Value"
    # title = "Sim: spatial correlated climate"
  )
  + scale_y_discrete(
    expand = expansion(mult = c(0.2, 0.75))
  )
  + scale_x_continuous(
    limits = c(-0.3, 0.55)
  )
)

ggsave(
  path = fig_dir,
  filename = "clim_post_corr_clim_sim_multi_country.png"
)
```

# Spatial correlation AND additional confounder

## Simulation

### Select seed

```{r, message = FALSE, warning = FALSE, results = "hide"}

# Parameters

# num_tries <- 50
# test_seeds <- vector(mode = "integer", length = num_tries)
# test_clim <- vector(mode = "integer", length = num_tries)
# 
# for (i in 1:num_tries) {
#   seed <- sample.int(1E7, size = 1)
#   test_seeds[[i]] <- seed
#   set.seed(seed)
# 
#   n_loc <- nrow(W)
#   n_ind <- N %/% n_loc
#   adm_code <- rep(1:n_loc, each = n_ind)
# 
#   beta_us <- 0.8    # effect of the unobserved variable on sexual violence
#   alpha_sv <- -1    # sexual violence intercept
#   beta_cs <- 0.2      # effect of the climate variable on sexual violence
# 
#   # GP Covariance matrices
#   d_mat <- as.matrix(dist(cent))
#   # gp_sigma_x <- 0.6
#   # gp_sigma_y <- 0.7
#   # gp_sigma_u <- 0.5
#   # 
#   # gp_lambda_x <- 1
#   # gp_lambda_y <- 0.4
#   # 
#   # r_x <- sqrt(3) * (d_mat / gp_lambda_x)
#   # r_y <- sqrt(3) * (d_mat / gp_lambda_y)
#   # 
#   # Sigma_x <- (gp_sigma_x ** 2) * (1 + r_x) * exp(-r_x)
#   # Sigma_y <- (gp_sigma_y ** 2) * (1 + r_y) * exp(-r_y)
#   # Sigma_u <- (gp_sigma_u ** 2) * (1 + r_x) * exp(-r_x) # same structure of Sigma_x
#   # 
#   # # Climate variable
#   # # Unobserved confounder (there is just one of this that applies to all the individual data)
#   # u_adm <- rmulti_normal(n = 1, mu = rep(0, n_loc), Sigma = Sigma_u)
#   # 
#   # # Climate variable not dependent on confounder (here we also assume that this is the same for all people in the same area)
#   # clim_adm <- rmulti_normal(n = 1, mu = rep(0, n_loc), Sigma = (Sigma_x + Sigma_y))
#   # rownames(clim_adm) <- "clim"
#   gp_sigma_c <- 0.6
#   gp_sigma_x <- 0.7
#   gp_sigma_y <- 0.5
#   
#   gp_lambda_x <- 1.5
#   gp_lambda_y <- 0.4
#   
#   r_x <- sqrt(3) * (d_mat / gp_lambda_x)
#   r_y <- sqrt(3) * (d_mat / gp_lambda_y)
#   
#   Sigma_c <- (gp_sigma_c ** 2) * (1 + r_x) * exp(-r_x)
#   Sigma_u <- (
#     (gp_sigma_x ** 2) * (1 + r_x) * exp(-r_x) # same structure of Sigma_x
#     + (gp_sigma_y ** 2) * (1 + r_y) * exp(-r_y)
#   )
#   
#   
#   # Unobserved confounder (there is just one of this that applies to all the individual data)
#   u_adm <- rmulti_normal(n = 1, mu = rep(0, n_loc), Sigma = Sigma_u)
#   
#   # Climate variable not dependent on confounder (here we also assume that this is the same for all people in the same area)
#   clim_adm <- rmulti_normal(n = 1, mu = rep(0, n_loc), Sigma = Sigma_c)
#   rownames(clim_adm) <- "clim"
# 
#   # Individual level data
#   x1 <- cent[["lon"]][adm_code]
#   x2 <- cent[["lat"]][adm_code]
#   u <- u_adm[adm_code]
#   clim <- clim_adm[adm_code]
# 
#   # Sexual violence data
#   logit_p_sv <- alpha_sv + beta_cs * clim + beta_us * u # Sexual violence depends on climate AND the unobserved variable
#   sv <- rbinom(length(logit_p_sv), size = 1, prob = inv_logit(logit_p_sv))
# 
#   df_sim <- (
#     tibble(
#       adm_code = factor(as.character(adm_code)),
#       x1 = x1,
#       x2 = x2,
#       clim = clim,
#       u = u,
#       sv = sv
#     )
#     %>% arrange(adm_code)
#   )
# 
#   fit_ns <- brm(
#     formula = form_ns,
#     family = bernoulli("logit"),
#     prior = prior_list_ns,
#     data = df_sim,
#     data2 = list(W = W),
#     seed = seed,
#     refresh = 0,
#     silent = TRUE
#   )
# 
#   summ <- summary(fit_ns)
#   test_clim[[i]] <- summ$fixed[2,]$Estimate
# }
  
```

```{r}
# hist(test_clim)
```

```{r}
# test_seeds[which.max(test_clim)]
```

```{r}
# test_seeds[which.min(abs(test_clim - 0.05))]
```
# Interesting seeds

```{r}
# seeds that show true value without spatial correlation but decreases with spatial correlation and has higher uncertainty
238906  #6379400

# seeds that show higher than true value without spatial correlation but decreases with spatial correlation ans has higher uncertainty
2648093   #7191423

# seeds that show lower than true value without spatial correlation but increases with spatial correlation and has higher uncertainty
1386701  #5588511
```


```{r}
# set.seed(6379400)
# 
# # Parameters
# n_loc <- nrow(W)
# n_ind <- N %/% n_loc  # number of individual responders per location (we simplify by taking the same number everywhere)
# adm_code <- rep(1:n_loc, each = n_ind) # we vector of admin areas representing the location of the individual responders 
# 
# beta_us <- 0.8    # effect of the unobserved variable on sexual violence
# alpha_sv <- -1    # sexual violence intercept
# beta_cs <- 0.2      # effect of the climate variable on sexual violence
# 
# # CAR precision matrix
# # D <- diag(rowSums(W))
# # rho_true <- 0.95
# # sigma2_u <- 0.2
# # Q <- D - rho_true * W
# # Sigma_u <- sigma2_u * solve(Q)
# 
# # GP Covariance matrices
# # We have two covariance components, one shared by the covariate and confounder
# d_mat <- as.matrix(dist(cent))
# gp_sigma_x <- 0.6
# gp_sigma_y <- 0.7
# gp_sigma_u <- 0.5
# 
# gp_lambda_x <- 1
# gp_lambda_y <- 0.4
# 
# r_x <- sqrt(3) * (d_mat / gp_lambda_x)
# r_y <- sqrt(3) * (d_mat / gp_lambda_y)
# 
# Sigma_x <- (gp_sigma_x ** 2) * (1 + r_x) * exp(-r_x)
# Sigma_y <- (gp_sigma_y ** 2) * (1 + r_y) * exp(-r_y)
# Sigma_u <- (gp_sigma_u ** 2) * (1 + r_x) * exp(-r_x) # same structure of Sigma_x
# 
# 
# # Unobserved confounder (there is just one of this that applies to all the individual data)
# u_adm <- rmulti_normal(n = 1, mu = rep(0, n_loc), Sigma = Sigma_u)
# 
# # Climate variable not dependent on confounder (here we also assume that this is the same for all people in the same area)
# clim_adm <- rmulti_normal(n = 1, mu = rep(0, n_loc), Sigma = (Sigma_x + Sigma_y))
# rownames(clim_adm) <- "clim"
# 
# # Individual level data
# x1 <- cent[["lon"]][adm_code]
# x2 <- cent[["lat"]][adm_code]
# u <- u_adm[adm_code]
# clim <- clim_adm[adm_code]
# 
# # Sexual violence data
# logit_p_sv <- alpha_sv + beta_cs * clim + beta_us * u # Sexual violence depends on climate AND the unobserved variable
# sv <- rbinom(length(logit_p_sv), size = 1, prob = inv_logit(logit_p_sv))
# 
# df_sim_6 <- (
#   tibble(
#     adm_code = factor(as.character(adm_code)),
#     x1 = x1,
#     x2 = x2,
#     clim = clim,
#     u = u,
#     sv = sv
#   )
#   %>% arrange(adm_code)
# )
# 
# sf_clim_6 <- bind_cols(sf_data, t(clim_adm))
# sf_sv_6 <- (
#   sf_data
#   %>% merge(
#     (
#       df_sim_6
#       %>% group_by(adm_code)
#       %>% summarise(
#         sv = mean(sv)
#       )
#       %>% ungroup()
#       %>% select(adm_code, sv)
#     ),
#     by = "adm_code",
#     all.x = TRUE
#   )
# )

set.seed(238906)

# Parameters
n_loc <- nrow(W)
n_ind <- N %/% n_loc  # number of individual responders per location (we simplify by taking the same number everywhere)
adm_code <- rep(1:n_loc, each = n_ind) # we vector of admin areas representing the location of the individual responders 

beta_us <- 0.8    # effect of the unobserved variable on sexual violence
alpha_sv <- -1    # sexual violence intercept
beta_cs <- 0.2      # effect of the climate variable on sexual violence

# CAR precision matrix
# D <- diag(rowSums(W))
# rho_true <- 0.95
# sigma2_u <- 0.2
# Q <- D - rho_true * W
# Sigma_u <- sigma2_u * solve(Q)

# GP Covariance matrices
# We have two covariance components, one shared by the covariate and confounder
d_mat <- as.matrix(dist(cent))
gp_sigma_c <- 0.6
gp_sigma_x <- 0.7
gp_sigma_y <- 0.5

gp_lambda_x <- 1.5
gp_lambda_y <- 0.4

r_x <- sqrt(3) * (d_mat / gp_lambda_x)
r_y <- sqrt(3) * (d_mat / gp_lambda_y)

Sigma_c <- (gp_sigma_c ** 2) * (1 + r_x) * exp(-r_x)
Sigma_u <- (
  (gp_sigma_x ** 2) * (1 + r_x) * exp(-r_x) # same structure of Sigma_x
  + (gp_sigma_y ** 2) * (1 + r_y) * exp(-r_y)
)


# Unobserved confounder (there is just one of this that applies to all the individual data)
u_adm <- rmulti_normal(n = 1, mu = rep(0, n_loc), Sigma = Sigma_u)

# Climate variable not dependent on confounder (here we also assume that this is the same for all people in the same area)
clim_adm <- rmulti_normal(n = 1, mu = rep(0, n_loc), Sigma = Sigma_c)
rownames(clim_adm) <- "clim"

# Individual level data
x1 <- cent[["lon"]][adm_code]
x2 <- cent[["lat"]][adm_code]
u <- u_adm[adm_code]
clim <- clim_adm[adm_code]

# Sexual violence data
logit_p_sv <- alpha_sv + beta_cs * clim + beta_us * u # Sexual violence depends on climate AND the unobserved variable
sv <- rbinom(length(logit_p_sv), size = 1, prob = inv_logit(logit_p_sv))

df_sim_6 <- (
  tibble(
    adm_code = factor(as.character(adm_code)),
    x1 = x1,
    x2 = x2,
    clim = clim,
    u = u,
    sv = sv
  )
  %>% arrange(adm_code)
)

sf_clim_6 <- bind_cols(sf_data, t(clim_adm))
sf_sv_6 <- (
  sf_data
  %>% merge(
    (
      df_sim_6
      %>% group_by(adm_code)
      %>% summarise(
        sv = mean(sv)
      )
      %>% ungroup()
      %>% select(adm_code, sv)
    ),
    by = "adm_code",
    all.x = TRUE
  )
)
```

```{r}
(
  ggplot(data = sf_clim_6)
  + geom_sf(
    aes(fill = clim),
    color = "black",
    linewidth = 0.1
  )
  + scale_fill_viridis_c()
  + theme(
    panel.background = element_blank(),
    panel.grid = element_blank(),
    panel.border = element_blank(),
    plot.background = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    legend.background = element_blank(),
    legend.text = element_text(size = 14),
    legend.title = element_blank(),
    legend.position = "inside",
    legend.position.inside = c(0.8, 0.2)
  )
  # + labs(
  #   fill = "Climate Variable"
  # )
)

ggsave(
  path = fig_dir,
  filename = "map_clim_conf_sim_multi_country.png"
)
```

```{r}
(
  ggplot(data = sf_sv_6)
  + geom_sf(
    aes(fill = sv),
    color = "black",
    linewidth = 0.1
  )
  + scale_fill_viridis_c()
  + theme(
    panel.background = element_blank(),
    panel.grid = element_blank(),
    panel.border = element_blank(),
    plot.background = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    legend.background = element_blank(),
    legend.text = element_text(size = 14),
    legend.title = element_blank(),
    legend.position = "inside",
    legend.position.inside = c(0.8, 0.2)
  )
)

ggsave(
  path = fig_dir,
  filename = "map_sv_conf_sim_multi_country.png"
)
```

## Modeling

### No Spatial Autocorrelation

```{r}
fit_ns_6 <- brm(
  formula = form_ns,
  family = bernoulli("logit"),
  prior = prior_list_ns,
  data = df_sim_6,
  data2 = list(W = W),
  seed = seed,
  refresh = 1000
)
```

```{r}
fit_ns_6
```

### With admin level random effects

```{r}
fit_adm_6 <- brm(
  formula = form_adm,
  family = bernoulli("logit"),
  prior = prior_list_adm,
  data = df_sim_6,
  data2 = list(W = W),
  seed = seed,
  refresh = 1000
)
```

```{r}
fit_adm_6
```

### With confounder

```{r}
fit_with_u_6 <- brm(
  formula = form_with_u,
  family = bernoulli("logit"),
  prior = prior_list_with_u,
  data = df_sim_6,
  data2 = list(W = W),
  seed = seed,
  refresh = 1000
)
```

```{r}
fit_with_u_6
```

### With only spatial autocorrelation

```{r}
fit_only_sp_6 <- brm(
  formula = form_only_sp,
  family = bernoulli("logit"),
  prior = prior_list_only_sp,
  data = df_sim_6,
  data2 = list(W = W),
  seed = seed,
  refresh = 1000,
  # control = list(adapt_delta = adapt_delta)
)
```

```{r}
fit_only_sp_6
```

### With with Climate and Spatial Autocorrelation

```{r}
fit_sp_6 <- brm(
  formula = form_sp,
  family = bernoulli("logit"),
  prior = prior_list_sp,
  data = df_sim_6,
  data2 = list(W = W),
  seed = seed,
  refresh = 1000,
  # control = list(adapt_delta = adapt_delta)
)
```

#### Prior Checks

```{r}
test_data <- (
  expand.grid(
    clim = seq(
      min(df_sim_6$clim),
      max(df_sim_6$clim),
      length.out = 20
    ),
    adm_code = unique(df_sim_6$adm_code),
    x1 = unique(df_sim_6$x1),
    x2 = unique(df_sim_6$x2)
  )
)
```

```{r}
prior_epred_6 <- (
  test_data
  %>% add_epred_draws(
    fit_sp_6,
    ndraws = 20,
    re_formula = NULL
  )
)
```

```{r}
(
  prior_epred_6
  %>% ggplot(
    aes(
      x = .epred,
      height = after_stat("density")
    )
  )
  + geom_density()
)
```

#### Model Checks

```{r}
sp <- rstan::get_sampler_params(fit_sp_6$fit, inc_warmup = FALSE)
ebfmi_per_chain <- sapply(sp, function(chain_mat) {
  ener <- chain_mat[,"energy__"]
  mean(diff(ener)^2) / var(ener)
})
print(ebfmi_per_chain)
```

```{r}
mcmc_trace(
  as_draws_df(fit_sp_6), 
  pars = c(
    # "car",
    # "sdcar",
    # "rcar[1]"
    "sdgp_gpx1x2",
    "lscale_gpx1x2",
    "zgp_gpx1x2[1]"
  )
)
```

```{r}
fit_sp_6
```

### Compare Models

```{r}
clim_draws_ns_6 <- (
  as_draws_df(fit_ns_6)
  %>% select(clim = b_clim)
  %>% mutate(
    model = "No spatial terms"
  )
)

clim_draws_adm_6 <- (
  as_draws_df(fit_adm_6)
  %>% select(clim = b_clim)
  %>% mutate(
    model = "Adm level intercept"
  )
)

clim_draws_sp_6 <- (
  as_draws_df(fit_sp_6)
  %>% select(clim = b_clim)
  %>% mutate(
    model = "With spatial corr."
  )
)

clim_draws_6 <- (
  bind_rows(clim_draws_ns_6, clim_draws_adm_6, clim_draws_sp_6)
  %>% mutate(
    model = factor(model, levels = c("No spatial terms", "Adm level intercept", "With spatial corr.")
    )
  )
)
```

```{r}
#| fig-width: 2.5
#| fig-height: 4.5
(
  ggplot(
    data = clim_draws_6,
    mapping = aes(
      x = clim,
    )
  )
  + stat_dotsinterval(
    quantiles = 100,
    slab_color = col_palette[3],
    slab_fill = col_palette[4],
    .width = c(0.5, 0.95),
  )
  + geom_vline(xintercept = 0, linetype = "dashed", color = "gray50")
  + facet_wrap(
    ~model,
    ncol = 1,
    scales = "free_y",
    # strip.position = "left"
  )
  + theme(
    panel.background = element_blank(),
    panel.grid = element_blank(),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 1),
    plot.background = element_blank(),
    plot.title = element_text(size = 16, hjust = 0.5),
    plot.subtitle = element_text(size = 14, hjust = 0.5),
    axis.title.y = element_blank(),
    axis.title.x = element_text(size = 16),
    axis.text.y = element_blank(),
    axis.text.x = element_text(size = 15),
    axis.ticks.y = element_blank(),
    legend.background = element_blank(),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 13),
    strip.background = element_blank(),
    # strip.placement = "outside",
    strip.text = element_text(size = 15)
  )
  + labs(
    x = "Posterior Value",
    # title = "Sim: unobserved confounder"
  )
  + scale_y_discrete(
    expand = expansion(mult = c(0.2, 0.75))
  )
  + scale_x_continuous(
    limits = c(-0.8, 0.85)
  )
)

ggsave(
  path = fig_dir,
  filename = "clim_post_conf_sim_multi_country.png"
)
```
